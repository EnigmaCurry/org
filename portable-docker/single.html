<!DOCTYPE html>

<html>
    <head>
        <link href="/css/custom.css" rel="stylesheet">
        <script>
         function forcePrintStyles() {
             
             const stylesheets = document.styleSheets;

             for (let i = 0; i < stylesheets.length; i++) {
                 try {
                     const rules = stylesheets[i].cssRules || stylesheets[i].rules;

                     
                     for (let j = 0; j < rules.length; j++) {
                         if (rules[j].media && rules[j].media.mediaText === "print") {
                             
                             rules[j].media.mediaText = "all";
                         }
                     }
                 } catch (e) {
                     
                     console.warn('Could not access stylesheet rules: ', e);
                 }
             }
         }
         document.addEventListener("DOMContentLoaded", function() {
             forcePrintStyles();
         });
        </script>
        <script src="/js/mermaid.min.js"></script>
        <script src="/js/js-yaml.min.js"></script>
        <script src="/js/dom-to-image.min.js"></script>
        <script>
         mermaid.initialize({
             startOnLoad: true,
         });
         window.addEventListener("beforeprint", function() {
             if (typeof mermaid !== 'undefined') {
                 mermaid.init(undefined, document.querySelectorAll('.mermaid'));
             }
         });
        </script>

    </head>
    <body>
        <div class="default_animation">
            <main class="book-content">
                
                
                
                
                
                
                <div class="introduction" style="page-break-after: always;">
                    <h1 id="_index">Portable Docker: Build and Deploy Anywhere with WireGuard Tunneling</h1>
<figure><img src="/img/portable-docker/treasure.webp"/>
</figure>

<p>This book serves as your guide to installing Docker on a small
portable Linux device (e.g., Raspberry Pi) and deploying some web
service containers on it.</p>
<p>You&rsquo;ll also create and configure a public cloud server (e.g.,
a DigitalOcean droplet) whose sole purpose is to host a VPN (WireGuard)
and public gateway (Traefik), enabling the Raspberry Pi to securely
connect from any location.</p>
<p>Through the encrypted tunnel established by this connection, the Pi
can publish services to the Internet even when operating behind a
restrictive firewall, such as public Wi-Fi, mobile hotspots, or
carrier-grade NAT. As long as you can get unblocked <em>outgoing</em>
Internet access, you can self-host a roaming public server from
anywhere!</p>
<span class="btn cstyle interactive primary"><a href="https://github.com/EnigmaCurry/d.rymcg.tech#readme" target="_blank"><i class="fa-fw fas fa-code-branch"></i> <span class="title">
d.rymcg.tech
</span></a></span>
<span class="btn cstyle interactive red"><a href="https://matrix.to/#/#d.rymcg.tech:enigmacurry.com" target="_blank"><i class="fa-fw fas fa-comment-dots"></i> <span class="title">
Chat with us on Matrix
</span></a></span>
<div class="index">
    <h2>Index</h2>
<ul class="children children-li children-sort-">
<li><a href="/portable-docker/acknowledgements/index.html">Acknowledgements</a><ul>
	</ul></li>
<li><a href="/portable-docker/introduction/index.html">Introduction</a><ul>
	</ul></li>
<li><a href="/portable-docker/set-up-dns/index.html">Set up DNS</a><ul>
<li><a href="/portable-docker/set-up-dns/register-domain/index.html">Register a domain name</a><ul>
	</ul></li>
<li><a href="/portable-docker/set-up-dns/create-digitalocean-api-token/index.html">Add the domain to DigitalOcean DNS</a><ul>
	</ul></li>
<li><a href="/portable-docker/set-up-dns/create-digitalocean-api-token-for-acme-challenge/index.html">Generate DigitalOcean API token for ACME challenge</a><ul>
	</ul></li></ul></li>
<li><a href="/portable-docker/set-up-raspberry-pi/index.html">Set up Raspberry Pi</a><ul>
<li><a href="/portable-docker/set-up-raspberry-pi/build-your-pi/index.html">Build your Raspberry Pi</a><ul>
	</ul></li>
<li><a href="/portable-docker/set-up-raspberry-pi/install-raspbian/index.html">Install Raspberry Pi OS</a><ul>
	</ul></li>
<li><a href="/portable-docker/set-up-raspberry-pi/set-up-networking/index.html">Set up networking</a><ul>
	</ul></li>
<li><a href="/portable-docker/set-up-raspberry-pi/set-up-ssh/index.html">Set up SSH</a><ul>
	</ul></li>
<li><a href="/portable-docker/set-up-raspberry-pi/install-docker/index.html">Install Docker</a><ul>
	</ul></li>
<li><a href="/portable-docker/set-up-raspberry-pi/install-d-rymcg-tech/index.html">Install d.rymcg.tech</a><ul>
	</ul></li>
<li><a href="/portable-docker/set-up-raspberry-pi/install-traefik/index.html">Install Traefik</a><ul>
	</ul></li>
<li><a href="/portable-docker/set-up-raspberry-pi/install-whoami/index.html">Install Whoami</a><ul>
	</ul></li></ul></li>
<li><a href="/portable-docker/set-up-cloud-sentry/index.html">Set up sentry Droplet</a><ul>
<li><a href="/portable-docker/set-up-cloud-sentry/launch-digitalocean-droplet/index.html">Launch DigitalOcean droplet</a><ul>
	</ul></li>
<li><a href="/portable-docker/set-up-cloud-sentry/set-up-docker-context/index.html">Configure the sentry context on the Pi</a><ul>
	</ul></li>
<li><a href="/portable-docker/set-up-cloud-sentry/configure-d-rymcg-tech-for-sentry/index.html">Configure d.rymcg.tech for the sentry</a><ul>
	</ul></li></ul></li>
<li><a href="/portable-docker/configure-wireguard-tunnel/index.html">Configure WireGuard VPN</a><ul>
<li><a href="/portable-docker/configure-wireguard-tunnel/configure-sentry-wireguard-server/index.html">Configure sentry wireguard server</a><ul>
	</ul></li>
<li><a href="/portable-docker/configure-wireguard-tunnel/configure-raspberry-pi-wireguard-client/index.html">Configure Raspberry Pi WireGuard client</a><ul>
	</ul></li></ul></li>
<li><a href="/portable-docker/set-up-public-ssh-reverse-tunnel/index.html">Set up public SSH</a><ul>
	</ul></li>
<li><a href="/portable-docker/install-core-services/index.html">Install core services</a><ul>
<li><a href="/portable-docker/install-core-services/forgejo/index.html">Forgejo</a><ul>
	</ul></li>
<li><a href="/portable-docker/install-core-services/traefik-forward-auth/index.html">Traefik-Forward-Auth (sentry authorization)</a><ul>
	</ul></li>
<li><a href="/portable-docker/install-core-services/postfix-relay/index.html">Postfix-Relay (MTA)</a><ul>
	</ul></li>
<li><a href="/portable-docker/install-core-services/step-ca/index.html">Step-CA (mutual TLS)</a><ul>
	</ul></li>
<li><a href="/portable-docker/install-core-services/docker-registry/index.html">Docker Registry</a><ul>
	</ul></li></ul></li>
<li><a href="/portable-docker/install-web-services/index.html">Install apps</a><ul>
<li><a href="/portable-docker/install-web-services/immich/index.html">Immich</a><ul>
	</ul></li>
<li><a href="/portable-docker/install-web-services/sftp/index.html">SFTP (and Thttpd)</a><ul>
	</ul></li>
<li><a href="/portable-docker/install-web-services/minio-s3/index.html">MinIO S3 (and Filestash)</a><ul>
	</ul></li>
<li><a href="/portable-docker/install-web-services/homepage/index.html">Homepage</a><ul>
	</ul></li>
<li><a href="/portable-docker/install-web-services/yourls/index.html">Yourls</a><ul>
	</ul></li>
<li><a href="/portable-docker/install-web-services/nginx-and-php/index.html">Nginx and PHP</a><ul>
	</ul></li>
<li><a href="/portable-docker/install-web-services/jupyterlab/index.html">Jupyterlab</a><ul>
	</ul></li></ul></li>
<li><a href="/portable-docker/maintainence/index.html">Maintainence</a><ul>
<li><a href="/portable-docker/maintainence/backup/index.html">Native Backup</a><ul>
	</ul></li>
<li><a href="/portable-docker/maintainence/upgrade/index.html">Upgrade</a><ul>
	</ul></li>
<li><a href="/portable-docker/maintainence/troubleshooting/index.html">Troubleshooting</a><ul>
	</ul></li></ul></li>
<li><a href="/portable-docker/appendix/index.html">Appendix</a><ul>
<li><a href="/portable-docker/appendix/private-acme/index.html">Private ACME</a><ul>
	</ul></li>
<li><a href="/portable-docker/appendix/mutual-tls-for-web-and-mobile/index.html">Mutual TLS for Web and Mobile</a><ul>
	</ul></li></ul></li>
</ul>
</div>

                </div>
                
                
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000099-acknowledgements">Acknowledgements</h1>
                    <div class="chapter-content">
                        
<p>Thank you to those who helped test everything: Mike, Jessop, and
Duane.</p>
<p>Thank you to Kellie for help editing this book.</p>
<p>Thank you to DALL-E for drawing the illustrations. We forgive any
misspellings and hallucinations.</p>
<figure><img src="/img/portable-docker/high-five.webp"/>
</figure>


                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000100-introduction">Introduction</h1>
                    <div class="chapter-content">
                        

<nav id="TableOfContents">
  <ul>
    <li><a href="#raspberry-pi">Raspberry Pi</a></li>
    <li><a href="#sentry-droplet">Sentry Droplet</a></li>
    <li><a href="#wireguard-vpn">WireGuard VPN</a></li>
    <li><a href="#d-dot-rymcg-dot-tech">d.rymcg.tech</a></li>
    <li><a href="#the-dual-roles-of-the-raspberry-pi">The dual roles of the Raspberry Pi</a></li>
    <li><a href="#your-personal-workstation">Your personal workstation</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#next-steps">Next steps</a></li>
  </ul>
</nav>



<h2 id="raspberry-pi">Raspberry Pi</h2>
<figure><img src="/img/portable-docker/pi5-assembled.webp"/>
</figure>

<p>Here is my Raspberry Pi 5, which is a small form factor Linux
computer, running <a href="https://www.raspberrypi.com/software/" rel="external" target="_blank">Raspberry Pi OS</a> and <a href="https://docs.docker.com/engine/" rel="external" target="_blank">Docker</a>. It has been outfitted
with an NVME SSD attached via the expandable PCI-E bus. It has 8GB of
RAM and 1TB of fast storage.</p>
<p>I use this as a tiny web server that I can take anywhere I go.</p>
<p>It normally sits in one place for a long time. But sometimes it needs
to be picked up and installed in a new place. I need it to be able to
get the network up, have it resume all of its previous functions, and
even use the same IP address as before. Traveling with this device
should be a plug and play experience, with minimal disruption to the
clients that expect this server to be online and available. No matter
what kind of Internet connection it has, it should be quick to get
this server back online.</p>

<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> You can use any Linux computer, not just Raspberry Pi.</div>
  <div class="box-content">

<p>To follow this book, you don&rsquo;t necessarily require a Raspberry Pi. You
can replace it with any Linux computer (AMD64 or ARM64). The
instructions for installing its dependencies assume it to be running a
variant of Debian Linux, but this is not a requirement either, if you
can read between the lines.</p>
</div>
</div>
<h2 id="sentry-droplet">Sentry Droplet</h2>
<p>To accomplish this feat, we need to set up another server (to be named
<code>sentry</code>) that has a static IP address and is accessible from the
public Internet. I use a <a href="https://m.do.co/c/d5da28d3d99d" rel="external" target="_blank">DigitalOcean Droplet</a> (affiliate link helps
support this book), which is a type of Virtual Private Server (VPS)
and exists in the public cloud. The sentry is always on and anyone in
the world can connect to it (via HTTP). However, the sentry does not
serve any applications by itself; it only creates the public <a href="https://doc.traefik.io/traefik/" rel="external" target="_blank">Traefik</a>
proxy (ingress), which forwards incoming connections through a backdoor
VPN connection to the Raspberry Pi. The Pi automatically initiates
this connection to the sentry whenever it boots and comes online.</p>

<pre class="mermaid align-center ">
graph TD;
    Web1[Web browser] --&gt;|Internet| Sentry[Public Sentry]
    Web2[curl] --&gt;|Internet| Sentry
    SFTP[SFTP client] --&gt;|Internet| Sentry
    Sentry &lt;----&gt;|WireGuard VPN| C[Raspberry Pi]
</pre>
<h2 id="wireguard-vpn">WireGuard VPN</h2>
<p>The Raspberry Pi should use whatever kind of Internet connection you
plug the ethernet into (or you may configure Wi-Fi); it will therfore
have only a dynamic IP address initially. Once it&rsquo;s online, it creates
an outbound VPN connection to the sentry via <a href="https://www.wireguard.com/" rel="external" target="_blank">WireGuard</a>. Once connected
to the VPN, the Pi is assigned a static private IP address that only
the sentry can communicate with.</p>
<p>The sentry will forward incoming connections from the Internet to the
Raspberry Pi over the WireGuard VPN connection. Traefik is used on
both the sentry and Raspberry Pi to create the full public route to
each of your services. Traefik supports the following types of routes:</p>
<ul>
<li><strong>HTTP Layer 7</strong> - Routes an incoming HTTP(s) request, which is a
domain name (or TLS SNI), including optional HTTP path, over TCP
port <code>443</code> to a backend HTTP server based on these criteria. This
is the most common routing method used for publishing web apps.</li>
<li><strong>TCP Layer 4 (no TLS inspection)</strong> - Routes a unique TCP ADDRESS:PORT
combination to a unique backend ADDRESS:PORT combination. This is
the second most common method, used for publishing non-HTTP
services (e.g., SSH).</li>
<li><strong>TCP Layer 4/7 (TLS-enabled)</strong> - TODO - unimplemented, but routes a
TLS encrypted TCP layer 4 connection based upon the domain name (by
inspecting the unencrypted TLS SNI header) to a backend
ADDRESS:PORT combination.</li>
<li><strong>UDP Layer 4</strong> - TODO - unimplemented, but similar to non-TLS TCP.</li>
</ul>
<p>Traefik can create a public route for virtually any service on your
Raspberry Pi, whether it&rsquo;s sitting at your desk or at an impromptu
getaway location.</p>
<h2 id="d-dot-rymcg-dot-tech">d.rymcg.tech</h2>
<figure><img src="/img/portable-docker/vpn-string-along.webp"/>
</figure>

<p><a href="https://github.com/EnigmaCurry/d.rymcg.tech" rel="external" target="_blank">d.rymcg.tech</a> is a configuration manager for Docker, as well as a
collection of open source web services and config templates. It
contains an extensive configuration wizard for <a href="https://github.com/EnigmaCurry/d.rymcg.tech/tree/master/traefik#readme" rel="external" target="_blank">Traefik</a> and an
idiomatic <a href="https://github.com/EnigmaCurry/d.rymcg.tech/tree/master#command-line-interaction" rel="external" target="_blank">command line tool</a>, which makes <a href="https://docs.docker.com/compose/" rel="external" target="_blank">Docker Compose</a> projects both
easy to document and use.</p>
<h2 id="the-dual-roles-of-the-raspberry-pi">The dual roles of the Raspberry Pi</h2>
<p>Traditionally, you would install d.rymcg.tech <em>on a separate
workstation</em> and never actually log in to your Docker
server, but rather exclusively control it remotely from your
workstation. This is one of the ways to follow the good DevOps
practice summed up by the metaphor:</p>
<blockquote>
<p>&ldquo;Treat your infrastructure like cattle, not like pets.&rdquo;</p>
</blockquote>
<p>However, the cattle ranching strategy has the drawback that if you
lose access to your workstation, it&rsquo;s diffcult to administer the
remaining server (you would have to recreate your <code>.env</code> files on a
new workstation, from backup, or from scratch).</p>
<p>To avoid this complexity and make it easier to maintain after long
periods of inactivity and forgetfulness, we will make an important
compromise and an exception to the normal DevOps rule:</p>

<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> The Raspberry Pi serves the role of workstation AND server</div>
  <div class="box-content">

<p><strong>In this book</strong>, the configuration tools (d.rymcg.tech) will be
installed <em>to the same server</em> that runs Docker, rather than the usual
recomendation to do so on a separate workstation. Co-mingling the
roles of server and workstation on the Pi means you&rsquo;ll have everything
together in one little box and it will make everything easier to get
(re)acquainted with.</p>
<blockquote>
<p>Treat your portable Pi as a <em>pet</em> Docker server (not cattle). You
must name it and interact with it directly via SSH console.</p>
</blockquote>
<p>If you read any other d.rymcg.tech documentation and it references
&ldquo;your workstation,&rdquo; you should use the <code>pi</code> user on the Raspberry Pi,
not your personal workstation.</p>
<p>If you had a whole fleet of Raspberry Pis to manage, this would be a
terrible idea, because you would be missing the centralized (cattle
ranching) workstation to control all of them, and you&rsquo;d have to log in
to each one individually and configure them directly. However,
you will likely start this journey with only one Pi to manage, so
treating it as a pet is a good initial compromise to make. If you want
to build a proper workstation that can control several servers from
one location, read the <a href="/linux-workstation/index.html">Linux Workstation</a> book and the main
<a href="https://github.com/enigmacurry/d.rymcg.tech?tab=readme-ov-file#readme" rel="external" target="_blank">d.rymcg.tech README</a>.</p>
<p>If you are going to travel frequently with this device, you should
consider <a href="https://gist.github.com/EnigmaCurry/2f9bed46073da8e38057fe78a61e7994" rel="external" target="_blank">installing full disk encryption</a> and requiring remote SSH
unlock on boot, but this is an advanced topic that is outside the
scope of this book.</p>
</div>
</div>
<h2 id="your-personal-workstation">Your personal workstation</h2>
<p>Unless you want to carry a display and keyboard to plug into
the Raspberry Pi, you&rsquo;re still going to need to travel with another
computer (e.g., a laptop) and set that up with an SSH key so
you can remotely log in to the Pi.</p>
<p>You can use any sort of personal computer, as long as it&rsquo;s capable of
running a terminal and an SSH client. If it runs Linux, MacOS, or
Windows, you&rsquo;ll also be able to use this computer to run the
<a href="https://www.raspberrypi.com/software/" rel="external" target="_blank">rpi-imager</a> application for preparing the SD card. Most Linux distros
have this available in their package manager.</p>

<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>If you don&rsquo;t yet have an SSH key on your personal computer, the <a href="/linux-workstation/index.html">Linux
Workstation</a> book has a <a href="/linux-workstation/config/ssh/index.html">chapter about SSH</a>, covering both traditional
SSH keys and agents, as well as the open hardware security token
Solokey.</p>
</div>
</div>
<h4 id="editing-files-on-the-pi">Editing files on the Pi</h4>
<p>Eventually you might need to edit a <code>.env</code> file by hand, and so you
need to know how to edit files remotely over SSH. You have a few
different options:</p>
<ol>
<li>Learn how to use one of the many terminal mode text editors
(e.g., Emacs, Vim, Nano, etc.) and edit the files through an SSH console
directly on the Pi. <strong>This is the most secure option, as the files
never leave the Pi.</strong></li>
<li>Edit the files directly on your personal workstation and set up
your editor so that it saves files transparently over SSH. Example
configurations include Emacs&rsquo; <a href="https://www.gnu.org/software/tramp/" rel="external" target="_blank">TRAMP</a>, VS Code&rsquo;s
<a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-ssh" rel="external" target="_blank">Remote
SSH</a>, or Vim&rsquo;s <a href="https://www.vim.org/scripts/script.php?script_id=1075" rel="external" target="_blank">Netrw</a>. For a universal solution that works with
any editor, use <a href="https://wiki.archlinux.org/title/SSHFS" rel="external" target="_blank">sshfs</a>.</li>
<li>Edit the files directly on your personal workstation and use
synchronization tools like <a href="https://blog.rymcg.tech/blog/linux/rclone_sync/" rel="external" target="_blank">rclone</a>, rsync, dropbox etc, however
this method is the least secure because it leaves several copies
of the files outside of the Pi itself, and important secrets may
be leaked as a result.</li>
</ol>
<h2 id="next-steps">Next steps</h2>
<ul>
<li>Set up DNS.</li>
<li>Set up Raspberry Pi.</li>
<li>Set up sentry Droplet.</li>
<li>Configure WireGuard VPN.</li>
<li>Set up public SSH.</li>
<li>Install core services.</li>
<li>Install apps.</li>
</ul>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000161-register-domain">Register a domain name</h1>
                    <div class="chapter-content">
                        
<p>To host a web service, one of the first things you will need to do is
to register your domain name (e.g., <code>example.com</code>). This will be the
root domain name used for all of your service links and it is part of
what your users will need to type into their web browsers (or click
on) to visit your pages.</p>
<figure><img src="/img/portable-docker/hello-traefik.webp"/>
</figure>


<pre class="mermaid align-center ">
---
title: A web browser must query DNS before it can fetch any web page
---
sequenceDiagram
participant Browser as Web Browser
participant DNS as DNS Server
participant WEB as Web Server

Browser-&gt;&gt;DNS: DNS Request (Resolve domain name)
DNS--&gt;&gt;Browser: DNS Response (IP Address)
Browser-&gt;&gt;WEB: HTTP Request (Fetch Web Page)
WEB--&gt;&gt;Browser: HTTP Response (Web Page Content)
</pre>
<h2 id="domain-name-registration">Domain name registration</h2>
<p>The public domain name registration system is controlled as a scarce
resource that you must pay for the use of.</p>
<p>If domain names were given out for free, all of the good ones would be
taken by now, but due to the imposed registration costs, there are
still some good names left to be had. In return for your fee, you
receive exclusive control of the domain name for the period that you
paid for.</p>
<p>You can never truly own a domain name outright, because you need to
keep paying the registrar to keep the record active, so it is best to
consider a domain name as a rental service. You may pre-pay for
several years in advance or just pay for one year at a time. If you
stop paying and the record expires, the name will no longer resolve to
your services and you may permanently lose control of the name.</p>
<h2 id="register-an-internet-domain-name">Register an Internet domain name</h2>
<p>You can register a domain name from any registrar. For documentation
purposes, we will use <a href="https://www.gandi.net" rel="external" target="_blank">Gandi.net</a>, but these instructions will be
similar regardless of the registrar you pick.</p>

<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Set up Gandi.net</div>
  <div class="box-content">

<ul>
<li>Sign up for an account at <a href="https://www.gandi.net/" rel="external" target="_blank">Gandi.net</a></li>
<li>Once signed in, from your dashboard, click <code>Register</code>.</li>
<li>Search for any domain name you like, e.g., <code>your-name.com</code>.</li>
<li>Add your domain to the shopping cart, go to checkout, and complete
your purchase.</li>
<li>Once you have purchased the domain, it should show up in your
<code>Dashboard</code>, under the <code>Domain</code> tab.</li>
<li>Leave this browser tab open, you will return to it in the next
chapter.</li>
</ul>
</div>
</div>
<h2 id="transfer-dns-to-digitalocean">Transfer DNS to DigitalOcean</h2>

<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Choose any supported DNS provider</div>
  <div class="box-content">

<p>All examples in this book use DigitalOcean as the DNS provider. You
may choose any DNS service that provides a programmatic API supported
by <a href="https://go-acme.github.io/lego/dns/index.html" rel="external" target="_blank">go-acme LEGO</a>.</p>
<p>Sign up for a <a href="https://m.do.co/c/d827a13964d7" rel="external" target="_blank">DigitalOcean account</a> (using this referral link helps
support this site).</p>
</div>
</div>

<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Set up Gandi.net</div>
  <div class="box-content">

<ul>
<li>Login to your <a href="https://admin.gandi.net" rel="external" target="_blank">Gandi.net</a> dashboard.</li>
<li>Click the <code>Domain</code> tab.</li>
<li>Find your domain name in the list and click on it.</li>
<li>Click on the <code>Nameservers</code> tab.</li>
<li>Click on the edit button to create new <code>External nameservers</code>.</li>
<li>Delete all existing nameservers that may exist.</li>
<li>Add the following nameservers, specific to DigitalOcean:
<ul>
<li><code>ns1.digitalocean.com</code></li>
<li><code>ns2.digitalocean.com</code></li>
<li><code>ns3.digitalocean.com</code></li>
</ul>
</li>
</ul>
</div>
</div>
<p>Wait a few minutes for the change to take effect, then you can verify
the setting from your workstation using the <code>whois</code> command:</p>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
whois example.com
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Domain Name: example.com
Registrar WHOIS Server: whois.gandi.net
Name Server: ns1.digitalocean.com
Name Server: ns2.digitalocean.com
Name Server: ns3.digitalocean.com
</pre>
    </div>
</div>

<p>The output shows a report for your domain registration including the
list of the new nameservers.</p>
<p>If you don&rsquo;t have <code>whois</code> installed, you can use <a href="https://www.registry.google/whois-lookup/" rel="external" target="_blank">the web version provided by google</a>.</p>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000162-create-digitalocean-api-token">Add the domain to DigitalOcean DNS</h1>
                    <div class="chapter-content">
                        
<p>The <a href="https://www.rfc-editor.org/rfc/rfc1035" rel="external" target="_blank">Domain Name System</a> is how you associate your (sub-)domains with an
actual IP address on the Internet.</p>
<figure><img src="/img/portable-docker/hello-docker.webp"/>
</figure>


<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Choose any supported DNS provider</div>
  <div class="box-content">

<p>All examples in this book use DigitalOcean as the DNS provider. You
may choose any DNS service that provides a programmatic API supported
by <a href="https://go-acme.github.io/lego/dns/index.html" rel="external" target="_blank">go-acme LEGO</a>.</p>
<p>Sign up for a <a href="https://m.do.co/c/d827a13964d7" rel="external" target="_blank">DigitalOcean account</a> (using this referral link helps
support this site), and follow along to set up your domain&rsquo;s DNS.</p>
</div>
</div>
<h2 id="add-your-domain-name">Add your domain name</h2>
<ul>
<li>Login to the <a href="https://cloud.digitalocean.com/" rel="external" target="_blank">DigitalOcean console</a>.</li>
<li>Click on <code>Networking</code> in the left hand menu.</li>
<li>Select the <code>Domains</code> tab.</li>
<li>Enter your domain name, and click <code>Add Domain</code>.</li>
</ul>
<p><strong>Wait a few minutes</strong> for the setting to take effect, then you can verify
the domain name is added:</p>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
dig -t ns example.com
</pre></code>
    </div>
</div>


<p>(if you don&rsquo;t have <code>dig</code> installed, you can also use <a href="https://toolbox.googleapps.com/apps/dig/" rel="external" target="_blank">the web version
provided by google</a>, enter the domain name, and select <code>NS</code>.)</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
;; ANSWER SECTION:
example.com.             2400    IN      NS      ns1.digitalocean.com.
example.com.             2400    IN      NS      ns3.digitalocean.com.
example.com.             2400    IN      NS      ns2.digitalocean.com.
</pre>
    </div>
</div>

<p>The number in the second column is the TTL (Time To Live) which is the
number of seconds that the record is cached in the queried DNS server.
If you jump the gun and check this too quickly before the changes
takes effect, you may need to wait for this TTL to reset.</p>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000210-build-your-pi">Build your Raspberry Pi</h1>
                    <div class="chapter-content">
                        
<p>These are the parts you will need to source for this build (purchase
price ~$240 USD):</p>

<div class="box notices cstyle default">
  <div class="box-label">Raspberry Pi 5 motherboard</div>
  <div class="box-content">

<figure><img src="/img/portable-docker/pi5.webp"/>
</figure>
</div>
</div>
<p>The Raspberry Pi 5 is often sold in kits, but you can also buy the
motherboard separately. If buying a pre-made kit, make sure it
includes an NVME shield to plug in an NVME SSD. Otherwise, this can be
purchased separately:</p>

<div class="box notices cstyle default">
  <div class="box-label">Geeekpi / 52Pi case, heatsink, NVME shield, and power supply</div>
  <div class="box-content">

<figure><img src="/img/portable-docker/geeekpi5case.webp"/>
</figure>
</div>
</div>
<p>This kit comes with the NVME shield, which is an adapter (hat) to
install on top of the Raspberry Pi 5 motherboard. This allows you to
plug in a full size NVME SSD into the Raspberry Pi&rsquo;s PCI-E bus. The
metal case fits the extended height neccessary to fit the NVME shield
and SSD inside. The kit also includes the required heatsink for the
motherboard, a power supply, and the flat ribbon cable (not shown)
that connects the shield to the motherboard&rsquo;s PCI-E port.</p>

<div class="box notices cstyle default">
  <div class="box-label">Sandisk SD card (32GB)</div>
  <div class="box-content">

<figure><img src="/img/portable-docker/sandisk-32GB-sdcard.webp"/>
</figure>
</div>
</div>
<p>The SD card is used as the root filesystem for Raspberry Pi OS
(formerly named Raspbian). The capacity of the card doesn&rsquo;t need to be
very big, as you won&rsquo;t be storing very much data on this.</p>
<p>Booting from the SD card is a bit slower than NVME, but the advantage
of it is that you can simply swap SD cards, and temporarily use the pi
for a different purpose, all without disrupting access to your NVME
storage.</p>
<p>SD cards are more prone to failure than NVME, especially if you write
too much data to them, so this is minimized as much as possible.
<code>/tmp</code> will be mounted on tmpfs, and <code>/var/log</code> will run on log2ram,
which are both stored in RAM, so the only writes that should happen on
the SD card should be OS updates.</p>

<div class="box notices cstyle default">
  <div class="box-label">SD card adapter</div>
  <div class="box-content">

<figure><img src="/img/portable-docker/sd-card-adapter.webp"/>
</figure>
</div>
</div>
<p>The micro SD card comes with a full size SD card adapter, but you may
also need a USB adapter, in order to write the image.</p>

<div class="box notices cstyle default">
  <div class="box-label">Samsung 990EVO NVME SSD</div>
  <div class="box-content">

<figure><img src="/img/portable-docker/samsung-990EVO-NVME.webp"/>
</figure>
</div>
</div>
<p>The NVME SSD is much faster, and far more reliable, than the SD card.
This device will be used exclusively for the Docker storage system
(mounted at <code>/var/lib/docker</code>). This is where all of your container
images will be built/downloaded, and where the volumes holding your
app data will live.</p>

<div class="box notices cstyle default">
  <div class="box-label">NVME heatsink</div>
  <div class="box-content">

<figure><img src="/img/portable-docker/nvme-heatsink.webp"/>
</figure>
</div>
</div>
<p>You should purchase separately a heatsink to go on the top of your
NVME drive. There is a little bit of room left in the case to fit a
slim one (the one I installed is 3mm tall). This is not essential, but
it is recommended if you make use of heavy I/O, as it will increase
the life expectancy of the SSD.</p>
<h2 id="putting-everything-together">Putting everything together</h2>
<ul>
<li><strong>Read the directions that come with the Geeekpi / 52Pi case</strong>, the rest of
this list is just a summary.</li>
<li>Install the heatsink to the Pi 5 motherboard.</li>
<li>Attach one end of the ribbon cable to the PCI-E port and lock it
into place. <strong>The blue side of the ribbon cable should be facing
outward.</strong></li>
<li>Attach the other end of the ribbon cable to the NVME shield and
lock it into place.</li>
<li>Install the NVME shield on top of the Pi motherboard, plugging into
the GPIO ports, and using the taller risers to sandwich things
together.</li>
<li>Install the motherboard into the bottom part of the case, using the
smaller risers to support the motherboard from below.</li>
<li>Install the NVME SSD into the NVME shield.</li>
<li>Screw on the top part of the case.</li>
<li>Install the SD card into the slot on the bottom edge.</li>
</ul>

<div class="box notices cstyle default">
  <div class="box-label">Pi 5 heatsink and risers installed</div>
  <div class="box-content">

<figure><img src="/img/portable-docker/pi-heatsink.webp"/>
</figure>
</div>
</div>

<div class="box notices cstyle default">
  <div class="box-label">Ribbon cable and GPIO pins connect NVME shield to Pi motherboard</div>
  <div class="box-content">

<figure><img src="/img/portable-docker/ribbon-cable.webp"/>
</figure>
</div>
</div>

<div class="box notices cstyle default">
  <div class="box-label">NVME SSD installed in the NVME shield and motherboard secured in the bottom part of case</div>
  <div class="box-content">

<figure><img src="/img/portable-docker/pi5-nvme.webp"/>
</figure>
</div>
</div>

<div class="box notices cstyle default">
  <div class="box-label">top part of the case screwed on top and SD card installed</div>
  <div class="box-content">

<figure><img src="/img/portable-docker/pi5-sdcard.webp"/>
</figure>
</div>
</div>

<div class="box notices cstyle default">
  <div class="box-label">The fully assembled Raspberry Pi 5 (NVME heatsink not shown)</div>
  <div class="box-content">

<figure><img src="/img/portable-docker/pi5-assembled.webp"/>
</figure>
</div>
</div>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000220-install-raspbian">Install Raspberry Pi OS</h1>
                    <div class="chapter-content">
                        
<figure><img src="/img/portable-docker/penguin.webp"/>
</figure>

<p>The best way to install Raspberry Pi OS onto an SD card, is to use
<a href="https://www.raspberrypi.com/documentation/computers/getting-started.html#installing-the-operating-system" rel="external" target="_blank">rpi-imager</a> from another computer. This allows you to set up the user
account, network settings, and SSH credentials all from the imager
software.</p>
<h2 id="rpi-imager">rpi-imager</h2>
<ul>
<li>
<p>On your personal workstation,
<a href="https://www.raspberrypi.com/software/" rel="external" target="_blank">Download the Raspberry PI
Imager</a> or install <code>rpi-imager</code> from your package manager.</p>
</li>
<li>
<p>Run <code>rpi-imager</code>.</p>
</li>
<li>
<p>Click on the menu labled <code>Rasperry Pi Device</code>.</p>
<ul>
<li>Choose your model of Raspberry Pi.</li>
</ul>
</li>
<li>
<p>Click on the menu labeled <code>Operating System</code></p>
<ul>
<li>Choose <code>Raspberry PI OS (other)</code></li>
<li>Choose <code>Raspberry PI OS Lite (64-bit)</code>.</li>
</ul>
</li>
<li>
<p>Click on the menu labeled <code>Storage</code>.</p>
<ul>
<li>Choose the Storage device to install to.</li>
<li>You may need to change the ownership of the device (e.g., I had to
do <code>sudo chown ryan /dev/sdb</code> first).</li>
</ul>
</li>
<li>
<p>Click <code>Next</code>.</p>
</li>
<li>
<p>Click <code>Edit Settings</code>.</p>
<ul>
<li>
<p>On the <code>General</code> tab:</p>
<ul>
<li>Enter the hostname (e.g., <code>pi</code>).</li>
<li>Enter a username and password (e.g., <code>pi</code>).</li>
<li>Optionally set up the Wi-Fi (I just use ethernet instead).</li>
<li>Set locale settings. (e.g., UTC).</li>
</ul>
</li>
<li>
<p>On the <code>Services</code> tab:</p>
<ul>
<li>Click <code>Enable SSH</code></li>
<li>Choose <code>Allow public-key authentication only</code></li>
<li>If you don&rsquo;t have an SSH key yet, read the <a href="/linux-workstation/config/ssh/index.html">SSH chapter of the Linux Workstation book</a>.</li>
<li>Paste the list of your SSH public keys into the box. (Find them
on your workstation by running <code>ssh-add -L</code> or look in
<code>~/.ssh/id_ed25519.pub</code>)</li>
<li>The SSH key is important to protect, as this is the only way to
remotely SSH into the Raspberry Pi</li>
</ul>
</li>
<li>
<p>On the <code>Options</code> tab:</p>
<ul>
<li>Unselect <code>Enable telemetry</code> unless you&rsquo;re into that sort of
thing.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Click <code>Yes</code> to the question <code>Would you like to apply OS custom settings</code>.</p>
</li>
<li>
<p>Confirm you would like to write to the SD card and wait for it to complete.</p>
</li>
<li>
<p>Once complete, unplug the SD card, put it into the raspberry pi,
plug in the ethernet, and power it on.</p>
</li>
</ul>
<h2 id="find-the-local-ip-address-of-the-pi-on-your-lan">Find the local IP address of the Pi on your LAN</h2>
<p>Once the Pi is powered on, and is connected to your LAN, you need to
figure out what its IP address is. There are a number of ways to do
that:</p>
<ul>
<li>If your network has configured multicast DNS (mDNS, Avahi,
Bonjour), you can find the IP address by the hostname (e.g., <code>pi</code>
set in rpi-imager), appended with the domain <code>.local</code>:</li>
</ul>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
ping -c3 pi.local
</pre></code>
    </div>
</div>


<ul>
<li>From any Linux computer attached to the same LAN, run <code>arp -a</code> to
find and list local connections. Try doing this before and after
you turn on the Pi, and then spot the difference.</li>
</ul>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
arp -a
</pre></code>
    </div>
</div>


<ul>
<li>
<p>If you have a central LAN router + DHCP server, check the console
of the router (or DHCP log) for the newly added device.</p>
</li>
<li>
<p>Plug a monitor into the (micro) HDMI port of the Raspberry Pi, and
the IP address will be printed to the console when it boots.</p>
</li>
</ul>
<h2 id="create-ssh-config-on-your-personal-workstation">Create SSH config on your personal workstation</h2>
<p>To connect your personal workstation to your Raspberry Pi,
you will need to create an SSH config on your workstation, containing
the temporary local IP address of the Raspberry Pi. This config is
somewhat temporary, and once DNS is set up later on, it can be
replaced with a permanent hostname config.</p>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
cat &lt;&lt;EOF &gt&gt ~/.ssh/config
Host pi
    User pi
    Hostname X.X.X.X
    ControlMaster auto
    ControlPersist yes
    ControlPath /tmp/ssh-%u-%r@%h:%p
EOF
</pre></code>
    </div>
</div>


<p>Replace <code>X.X.X.X</code> with the local IP address assigned to the Raspberry
Pi.</p>
<p>Test that the SSH connection works:</p>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
ssh pi
</pre></code>
    </div>
</div>


<p>The first time you connect, it will ask you to confirm the remote host
ssh key, you should simply type <code>yes</code> to trust whatever it says, and
it will trust it automatically from now on.</p>
<p>If the connection is successful, you should now be logged into the
remote shell console of the Raspberry Pi.</p>
<h2 id="set-up-log2ram">Set up Log2Ram</h2>
<p>You can increase the expected lifespan of your SD card by installing
<a href="https://github.com/azlux/log2ram#log2ram" rel="external" target="_blank">log2ram</a></p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
echo "deb [signed-by=/usr/share/keyrings/azlux-archive-keyring.gpg] http://packages.azlux.fr/debian/ bookworm main" | sudo tee /etc/apt/sources.list.d/azlux.list
sudo wget -O /usr/share/keyrings/azlux-archive-keyring.gpg  https://azlux.fr/repo.gpg
sudo apt update
sudo apt install log2ram
</pre></code>
    </div>
</div>


<p>After installing log2ram, reboot the pi:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sudo reboot
</pre></code>
    </div>
</div>


<p>After reboot, you will find <code>/var/log/</code> is mounted as type <code>log2ram</code>:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
ryan@pi5:~ $ df -h
Filesystem      Size  Used Avail Use% Mounted on
...
log2ram         128M   14M  115M  11% /var/log
</pre>
    </div>
</div>

<h2 id="format-and-mount-ssd-storage">Format and mount SSD storage</h2>
<h3 id="identify-the-device-name-of-the-nvme-ssd">Identify the device name of the NVME SSD:</h3>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sudo fdisk -l | grep -A5 nvme
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Disk /dev/nvme0n1: 931.51 GiB, 1000204886016 bytes, 1953525168 sectors
Disk model: Samsung SSD 990 EVO 1TB
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
</pre>
    </div>
</div>

<p>This shows the device is named <code>/dev/nvme0n1</code>.</p>
<h3 id="partition-the-device">Partition the device</h3>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sudo parted /dev/nvme0n1 --script mklabel gpt
sudo parted /dev/nvme0n1 --script mkpart primary ext4 0% 100%
</pre></code>
    </div>
</div>


<h3 id="create-filesystem">Create filesystem</h3>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sudo mkfs.ext4 /dev/nvme0n1p1
</pre></code>
    </div>
</div>


<h3 id="mount-the-filesystem">Mount the filesystem</h3>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sudo mkdir -p /var/lib/docker

echo "/dev/nvme0n1p1  /var/lib/docker  ext4  defaults,nofail  0  3" | sudo tee -a /etc/fstab

sudo systemctl daemon-reload
sudo mount /var/lib/docker
</pre></code>
    </div>
</div>


<h3 id="verify-the-mounted-storage">Verify the mounted storage</h3>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
df -h /var/lib/docker
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Filesystem      Size  Used Avail Use% Mounted on
/dev/nvme0n1p1  916G   28K  870G   1% /var/lib/docker
</pre>
    </div>
</div>

<p>This shows the correct partition <code>/dev/nvme0n1p1</code> mounted at the
correct path <code>/var/lib/docker</code> and showing the correct size of the
NVME SSD (<code>916G</code>; it&rsquo;s always a bit smaller than advertised.)</p>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000230-set-up-networking">Set up networking</h1>
                    <div class="chapter-content">
                        
<figure><img src="/img/portable-docker/networking.webp"/>
</figure>

<h2 id="wi-fi">Wi-Fi</h2>
<p>You may have already configured the Wi-Fi in the rpi-imager options,
but if not, you can do so after its been installed.</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sudo raspi-config
</pre></code>
    </div>
</div>


<ul>
<li>Enter <code>System Options</code>.</li>
<li>Enter <code>S1 Wireless LAN</code>.</li>
<li>Choose your current country.</li>
<li>Enter the SSID (Wi-Fi network name) you wish to connect to.</li>
<li>Enter the network passphrase</li>
</ul>
<h2 id="configure-dns">Configure DNS</h2>
<p>By default, DNS is handled via DHCP, which will probably work in the
majority of cases. However, you may wish to hardcode specific DNS servers instead:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sudo rm -f /etc/resolv.conf
echo -e "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
sudo chattr +i /etc/resolv.conf
</pre></code>
    </div>
</div>


<p><code>chattr +i</code> prevents DHCP from overwriting this file in the future.</p>
<h2 id="links">Links</h2>
<ul>
<li><a href="https://raspberrypi-guide.github.io/networking" rel="external" target="_blank">The Raspberry Pi Guide - For scientists and anyone else</a> - this
shares how to configure many different network scenarios, including
a direct ethernet cable between your workstation and the pi, useful
when you can&rsquo;t find an ethernet LAN with DHCP.</li>
<li><a href="https://www.raspberrypi.com/documentation/computers/configuration.html#wireless-networking-command-line" rel="external" target="_blank">Official Raspberry Pi Networking guide</a></li>
</ul>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000231-set-up-ssh">Set up SSH</h1>
                    <div class="chapter-content">
                        
<p>The Docker context is controlled exclusively through SSH, as the
<code>root</code> user. This requires setting up some keys to allow the <code>pi</code> user
to access the <code>root</code> user&rsquo;s account.</p>
<p>Although you will not need to interact with the <code>root</code> user&rsquo;s shell
directly, the <code>pi</code> user will be granted full access to <code>root</code> via SSH.</p>

<pre class="mermaid align-center ">
graph LR;
    subgraph Raspberry Pi
        pi[User: pi]
        root[User: root]
        pi --&gt;|Docker SSH context\nto root@localhost| root
    end

RemoteComputer[Personal\nWorkstation] --&gt;|ssh pi@pi| pi
</pre>

<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Docker == root == pi</div>
  <div class="box-content">

<p>SSH is used here almost like <code>sudo</code>. The <code>pi</code> user should be treated
with the same respect as the <code>root</code> user, as it will be granted full
<code>root</code> access through SSH (to localhost).</p>
</div>
</div>
<h2 id="create-a-new-ssh-key">Create a new SSH key</h2>
<p>You need to create a new SSH key for the <code>pi</code> user.</p>

<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Unencrypted SSH keys are used for convenience</div>
  <div class="box-content">

<p>To connect to the Docker context requires that your SSH key be already
<em>decrypted</em>.</p>
<p>There&rsquo;s only two ways to do that:</p>
<ul>
<li>Create an <em>unencrypted</em> SSH key, so that no passphrase is ever
required.</li>
</ul>
<p>-or-</p>
<ul>
<li>Set up an ssh-agent to decrypt and load the unencrypted key into
resident memory, so that your key can be used without requiring a
passphrase.</li>
</ul>
<p>For the sake of convenience, this guide will use the first method, and
create a new <em>unencrypted</em> SSH key, living in the pi user&rsquo;s home
directory: <code>/home/pi/.ssh/id_ed25519</code>. The security of this key
depends upon the physical and network security of the device
(including SD card). Any user gaining entry to the <code>pi</code> user&rsquo;s account
will have access to the key, and no passphrase is required to use the
key.</p>
<p>If you wish to enhance the security of your SSH key, please read the
<a href="https://wiki.archlinux.org/title/SSH_keys" rel="external" target="_blank">Arch Wiki article on SSH keys</a>, which covers generating secure SSH
keys, setting a passphrase, and setting up an ssh-agent with <a href="https://wiki.archlinux.org/title/SSH_keys#Keychain" rel="external" target="_blank">Keychain</a>.</p>
<p>You may also protect the integrity of the SD card (at rest) with <a href="https://gist.github.com/EnigmaCurry/2f9bed46073da8e38057fe78a61e7994" rel="external" target="_blank">full
disk encryption and remote unlock via SSH</a>.</p>
</div>
</div>
<p>Create a new SSH key (without a passphrase):</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
ssh-keygen -t ed25519 -N "" -f ~/.ssh/id_ed25519
</pre></code>
    </div>
</div>


<h2 id="authorize-the-key-of-the-pi-user-to-connect-as-root">Authorize the key of the pi user to connect as root</h2>
<p>All interaction with Docker is done over SSH as the <code>root</code> user, so
for the <code>pi</code> user to control Docker, they need to be able to SSH to
<code>localhost</code> as the <code>root</code> user.</p>
<p>Add the <code>pi</code> user&rsquo;s key to the root user&rsquo;s
<code>/root/.ssh/authorized_keys</code> file:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
cat ~/.ssh/id_ed25519.pub | sudo tee -a /root/.ssh/authorized_keys
</pre></code>
    </div>
</div>


<p>Create a config named <code>pi</code> in your <code>~/.ssh/config</code>:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
cat &lt;&lt;EOF &gt&gt ~/.ssh/config
Host pi
    User root
    Hostname localhost
    ControlMaster auto
    ControlPersist yes
    ControlPath /tmp/ssh-%u-%r@%h:%p
EOF
</pre></code>
    </div>
</div>


<p>Test the connection is working:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
ssh pi whoami
</pre></code>
    </div>
</div>


<p>Accept the key fingerprint it offers:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
The authenticity of host 'localhost (::1)' can't be established.
ED25519 key fingerprint is SHA256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
</pre>
    </div>
</div>

<p>If it worked, you should see the output of <code>whoami</code> which should print
the username <code>root</code> (which is the user configured by SSH).</p>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000240-install-docker">Install Docker</h1>
                    <div class="chapter-content">
                        
<h2 id="install-docker">Install Docker</h2>
<ul>
<li>On the pi, install docker:</li>
</ul>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
curl -sSL https://get.docker.com | sh
</pre></code>
    </div>
</div>


<ul>
<li>Test docker is working:</li>
</ul>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sudo docker run hello-world
</pre></code>
    </div>
</div>


<ul>
<li>If working, you should see a <code>Hello from Docker!</code> message and some other help info.</li>
</ul>

<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>Normally, you shouldn&rsquo;t use <code>sudo docker</code>. In the next section you
will create a Docker context for the <code>pi</code> user to use directly.</p>
</div>
</div>
<h2 id="set-up-docker-context--ssh">Set up Docker context (SSH)</h2>
<p><a href="https://github.com/enigmacurry/d.rymcg.tech" rel="external" target="_blank">d.rymcg.tech</a> requires the use of a <a href="https://docs.docker.com/engine/manage-resources/contexts/" rel="external" target="_blank">Docker context</a> via SSH, rather than
the default socket context.</p>
<p>Create a new docker context, named <code>pi</code>, using the SSH config you had
just created (also called <code>pi</code>):</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
docker context create pi --docker "host=ssh://pi"
</pre></code>
    </div>
</div>


<p>Switch to use the new SSH context as the default:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
docker context use pi
</pre></code>
    </div>
</div>


<p>Now, when you run any docker command, it will use the SSH context:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
docker info | grep -iE "(Name|Context)"
</pre></code>
    </div>
</div>


<p>This should print the proper context: <code>pi</code>.</p>
<p>If it worked, the <code>pi</code> user is now fully equipped to run any docker comamnd as <code>root</code>.</p>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000250-install-d-rymcg-tech">Install d.rymcg.tech</h1>
                    <div class="chapter-content">
                        
<h2 id="install-dependencies">Install dependencies</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sudo apt-get update && \
sudo apt-get install -y bash build-essential gettext \
     git openssl apache2-utils xdg-utils jq sshfs \
     wireguard curl inotify-tools w3m && \
( cd $(mktemp -d) && wget -O step-cli.deb \
  https://dl.smallstep.com/cli/docs-cli-install/latest/step-cli_$(dpkg --print-architecture).deb && \
  sudo dpkg -i step-cli.deb && rm -f step-cli.deb )
</pre></code>
    </div>
</div>


<h2 id="clone-the-git-repository">Clone the git repository</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
git clone https://github.com/EnigmaCurry/d.rymcg.tech.git \
    ${HOME}/git/vendor/enigmacurry/d.rymcg.tech

cd ${HOME}/git/vendor/enigmacurry/d.rymcg.tech
</pre></code>
    </div>
</div>


<h2 id="configure-bash-shell-integration">Configure Bash shell integration</h2>
<p>Configure the <code>pi</code> user&rsquo;s <code>~/.bashrc</code> file:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
cat &lt;&lt;'EOF' &gt&gt ~/.bashrc
export EDITOR=nano

## d.rymcg.tech cli tool:
export PATH=${PATH}:${HOME}/git/vendor/enigmacurry/d.rymcg.tech/_scripts/user
eval "$(d.rymcg.tech completion bash)"
__d.rymcg.tech_cli_alias d

## Add d.rymcg.tech alias for each Docker context:
__d.rymcg.tech_context_alias pi
__d.rymcg.tech_context_alias sentry

EOF
</pre></code>
    </div>
</div>



<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>Set <code>EDITOR</code> to your preferred console text editor.</p>
</div>
</div>
<p>Once finished, logout of the Pi and log back in.</p>
<p>Now you should have a new alias named <code>d</code> that controls the
<code>d.rymcg.tech</code> toolset. Check out the main help screen:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
d
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
## Main d.rymcg.tech sub-commands - Optional arguments are printed in brackets [OPTIONAL_ARG]
cd [SUBDIR]                   Enter a sub-shell and go to the ROOT_DIR directory (or given subdirectory)
make [PROJECT] [ARGS ...]     Run a `make` command for the given d.rymcg.tech project name
context                       View or set the current Docker context
new-context                   Create a new Docker context
tmp-context                   Use a temporary Docker context in a sub-shell
config                        Configure the current Docker context
ssh [COMMAND ...]             Run command or shell on active docker context SSH host
completion                    Setup TAB completion in your shell
install                       Install an app interactively
install-docker                Install Docker Engine on the host
status                        Show status of all installed services
audit                         Print security audit of running containers

## Documentation sub-commands:
help                          Show this help screen
list                          List available d.rymcg.tech projects
                              (not including external projects, unless you symlink them into ROOT_DIR)
readme                        Open the main d.rymcg.tech README.md in your browser
readme [PROJECT]              Open the README.md for the given project name
readme digitalocean           Open root documentation file: DIGITALOCEAN.md
readme security               Open root documentation file: SECURITY.md
readme aws                    Open root documentation file: AWS.md
readme license                Open root documentation file: LICENSE.txt
readme raspberry_pi           Open root documentation file: RASPBERRY_PI.md
readme makefile_ops           Open root documentation file: MAKEFILE_OPS.md
</pre>
    </div>
</div>

<p>There are two additional aliases created for each of the Docker contexts:</p>
<ul>
<li><code>pi</code></li>
<li><code>sentry</code></li>
</ul>
<p>These aliases can be used to directly interact with that particular
context without requiring the use of setting the context first (e.g.,
<code>d context use</code> is unnecessary). These aliases will be used throughout
this book.</p>
<p>You can see how they each of the aliases are constructed:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
alias d
alias pi
alias sentry
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
alias d='D_RYMCG_TECH_CLI_ALIAS=d d.rymcg.tech '
alias pi='D_RYMCG_TECH_CONTEXT_ALIAS=pi d.rymcg.tech tmp-context pi d.rymcg.tech'
alias sentry='D_RYMCG_TECH_CONTEXT_ALIAS=sentry d.rymcg.tech tmp-context sentry d.rymcg.tech'
</pre>
    </div>
</div>

<p>Full tab completion is supported for all of the aliases.</p>
<h2 id="run-the-main-config">Run the main config</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi config
</pre></code>
    </div>
</div>


<h2 id="follow-the-interactive-prompts-to-finish-configuration">Follow the interactive prompts to finish configuration</h2>
<h3 id="install-script-wizard">Install script-wizard</h3>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
This utility can automatically install a required helper tool called script-wizard.
See https://github.com/enigmacurry/script-wizard

Do you wish to automatically install script-wizard into `_scripts/script-wizard`? (Y/n): y
</pre>
    </div>
</div>

<p><a href="https://github.com/EnigmaCurry/script-wizard" rel="external" target="_blank">script-wizard</a> is required dependency that can be downloaded and
installed automatically. <code>script-wizard</code> makes interactive input and
selection wizards in Bash a lot nicer.</p>
<h3 id="acknowledge-the-detected-docker-context">Acknowledge the detected Docker context</h3>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? This will make a configuration for the current docker context (pi). Proceed? (Y/n)  y
</pre>
    </div>
</div>

<h3 id="choose-the-root-domain-name-for-this-server">Choose the root domain name for this server</h3>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
ROOT_DOMAIN: Enter the root domain for this context (e.g., d.example.com)

: pi.example.com
</pre>
    </div>
</div>

<p>Instead of <code>pi.example.com</code> you should type the actual domain name (or
subdomain name) that you want to use as the root domain for all of
your services on this server.</p>
<p>For example, if you entered <code>example.com</code>, you will later install apps
(e.g., <code>whoami</code>) with subdomains like <code>whoami.example.com</code>. Choosing a
deeper subdomain has the benefit of being able to share a single root
domain name amongst several Docker instances, therefore with the
example of <code>pi.example.com</code> the service would be deployed like
<code>whoami.pi.example.com</code>, and a second Docker instance could use
<code>pi2.example.com</code>, with services like <code>whoami.pi2.example.com</code>.</p>
<h3 id="choose-to-save-generated-passwords-dot-json-files-by-default">Choose to save generated passwords.json files by default</h3>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Every time you configure HTTP Basic Authentication, you are asked if you wish to save the cleartext passwords
into passwords.json (in each project directory). If you were to press Enter without answering the question,
the default answer is No (displayed as y/N). You may change the default response to Yes (displayed as Y/n).
? Do you want to save cleartext passwords in passwords.json by default? (y/N)  y
</pre>
    </div>
</div>

<p>This question is in regards to the integrated HTTP Basic Auth setting,
which allows you to store the plain text credentials in the file named
<code>passwords.json</code> in the various project directories. This is a
convenience feature, but you may not want it. It&rsquo;s not really a
security concern, because the same password is also availalbe in the
.env file for the project anyway, so go ahead and enable it.</p>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000255-create-digitalocean-api-token-for-acme-challenge">Generate DigitalOcean API token for ACME challenge</h1>
                    <div class="chapter-content">
                        
<figure><img src="/img/portable-docker/api.webp"/>
</figure>


<pre class="mermaid align-center ">
---
title: ACME challenge response for requesting a TLS certificate
---
sequenceDiagram
    participant Traefik as Traefik (Docker)
    participant LE as Let&#39;s Encrypt (ACME)
    participant DO as DigitalOcean DNS

Traefik-&gt;&gt;LE: Request / Renew TLS Certificate (ACME)
LE--&gt;&gt;Traefik: Issue DNS-01 Challenge
Traefik-&gt;&gt;DO: Update DNS Records using API token (Add TXT Record)
DO--&gt;&gt;LE: DNS Challenge Resolved (TXT Record Found)
LE--&gt;&gt;Traefik: Issue TLS Certificate
</pre>

<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Choose any supported DNS provider</div>
  <div class="box-content">

<p>All examples in this book use DigitalOcean as the DNS provider. You
may choose any DNS service that provides a programmatic API supported
by <a href="https://go-acme.github.io/lego/dns/index.html" rel="external" target="_blank">go-acme LEGO</a>.</p>
<p>Sign up for a <a href="https://m.do.co/c/d827a13964d7" rel="external" target="_blank">DigitalOcean account</a> (using this referral link helps
support this site), and follow along to create the required API token.</p>
</div>
</div>
<p>DNS is also a part of the TLS certificate request process with <a href="https://letsencrypt.org/getting-started/" rel="external" target="_blank">Let&rsquo;s
Encrypt</a> (via <a href="https://letsencrypt.org/docs/challenge-types/" rel="external" target="_blank">ACME DNS-01 challenge</a>). Traefik interacts with Let&rsquo;s
Encrypt on your behalf, automatically requesting TLS certificates to
be created for your services. To allow this, you will need to procure
a DigitalOcean Personal Access Token, which grants programatic control
of your DigitalOcean account&rsquo;s DNS settings:</p>
<ul>
<li>Login to the <a href="https://cloud.digitalocean.com/" rel="external" target="_blank">DigitalOcean console</a>.</li>
<li>Click on <code>API</code> in the left hand menu, near the bottom of the list.</li>
<li>On the <code>Tokens</code> tab, click <code>Generate New Token</code>.</li>
<li>Enter a descriptive name indicating the owner of the token (e.g., a
subdomain), and its purpose (e.g., ACME): <code>pi.example.com ACME</code>.</li>
<li>Set the expiration period you want to use. Use <code>No expire</code> if you
just want to set it and forget it, otherwise you will need to
update the token periodically.</li>
<li>Select <code>Custom Scopes</code> so you can choose the fine-grained
permissions.</li>
<li>The only permission that needs to be selected is <code>domain</code>.</li>
<li>Click <code>Generate Token</code>.</li>
<li>Copy the generated token to a temporary buffer/notepad. You will
need to reference this token in the next section, when it asks for
the <code>DO_AUTH_TOKEN</code> variable.</li>
</ul>
<p>You will also need to generate an API token for the sentry droplet.</p>
<ul>
<li>Create the second token named <code>sentry.example.com ACME</code> or similar.</li>
<li>Set a <code>Custom scope</code> = <code>domain</code>.</li>
<li>Copy this token to the same temporary buffer/notepad as before,
you&rsquo;ll need it when setting up the sentry droplet.</li>
</ul>

<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>You could reuse the same API token on both Pi and sentry, but its reccomended
to create a unique token for each host.</p>
</div>
</div>
<h2 id="next-steps">Next steps</h2>
<ul>
<li>Set up Rasbperry Pi.</li>
<li>Set up sentry Droplet.</li>
<li>Configure WireGuard VPN.</li>
<li>Set up public SSH.</li>
<li>Install core services</li>
<li>Install apps.</li>
</ul>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000260-install-traefik">Install Traefik</h1>
                    <div class="chapter-content">
                        
<figure><img src="/img/portable-docker/gopher.webp"/>
</figure>

<p><a href="https://doc.traefik.io/traefik/" rel="external" target="_blank">Traefik</a> is an ingress application proxy and router for all of your web
services (HTTP / TCP / UDP). Traefik facilitates automatic TLS
certificate management via <a href="https://letsencrypt.org/getting-started/" rel="external" target="_blank">Let&rsquo;s Encrypt</a>, and handles transport
security for all of your applications. Traefik is configured to
support several authentication and sentry authorization mechanisms,
including: HTTP Basic Auth, OAuth2, mutual TLS, and IP address
filtering.</p>

<pre class="mermaid align-center ">
graph RL;
    Browser[Web Browser] --&gt;|HTTP Request| Traefik[Traefik Proxy]
    Traefik --&gt;|HTTP Response| Browser
    Whoami --&gt;|Response| Traefik
    subgraph Docker
        Traefik[Traefik Proxy] --&gt;|Forwards Request| Whoami[Container: whoami]
    end
</pre>
<h2 id="basic-traefik-config">Basic Traefik config</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make traefik config
</pre></code>
    </div>
</div>


<p>This presents the interactive configuration menu for Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
############################################################
###                          pi                          ###
############################################################

? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)
[ to move, enter to select, type to filter, ESC to cancel]
</pre>
    </div>
</div>

<p>You can use the up and down arrow keys to choose the selection, and
you may type any substring to narrow the list. Select the <code>Config</code> entry and press
the <code>Enter</code> key.</p>
<h3 id="traefik-config">Traefik Config</h3>

<div class="box notices cstyle secondary">
  <div class="box-label">Don&rsquo;t wander off</div>
  <div class="box-content">

<p>The Traefik configuration is extensive. This section will only show
you how to configure Traefik for a basic install. Many of the menu
options will be skipped for the time being. Follow these instructions
exactly, and don&rsquo;t go wandering through the other menus just yet.</p>
</div>
</div>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
During first time setup, you must complete the following tasks:

- Create Traefik user.
- Configure TLS certificates and ACME (optional).
- Install traefik.

Traefik must be re-installed to apply any changes.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

? Traefik Configuration:
> Traefik user
  Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
  Advanced Routing (Layer 7 / Layer 4 / WireGuard)
  Error page template
v Logging level
[ to move, enter to select, type to filter, ESC to cancel]
</pre>
    </div>
</div>

<h4 id="traefik-user">Traefik user</h4>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik Configuration:
> Traefik user
  Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
  Advanced Routing (Layer 7 / Layer 4 / Wireguard)
  Error page template
v Logging level
</pre>
    </div>
</div>

<p>Select the <code>Traefik user</code> option to create the <code>traefik</code> user on the
host.</p>
<h4 id="entrypoints--including-dashboard">Entrypoints (including dashboard)</h4>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik Configuration:
  Traefik user
> Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
  Advanced Routing (Layer 7 / Layer 4 / Wireguard)
  Error page template
v Logging level
</pre>
    </div>
</div>

<p>The following entrypoints are defined by default:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Entrypoint  Listen_address  Listen_port  Protocol  Upstream_proxy
----------  --------------  -----------  --------  --------------
web         0.0.0.0         80           tcp
websecure   0.0.0.0         443          tcp
</pre>
    </div>
</div>

<p>You will need to reconfigure the <code>websecure</code> entrypoint, to enable the
<code>Proxy Protocol</code>:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik entrypoint config
  Show enabled entrypoints
> Configure stock entrypoints
  Configure custom entrypoints

? Select entrypoint to configure:
  dashboard : Traefik dashboard (only accessible from 127.0.0.1:8080 and requires HTTP basic auth)
  web : HTTP (unencrypted; used to redirect requests to use HTTPS)
> websecure : HTTPS (TLS encrypted HTTP)
  web_plain : HTTP (unencrypted; specifically NOT redirected to websecure; must use different port than web)
  mqtt : MQTT (mosquitto) pub-sub service
  ssh : SSH (forgejo) git (ssh) entrypoint
v xmpp_c2s : XMPP (ejabberd) client-to-server entrypoint

> Do you want to enable the websecure entrypoint? Yes
Set TRAEFIK_WEBSECURE_ENTRYPOINT_ENABLED=true
TRAEFIK_WEBSECURE_ENTRYPOINT_HOST: Enter the host ip address to listen on (0.0.0.0 to listen on all interfaces) (e.g., 0.0.0.0)

: 0.0.0.0

TRAEFIK_WEBSECURE_ENTRYPOINT_PORT: Enter the host port to listen on (e.g., 443)

: 443

? Is this entrypoint downstream from another trusted proxy?
  No, clients dial directly to this server. (Turn off Proxy Protocol)
> Yes, clients are proxied through a trusted server. (Turn on Proxy Protocol)

TRAEFIK_WEBSECURE_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS: Enter the comma separated list of trusted upstream proxy servers (CIDR)

: 10.13.16.1/32
</pre>
    </div>
</div>

<p><code>10.13.16.1/32</code> is the correct (default) IP address of the sentry
WireGuard peer.</p>
<p>Press <code>ESC</code> two times to get back to the traefik config menu.</p>
<h4 id="configure-acme">Configure ACME</h4>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik Configuration:
  Traefik user
  Entrypoints (including dashboard)
> TLS certificates and authorities
  Middleware (including sentry auth)
  Advanced Routing (Layer 7 / Layer 4 / Wireguard)
  Error page template
v Logging level

? Traefik TLS config:
  Configure certificate authorities (CA)
> Configure ACME (Let's Encrypt or Step-CA)
  Configure TLS certificates (make certs)

? Which ACME provider do you want to use?
> Let's Encrypt (ACME)
  Step-CA (ACME)
  Disable ACME
  Cancel / Go back

? Which LE environment do you want to use?
> Production (recommended!)
  Staging (untrusted / testing)

Which type of ACME challenge should be used?
  TLS-ALPN-01 (default for public servers, easy, but no wildcard certs)
> DNS-01 (requires API key, but good behind firewalls, and allows wildcard certs)

TRAEFIK_ACME_CA_EMAIL: Enter your email address (not required; blank to skip)

:

TRAEFIK_ACME_DNS_PROVIDER: Enter the LEGO code for your DNS Provider (eg. digitalocean)

: digitalocean

TRAEFIK_ACME_DNS_VARNAME_1: Enter the 1st DNS provider variable name (eg. DO_AUTH_TOKEN)

: DO_AUTH_TOKEN

TRAEFIK_ACME_DNS_VARNAME_2: Enter the 2nd DNS provider variable name (or leave blank)

:

Now to enter the values for the custom DNS API variables:
DO_AUTH_TOKEN: Enter the value for DO_AUTH_TOKEN (e.g., your-actual-digitalocean-token-here)

: dop_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</pre>
    </div>
</div>

<h4 id="request-tls-certificates">Request TLS certificates</h4>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik TLS config:
  Configure certificate authorities (CA)
  Configure ACME (Let's Encrypt or Step-CA)
> Configure TLS certificates (make certs)

? Configure Traefik TLS certificates
  Manage all certificates.
> Create a new certificate.
  Done / Go back
</pre>
    </div>
</div>

<p>Next enter the domain names you want listed on this certificate:</p>
<ul>
<li><code>pi.example.com</code> (this is your main domain name CN record for the server.)</li>
<li><code>*.pi.example.com</code> (this is your various app sub-domains wildcard
SANS record, matching e.g., <code>whoami.pi.example.com</code>)</li>
<li>Any other domains you want listed on the same certificate.</li>
</ul>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Enter the main domain (CN) for this certificate (e.g., `d.rymcg.tech` or `*.d.rymcg.tech`)

: pi.example.com

Now enter additional domains (SANS), one per line:
Enter a secondary domain (enter blank to skip)

: *.pi.example.com

Enter a secondary domain (enter blank to skip)

:
</pre>
    </div>
</div>

<p>It will continue asking you to enter additional SANS domains until you
enter a blank response to signify you are done.</p>
<h4 id="certificate-summary">Certificate summary</h4>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Main domain:
 pi.example.com
Secondary (SANS) domains:
 *.pi.example.com
</pre>
    </div>
</div>

<p>Finally a summary of the certificate request is printed.</p>
<ul>
<li>Press the <code>ESC</code> key three times to go back to the main menu.</li>
</ul>
<h4 id="error-page-template">Error page template</h4>
<p>You can customize the <a href="https://github.com/tarampampam/error-pages#-templates" rel="external" target="_blank">Traefik error page template</a> by selecing a custom
theme:</p>
<figure><img src="/img/portable-docker/404.webp"/>
</figure>

<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
  Advanced Routing (Layer 7 / Layer 4 / WireGuard)
> Error page template
  Logging level
  Access logs

? Select an error page theme (https://github.com/tarampampam/error-pages#-templates)
^ hacker-terminal
  cats
  lost-in-space
  app-down
  connection
> matrix
  orient
</pre>
    </div>
</div>

<p>Since this theme is only used for the 404s and other errors coming
from Traefik directly (and not for any errors coming from the apps
themselves), the choice here is not purely aesthetic: as long as you
choose <em>unique</em> error page template themes for each Traefik server
instance (e.g., <code>pi</code>, <code>sentry</code>), you will gain extra debugging
knowledge of knowing <em>which</em> Traefik instance is returning a
particular error.</p>
<h2 id="install-traefik">Install Traefik</h2>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
############################################################
###                          pi                          ###
############################################################

? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
[ to move, enter to select, type to filter, ESC to cancel]
</pre>
    </div>
</div>

<p>On the main menu, select <code>Install (make install)</code>.</p>
<p>Wait for the Traefik service to be installed, and then you will be
returned to the main menu.</p>
<p>Press the <code>Esc</code> key to quit the Traefik configuration.</p>
<h2 id="verify-traefik-status">Verify Traefik status</h2>
<p>You can check to see that Traefik has started:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make traefik status
</pre></code>
    </div>
</div>


<p>You should see two services running: <code>traefik</code> and
<code>traefik-error-pages</code>, both in state <code>running</code>:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
NAME                   ENV              IMAGE                           STATE
traefik-error-pages-1  .env_pi_default  tarampampam/error-pages:2.25.0  running
traefik-traefik-1      .env_pi_default  traefik-traefik                 running
</pre>
    </div>
</div>


                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000261-install-whoami">Install Whoami</h1>
                    <div class="chapter-content">
                        

<nav id="TableOfContents">
  <ul>
    <li><a href="#what-is-whoami">What is Whoami?</a></li>
    <li><a href="#install">Install</a>
      <ul>
        <li><a href="#set-up-temporary-dns-override">Set up temporary DNS override</a></li>
        <li><a href="#testing-whoami">Testing whoami</a></li>
        <li><a href="#view-the-logs">View the logs</a></li>
      </ul>
    </li>
    <li><a href="#next-steps">Next steps</a></li>
  </ul>
</nav>



<figure><img src="/img/portable-docker/whoami.webp"/>
</figure>

<h2 id="what-is-whoami">What is Whoami?</h2>
<p><a href="https://github.com/EnigmaCurry/d.rymcg.tech/tree/master/whoami#readme" rel="external" target="_blank">Whoami</a> is a web application that simply outputs the request headers
that it receives (reflecting them back to the requesting client):</p>


<div class="box notices cstyle run">
    <div class="box-label none">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this later after you install it:</div>
    <div class="box-content">
        <code><pre>
curl https://whoami.pi.example.com
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Name: default
Hostname: 38704012c4b3
IP: 127.0.0.1
IP: ::1
IP: 172.19.0.2
RemoteAddr: 172.19.0.1:34610
GET / HTTP/1.1
Host: whoami.example.com
User-Agent: curl/7.88.1
Accept: */*
Accept-Encoding: gzip
X-Forwarded-For: 198.51.100.1
X-Forwarded-Host: whoami.example.com
X-Forwarded-Port: 443
X-Forwarded-Proto: https
X-Forwarded-Server: docker
X-Real-Ip: 198.51.100.1
</pre>
    </div>
</div>

<p>This output is useful for end-to-end testing, to verify that the
application is capable of serving requests, and that all of the
configuration is correct. Traefik middlewares may also add additional
headers to incoming requests, and so whoami is a nice way to verify
that those are working too. Finally, the connection test will confirm
whether or not the TLS certificate is installed correctly.</p>
<h2 id="install">Install</h2>
<p>Create a new config:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make whoami config
</pre></code>
    </div>
</div>


<p>The first question the config asks for is <code>WHOAMI_TRAEFIK_HOST</code> which
should be the fully qualified domain name that the whoami app will use
for its URL:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
WHOAMI_TRAEFIK_HOST: Enter the whoami domain name (e.g., whoami.example.com)
: whoami.pi.example.com
</pre>
    </div>
</div>

<p>Optional authentication can be configured:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Do you want to enable sentry authorization in front of this app (effectively making the entire site private)?
> No
  Yes, with HTTP Basic Authentication
  Yes, with Oauth2
  Yes, with Mutual TLS (mTLS)
</pre>
    </div>
</div>

<p>For now, choose <code>No</code>, to disable authentication.</p>
<p>Install whoami:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make whoami install
</pre></code>
    </div>
</div>


<h3 id="set-up-temporary-dns-override">Set up temporary DNS override</h3>
<p>The <code>whoami</code> service is not public yet, it is currently only
accessible from the same local network (LAN). For testing purposes,
you need to set a temporary local DNS override in the Raspberry Pi&rsquo;s
<code>/etc/hosts</code> file:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
echo "127.0.1.1       whoami.pi.example.com" | sudo tee -a /etc/hosts
</pre></code>
    </div>
</div>



<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>Replace <code>whoami.pi.example.com</code> with the same domain name you set for <code>WHOAMI_TRAEFIK_HOST</code>.</p>
</div>
</div>
<h3 id="testing-whoami">Testing whoami</h3>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make whoami open
</pre></code>
    </div>
</div>



<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>The <code>open</code> target uses the <code>xdg-open</code> tool to automatically open your
preferred web browser to the given application&rsquo;s URL. Since you are
connected to the Raspberry Pi&rsquo;s text console over SSH, you are limited
to text-mode browsers. <a href="https://w3m.sourceforge.net/" rel="external" target="_blank">w3m</a> will be used in this instance to display
the page.</p>
</div>
</div>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Name: default
Hostname: c3ce89b0fceb
IP: 127.0.0.1
IP: ::1
IP: 172.19.0.2
RemoteAddr: 172.19.0.1:50156
GET / HTTP/1.1
Host: whoami.pi.example.com
User-Agent: w3m/0.5.3+git20230121
Accept: text/html, text/*;q=0.5, image/*, application/*
Accept-Encoding: gzip, compress, bzip, bzip2, deflate
Accept-Language: en;q=1.0
X-Forwarded-For: 127.0.0.1
X-Forwarded-Host: whoami.pi.example.com
X-Forwarded-Port: 443
X-Forwarded-Proto: https
X-Forwarded-Server: pi5
X-Real-Ip: 127.0.0.1

   Viewing[SSL] <>
</pre>
    </div>
</div>

<p>If you see output like printed above, you have confirmed that Whoami
and Traefik are functioning correctly. The status bar of <code>w3m</code> shows
<code>Viewing[SSL]</code> which confirms that TLS is successfully working.</p>
<p>To quit <code>w3m</code>, press <code>q</code>, then <code>y</code>.</p>
<p>Alternatively, test it with curl:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
curl https://whoami.pi.example.com
</pre></code>
    </div>
</div>


<p>If the TLS certificate has not been issued yet, you will get this
error from curl (and a similar error in <code>w3m</code>):</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
curl: (60) SSL certificate problem: self-signed certificate
More details here: https://curl.se/docs/sslcerts.html

curl failed to verify the legitimacy of the server and therefore could not
establish a secure connection to it. To learn more about this situation and
how to fix it, please visit the web page mentioned above.
</pre>
    </div>
</div>

<p>Simply wait a bit longer for the TLS cert to issue, or check the logs
for errors (<code>d make traefik logs service=traefik</code>). You can also tell
curl to ignore the error (<code>-k</code>):</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
## This is insecure, but fine for testing:
curl -k https://whoami.pi.example.com
</pre></code>
    </div>
</div>


<p>You can further verify the TLS certificate is issued correctly:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi script tls_debug whoami.pi.example.com
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
...
issuer=C = US, O = Let's Encrypt, CN = R10
...
</pre>
    </div>
</div>

<ul>
<li>If the issuer is <code>Let's Encrypt</code>, then the certificate is valid .</li>
<li>If the issuer is <code>TRAEFIK DEFAULT CERT</code>, then there is some kind of
problem , and you will need to inspect the traefik logs (see next
section).</li>
</ul>
<h3 id="view-the-logs">View the logs</h3>
<p>It may be necessary to inspect the applicaiton logs, which you can do
so as follows:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make whoami logs
</pre></code>
    </div>
</div>


<p>To check the Traefik logs, do similar:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make traefik logs service=traefik
</pre></code>
    </div>
</div>


<h2 id="next-steps">Next steps</h2>
<ul>
<li>Set up the sentry Droplet.</li>
<li>Configure WireGuard VPN.</li>
<li>Set up public SSH.</li>
<li>Install core services.</li>
<li>Install apps.</li>
</ul>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000310-launch-digitalocean-droplet">Launch DigitalOcean droplet</h1>
                    <div class="chapter-content">
                        
<h2 id="set-up-your-ssh-key-on-digitalocean">Set up your SSH key on DigitalOcean</h2>

<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> How to do this in the DigitalOcean cloud console</div>
  <div class="box-content">

<ul>
<li>Login to the <a href="https://cloud.digitalocean.com/" rel="external" target="_blank">DigitalOcean cloud console</a>.</li>
<li>Click <code>Settings</code> in the menu.</li>
<li>Click on the <code>Security</code> tab.</li>
<li>Click on the <code>Add SSH Key</code> button.</li>
<li>Paste the public SSH key of the <code>pi</code> user into the box. (copy the
contents of <code>~/.ssh/id_ed25519.pub</code> from the Raspberry Pi.)</li>
<li>Enter a key name e.g., <code>pi@pi.example.com</code>.</li>
<li>Finish adding the key, click <code>Add SSH Key</code>.</li>
</ul>
</div>
</div>
<h2 id="create-a-digitalocean-firewall-template">Create a DigitalOcean firewall template</h2>

<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> How to do this in the DigitalOcean cloud console</div>
  <div class="box-content">

<ul>
<li>Login to the <a href="https://cloud.digitalocean.com/" rel="external" target="_blank">DigitalOcean cloud console</a>.</li>
<li>Click <code>Networking</code> in the menu.</li>
<li>Click the <code>Firewalls</code> tab.</li>
<li>Click <code>Create Firewall</code>.</li>
<li>Enter the name, e.g., <code>sentry.example.com</code>.</li>
<li>Enter the following rules:
<ul>
<li>SSH:
<ul>
<li>Type: <code>SSH</code></li>
<li>Protocol: <code>TCP</code></li>
<li>Port Range: <code>22</code></li>
<li>Sources: All IPv4, All IPv6, or a specific static IP address if
you want to be more secure.</li>
<li>Description: This is so you can access the SSH console of the
public sentry.</li>
</ul>
</li>
<li>HTTP:
<ul>
<li>Type: <code>HTTP</code></li>
<li>Protocol: <code>TCP</code></li>
<li>Port Range: <code>80</code></li>
<li>Sources: All IPv4, All IPv6.</li>
<li>Description: This is used solely to forward incoming HTTP
connections to HTTPS.</li>
</ul>
</li>
<li>HTTPS:
<ul>
<li>Type: <code>HTTPS</code></li>
<li>Protocol: <code>TCP</code></li>
<li>Port Range: <code>443</code></li>
<li>Sources: All IPv4, All IPv6.</li>
<li>Description: This allows incoming HTTPs connections.</li>
</ul>
</li>
<li>WireGuard VPN:
<ul>
<li>Type: <code>Custom</code></li>
<li>Protocol: <code>UDP</code></li>
<li>Port Range: <code>51820</code></li>
<li>Sources: All IPv4, All IPv6, unless you know the Pi will only
connect from a set of specific IP addresses.</li>
<li>Description: This allows incoming VPN connections from the Pi.</li>
</ul>
</li>
<li>ICMP:
<ul>
<li>Type: ICMP</li>
<li>Description: <em>Optional</em> - to allow ping response to the public sentry.</li>
</ul>
</li>
<li>Public SSH to the Pi:
<ul>
<li>Type: <code>Custom</code></li>
<li>Protocol: <code>TCP</code></li>
<li>Port Range: <code>2220</code></li>
<li>Sources: All IPv4, All IPv6, or a specific set of static IP
addresses if you want to be more secure.</li>
<li>Description: <em>Optional</em> - this is so you can access the SSH
console of the Raspberry Pi through the public sentry.</li>
</ul>
</li>
<li>Public SSH access for Forgejo (public git access):
<ul>
<li>Type: <code>Custom</code></li>
<li>Protocol: <code>TCP</code></li>
<li>Port Range: <code>2222</code></li>
<li>Sources: All IPv4, All IPv6, or a specific set of static IP
addresses if you want to be more secure.</li>
<li>Description: <em>Optional</em> - this is so you can fetch and push to
git repositories over SSH.</li>
</ul>
</li>
<li>Public SFTP access:
<ul>
<li>Type: <code>Custom</code></li>
<li>Protocol: <code>TCP</code></li>
<li>Port Range: <code>2223</code></li>
<li>Sources: All IPv4, All IPv6, or a specific set of static IP
addresses if you want to be more secure.</li>
<li>Description: <em>Optional</em> - this is so you can use <a href="http://localhost:1313/portable-docker/install-web-services/sftp/" rel="external" target="_blank">SFTP</a>.</li>
</ul>
</li>
<li>Click <code>Create Firewall</code>.</li>
</ul>
</li>
</ul>
</div>
</div>
<h2 id="create-the-digitalocean-droplet">Create the DigitalOcean droplet</h2>

<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> How to do this in the DigitalOcean cloud console</div>
  <div class="box-content">

<ul>
<li>Login to the <a href="https://cloud.digitalocean.com/" rel="external" target="_blank">DigitalOcean cloud console</a>.</li>
<li>Click <code>Droplets</code> in the menu.</li>
<li>Click <code>Create Droplet</code>.</li>
<li>Choose a Region (e.g., New York), where the droplet will be created.</li>
<li>Underneath the heading <code>Choose an image</code>, choose <code>Debian</code> (select
the latest version).</li>
<li>Choose a droplet size. For a wireguard proxy by itself, 1GB should
be fine. 2GB RAM and 50GB disk recommended for medium size
production installs with some apps installed on the droplet itself.
(It is also tested working on as little as 512MB ram,
<a href="https://blog.rymcg.tech/blog/linux/zram/" rel="external" target="_blank">if you enable zram</a>
and/or create a 1GB swapfile. Do not abuse swap space like this in
production! However I think its fine for development use, but you
may occasionally run into low memory issues if less than 1GB.)</li>
<li>Select the <code>pi</code> user&rsquo;s SSH key to access this droplet.</li>
<li>Set the hostname for the Docker server. The name should be short
and typeable, as it will become a part of the canononical service
URLs. For this example, we choose <code>sentry</code>.</li>
<li>Verify everything is correct, and then click <code>Create Dropet</code>.</li>
</ul>
</div>
</div>
<h2 id="apply-the-digitalocean-droplet-firewall">Apply the DigitalOcean droplet firewall</h2>

<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> How to do this in the DigitalOcean cloud console</div>
  <div class="box-content">

<ul>
<li>Login to the <a href="https://cloud.digitalocean.com/" rel="external" target="_blank">DigitalOcean cloud console</a>.</li>
<li>Click <code>Networking</code> in the menu.</li>
<li>Find the firewall template you created, and click on it.</li>
<li>Click on the firewall&rsquo;s <code>Droplets</code> tab.</li>
<li>Click <code>Add Droplets</code> and search for the droplet you created and select it.</li>
<li>Click <code>Add Droplet</code> to add the firewall to the droplet.</li>
</ul>
</div>
</div>
<h2 id="create-wildcard-dns-records-for-the-droplet">Create wildcard DNS records for the droplet</h2>

<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> How to do this in the DigitalOcean cloud console</div>
  <div class="box-content">

<ul>
<li>Login to the <a href="https://cloud.digitalocean.com/" rel="external" target="_blank">DigitalOcean cloud console</a>.</li>
<li>Click <code>Networking</code> in the menu.</li>
<li>Click the <code>Domains</code> tab.</li>
<li>Find the domain you created earlier, and click it.</li>
<li>Create an <code>A</code> record for the sentry:
<ul>
<li>Hostname: enter the subdomain name without the domain part (e.g.,
<code>sentry</code>, the name of your docker server, without the
<code>.example.com</code> suffix).</li>
<li>Will direct to: select the droplet you created from the list.</li>
<li>Click <code>Create Record</code>.</li>
</ul>
</li>
<li>Create another <code>A</code> record, for the wildcard of the sentry:
<ul>
<li>Hostname: enter the same name as before but prepend <code>*.</code> in front
of it (e.g., if the server is named <code>sentry</code>, create a record for
<code>*.sentry</code>, without the <code>.example.com</code> suffix).</li>
<li>Will direct to: select the same droplet as before.</li>
<li>Click <code>Create Record</code>.</li>
</ul>
</li>
<li>Create another <code>A</code> record, for the Raspberry Pi:
<ul>
<li>Hostname: e.g., <code>pi.example.com</code>.</li>
<li>Will direct to to: select the same droplet as before.</li>
<li>Click <code>Create Record</code>.</li>
</ul>
</li>
<li>Create another <code>A</code> record, for the wildcard of the Raspberry Pi:
<ul>
<li>Hostname: e.g., <code>*.pi.example.com</code>.</li>
<li>Will direct to to: select the same droplet as before.</li>
<li>Click <code>Create Record</code>.</li>
</ul>
</li>
<li>Create any more <code>A</code> records that you may need.</li>
</ul>
</div>
</div>

<div class="box notices cstyle secondary">
  <div class="box-label">Test DNS</div>
  <div class="box-content">

<p>Test that your wildcard record actually works. Use the <code>dig</code> command
(For Debian/Ubuntu install the <code>dnsutils</code> package. For Arch Linux
install <code>bind-tools</code>. For Fedora install <code>bind-utils</code>.)</p>
<p>Pick some random subdomain off your domain:</p>
<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
dig laksdflkweieri.sentry.example.com
</pre></code>
    </div>
</div>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
;; ANSWER SECTION:
laksdflkweieri.sentry.example.com.    3600    IN      A       153.114.12.78
</pre>
    </div>
</div>
<p>Since you created the wildcard record for <code>*.sentry.example.com</code> dig
should return your Docker server&rsquo;s IP address in the <code>ANSWER SECTION</code>
of the output. You can test all your other records the same way.</p>
<p>If you run into DNS caching problems, verify with the source DNS
server directly:</p>
<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
dig @ns1.digitalocean.com laksdflkweieri.sentry.example.com
</pre></code>
    </div>
</div>
</div>
</div>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000320-set-up-docker-context">Configure the sentry context on the Pi</h1>
                    <div class="chapter-content">
                        
<p>You now need to be able to control the droplet&rsquo;s <code>root</code> user from the
Raspberry Pi&rsquo;s <code>pi</code> user. Create a new SSH config entry for the
sentry (replace <code>sentry.example.com</code> with your own droplet&rsquo;s DNS
name):</p>
<figure><img src="/img/portable-docker/configure.webp"/>
</figure>


<pre class="mermaid align-center ">
graph LR;
    Workstation[Personal Workstation] --&gt;|SSH| RaspberryPi[Raspberry Pi]
    RaspberryPi --&gt;|SSH| Sentry[Sentry]
</pre>
<h2 id="append-to-the-ssh-config-on-the-pi">Append to the SSH config on the Pi</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
cat &lt;&lt;EOF &gt&gt ~/.ssh/config
Host sentry
    User root
    Hostname sentry.example.com
    ControlMaster auto
    ControlPersist yes
    ControlPath /tmp/ssh-%u-%r@%h:%p
EOF
</pre></code>
    </div>
</div>



<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>The Hostname value should point to the same name you created the DNS
entry for the sentry.</p>
</div>
</div>
<h2 id="test-the-connection-from-the-pi-to-the-sentry">Test the connection from the Pi to the sentry</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
ssh sentry whoami
</pre></code>
    </div>
</div>


<p>The first time you connect, you must confirm the host fingerprint (type <code>yes</code>):</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
The authenticity of host 'sentry' can't be established.
ED25519 key fingerprint is SHA256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
</pre>
    </div>
</div>

<p>On the final line, it will print the output of the command you
requested, which should print the username <code>root</code> :</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
root
</pre>
    </div>
</div>

<h2 id="create-a-new-docker-context-for-the-sentry">Create a new Docker context for the sentry</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
d context new
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? This command can help create a new SSH config and Docker context. Proceed? (Y/n) y

? You must specify the SSH config entry to use
> I already have an SSH host entry in ~/.ssh/config that I want to use
  I want to make a new SSH host entry in ~/.ssh/config

? Choose an existing SSH Host config
  pi
> sentry

> Do you want to switch to the new sentry context now? Yes
</pre>
    </div>
</div>

<h2 id="install-docker-on-the-sentry">Install Docker on the sentry</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry install-docker
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? This will install Docker on the host of your remote Docker context.. Proceed? Yes
</pre>
    </div>
</div>

<h2 id="test-the-docker-context-is-functional">Test the docker context is functional</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
d tmp-context sentry docker info | grep Context
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Context:    sentry
</pre>
    </div>
</div>


<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Switch between Docker contexts</div>
  <div class="box-content">

<p>You should now have two configured Docker contexts on your Pi:</p>
<ul>
<li><code>pi</code></li>
<li><code>sentry</code></li>
</ul>
<p>You can switch between these two contexts using <code>d context</code>. The
currently selected context specifies which Docker server is currently
being operated on.</p>
</div>
</div>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000325-configure-d-rymcg-tech-for-sentry">Configure d.rymcg.tech for the sentry</h1>
                    <div class="chapter-content">
                        
<h2 id="run-the-main-config">Run the main config</h2>
<p>The main config must be run for each new context you create:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
> This will make a configuration for the current docker context (sentry). Proceed? Yes

ROOT_DOMAIN: Enter the root domain for this context (e.g., d.example.com)

: sentry.example.com
</pre>
    </div>
</div>

<h2 id="install-traefik">Install Traefik</h2>
<p>This is a very similar process as when you installed Traefik on the
Raspberry Pi:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>Create the traefik user:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik Configuration:
> Traefik user
</pre>
    </div>
</div>

<p>Configure ACME:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik TLS config:
  Configure certificate authorities (CA)
> Configure ACME (Let's Encrypt or Step-CA)
  Configure TLS certificates (make certs)
</pre>
    </div>
</div>

<p>Choose Let&rsquo;s Encrypt:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Which ACME provider do you want to use?
> Let's Encrypt (ACME)
  Step-CA (ACME)
  Disable ACME
  Cancel / Go back
</pre>
    </div>
</div>

<p>Choose the Production environment:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Which LE environment do you want to use?
> Production (recommended!)
  Staging (untrusted / testing)
</pre>
    </div>
</div>

<p>Choose the DNS-01 challenge type:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Which type of ACME challenge should be used?
  TLS-ALPN-01 (default for public servers, easy, but no wildcard certs)
> DNS-01 (requires API key, but good behind firewalls, and allows wildcard certs)

Find the provider code of your supported DNS provider here:
https://go-acme.github.io/lego/dns/#dns-providers

TRAEFIK_ACME_DNS_PROVIDER: Enter the LEGO code for your DNS Provider (e.g., digitalocean)

: digitalocean
</pre>
    </div>
</div>

<p>Enter the variable <em>name</em> literal DO_AUTH_TOKEN:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
TRAEFIK_ACME_DNS_VARNAME_1: Enter the 1st DNS provider variable name (e.g., DO_AUTH_TOKEN)

: DO_AUTH_TOKEN

TRAEFIK_ACME_DNS_VARNAME_2: Enter the 2nd DNS provider variable name (or leave blank)

:
</pre>
    </div>
</div>

<p>Enter a blank for the second var name, because there isn&rsquo;t one.</p>
<p>Now enter the variable <em>value</em> for DO_AUTH_TOKEN (this should actually
be the secret <a href="https://cloud.digitalocean.com/account/api/tokens/new" rel="external" target="_blank">personal access token that you generate on DigitalOcean</a>):</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Now to enter the values for the custom DNS API variables:
DO_AUTH_TOKEN: Enter the value for DO_AUTH_TOKEN (e.g., your-actual-digitalocean-token-here)

: dop_v1_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</pre>
    </div>
</div>

<p>Create a new TLS certificate:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik TLS config:
  Configure certificate authorities (CA)
  Configure ACME (Let's Encrypt or Step-CA)
> Configure TLS certificates (make certs)

? Configure Traefik TLS certificates
  Manage all certificates.
> Create a new certificate.
  Done / Go back

Enter the main domain (CN) for this certificate (e.g., `d.rymcg.tech` or `*.d.rymcg.tech`)

: sentry.example.com

Now enter additional domains (SANS), one per line:
Enter a secondary domain (enter blank to skip)

: *.sentry.example.com

Enter a secondary domain (enter blank to skip)

:

Main domain:
 sentry.example.com
Secondary (SANS) domains:
 *.sentry.example.com
</pre>
    </div>
</div>

<h2 id="install-traefik">Install Traefik</h2>
<p>Press <code>ESC</code> three times to go back to the main menu.</p>
<p>Install Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>When done, press <code>ESC</code> to quit the Traefik config program.</p>
<h2 id="install-whoami">Install whoami</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make whoami config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
WHOAMI_TRAEFIK_HOST: Enter the whoami domain name (e.g., whoami.example.com)

: whoami.sentry.example.com

? Do you want to enable sentry authorization in front of this app (effectively making the entire site private)?
> No
  Yes, with HTTP Basic Authentication
  Yes, with Oauth2
  Yes, with Mutual TLS (mTLS)
</pre>
    </div>
</div>



<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make whoami install
</pre></code>
    </div>
</div>



<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Whoami on the sentry</div>
  <div class="box-content">

<p>This instance of whoami runs on the droplet, and it is only to test
the connectivity of the public droplet itself. We still have not yet
exposed the whoami running on the Raspberry Pi publicly.</p>
</div>
</div>
<h2 id="wait-a-few-minutes-for-the-tls-certificate-to-generate">Wait a few minutes for the TLS certificate to generate</h2>
<h2 id="test-the-whoami-instance">Test the whoami instance</h2>
<p>You can open the page in <code>w3m</code>:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make whoami open
</pre></code>
    </div>
</div>


<p>Or test it with curl:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
curl https://whoami.sentry.example.com
</pre></code>
    </div>
</div>


<p>Note that if the TLS certificate has not been issued yet, you will get
this error from curl (and a similar error in <code>w3m</code>):</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
curl: (60) SSL certificate problem: self-signed certificate
More details here: https://curl.se/docs/sslcerts.html

curl failed to verify the legitimacy of the server and therefore could not
establish a secure connection to it. To learn more about this situation and
how to fix it, please visit the web page mentioned above.
</pre>
    </div>
</div>

<p>Simply wait a bit longer for the TLS cert to issue, or check the logs
for errors (<code>d make traefik logs service=traefik</code>). You can also tell
curl to ignore the error (<code>-k</code>):</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
## This is insecure, but fine for testing:
curl -k https://whoami.sentry.example.com
</pre></code>
    </div>
</div>


<p>A valid whoami response page looks like similar to this:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Name: default
Hostname: 52a9750ecaa4
IP: 127.0.0.1
IP: ::1
IP: 172.19.0.2
RemoteAddr: 172.19.0.1:56082
GET / HTTP/1.1
Host: whoami.sentry.example.com
User-Agent: curl/7.88.1
Accept: */*
Accept-Encoding: gzip
X-Forwarded-For: X.X.X.X
X-Forwarded-Host: whoami.sentry.example.com
X-Forwarded-Port: 443
X-Forwarded-Proto: https
X-Forwarded-Server: sentry
X-Real-Ip: X.X.X.X
</pre>
    </div>
</div>

<h2 id="next-steps">Next steps</h2>
<ul>
<li>Configure the WireGuard VPN.</li>
<li>Set up public SSH.</li>
<li>Install core services.</li>
<li>Install apps.</li>
</ul>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000410-configure-sentry-wireguard-server">Configure sentry wireguard server</h1>
                    <div class="chapter-content">
                        
<figure><img src="/img/portable-docker/tunnel.webp"/>
</figure>

<h2 id="reconfigure-traefik-to-enable-wireguard-server">Reconfigure Traefik to enable WireGuard server</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
> Advanced Routing (Layer 7 / Layer 4 / WireGuard)
  Error page template
  Logging level
  Access logs

? Traefik routes
  Configure layer 7 TLS proxy
  Configure layer 4 TCP/UDP proxy
> Configure wireguard VPN

? Should this Traefik instance connect to a wireguard VPN?
  No, Traefik should use the host network directly.
> Yes, and this Traefik instance should start the wireguard server.
  Yes, but this Traefik instance needs credentials to connect to an outside VPN.

? Should Traefik bind itself exclusively to the VPN interface?
> No, Traefik should work on all interfaces (including the VPN).
  Yes, Traefik should only listen on the VPN interface.

TRAEFIK_VPN_HOST: Enter the public Traefik VPN hostname (e.g., vpn.example.com)

: sentry.example.com

TRAEFIK_VPN_SUBNET: Enter the Traefik VPN private subnet (no mask) (e.g., 10.13.16.0)

: 10.13.16.0

TRAEFIK_VPN_ADDRESS: Enter the Traefik VPN private IP address (e.g., 10.13.16.1)

: 10.13.16.1

TRAEFIK_VPN_PORT: Enter the Traefik VPN TCP port number (e.g., 51820)

: 51820

Enter the Traefik VPN peers list

: pi
</pre>
    </div>
</div>

<p>You may enter up 253 peer names, separated by commas, with no spaces,
e.g., <code>pi,pi2,phone1,toaster,garage</code>. Each client name should be a
single word of letters and/or numbers.</p>
<p>Press <code>ESC</code> two times to back out to the main menu.</p>

<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>You may also add additional clients at a later time, however you
should not remove or change the order of the existing clients, so it
is only safe to append to this list. If you need to remove a client,
you should destroy all the clients and recreate them.</p>
<div class="box notices cstyle run">
    <div class="box-label warning">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this if you need to reset all the client keys</div>
    <div class="box-content">
        <code><pre>
## Resets all WireGuard keys:
sentry make traefik destroy service=wireguard
sentry make traefik install
</pre></code>
    </div>
</div>
</div>
</div>
<h2 id="reconfigure-traefik-to-add-a-layer-7-route-to-the-raspberry-pi">Reconfigure Traefik to add a Layer 7 route to the Raspberry Pi</h2>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
> Advanced Routing (Layer 7 / Layer 4 / WireGuard)
  Error page template
  Logging level
  Access logs

? Traefik routes
> Configure layer 7 TLS proxy
  Configure layer 4 TCP/UDP proxy
  Configure wireguard VPN

> Do you want to enable the layer 7 TLS proxy? Yes

? Layer 7 TLS Proxy:
  List layer 7 ingress routes
> Add new layer 7 ingress route
  Remove layer 7 ingress routes
  Disable layer 7 TLS Proxy

Enter the public domain (SNI) for the route:

: whoami.pi.example.com

Enter the destination IP address to forward to:

: 10.13.16.2

Enter the destination TCP port to forward to:

: 443

##
## See https://www.haproxy.org/download/2.0/doc/proxy-protocol.txt

> Do you want to enable Proxy Protocol for this route? Yes

## Layer 7 TLS Proxy is ENABLED.
## Configured Layer 7 Routes:
Entrypoint              Destination_address  Destination_port  Proxy_protocol
----------              -------------------  ----------------  --------------
whoami.pi.example.com  10.13.16.2           443               2
</pre>
    </div>
</div>

<p>Press <code>ESC</code> multiple times to back out to the main menu. On the main
menu, select <code>Install</code>, to re-install Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>Once re-installed, press <code>ESC</code> to quit the config tool.</p>
<h2 id="find-the-wireguard-peer-config">Find the wireguard peer config</h2>
<p>You can check the wireguard service is now started:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik show-wireguard-peers
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
## /config/peer_pi/peer_pi.conf
[Interface]
Address = 10.13.16.2
PrivateKey = 2E1vQHCS5JuaoRrt21GO0bYVrafOhplrGNFqoFBivEY=
ListenPort = 51820
DNS = 10.13.16.1

[Peer]
PublicKey = AZiNh/5sk71QTy6Rk0ygzIUsSGAX8/s3EeGN6lT9oj0=
PresharedKey = tEIW8FuxR6I+Qu79bORatbD+JgNPeigNvc9V18f7to8=
Endpoint = sentry.example.com:51820
AllowedIPs = 10.13.16.0/24
</pre>
    </div>
</div>

<p>Copy the output you see into a tempory buffer / notepad, you will need
to copy this information in the next chapter.</p>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000420-configure-raspberry-pi-wireguard-client">Configure Raspberry Pi WireGuard client</h1>
                    <div class="chapter-content">
                        
<figure><img src="/img/portable-docker/castle.webp"/>
</figure>

<h2 id="reconfigure-traefik-to-enable-wireguard-client">Reconfigure Traefik to enable WireGuard client</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
> Advanced Routing (Layer 7 / Layer 4 / WireGuard)
  Error page template
  Logging level
  Access logs

? Traefik routes
  Configure layer 7 TLS proxy
  Configure layer 4 TCP/UDP proxy
> Configure wireguard VPN

? Should this Traefik instance connect to a wireguard VPN?
  No, Traefik should use the host network directly.
  Yes, and this Traefik instance should start the wireguard server.
> Yes, but this Traefik instance needs credentials to connect to an outside VPN.

? Should Traefik bind itself exclusively to the VPN interface?
> No, Traefik should work on all host interfaces (including the VPN).
  Yes, Traefik should only listen on the VPN interface.

TRAEFIK_VPN_CLIENT_INTERFACE_ADDRESS: Enter the wireguard client Interface Address (e.g., 10.13.16.2)

: 10.13.16.2

TRAEFIK_VPN_CLIENT_INTERFACE_PRIVATE_KEY: Enter the wireguard PrivateKey (ends with =)

: 2E1vQHCS5JuaoRrt21GO0bYVrafOhplrGNFqoFBivEY=

TRAEFIK_VPN_CLIENT_INTERFACE_LISTEN_PORT: Enter the wireguard listen port (e.g., 51820)

: 51820

TRAEFIK_VPN_CLIENT_PEER_PUBLIC_KEY: Enter the Peer PublicKey (ends with =)

: AZiNh/5sk71QTy6Rk0ygzIUsSGAX8/s3EeGN6lT9oj0=

TRAEFIK_VPN_CLIENT_PEER_PRESHARED_KEY: Enter the Peer PresharedKey (ends with =)

: tEIW8FuxR6I+Qu79bORatbD+JgNPeigNvc9V18f7to8=

TRAEFIK_VPN_CLIENT_PEER_ENDPOINT: Enter the Peer Endpoint (host:port)

: sentry.example.com:51820

TRAEFIK_VPN_CLIENT_PEER_ALLOWED_IPS: Enter the Peer AllowedIPs (e.g., 10.13.16.1/32)

: 10.13.16.1/32
</pre>
    </div>
</div>

<h2 id="reinstall-traefik">Reinstall Traefik</h2>
<p>Press <code>ESC</code> twice to go back to the main menu, then re-install:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>Once reinstalled, press <code>ESC</code> to quit the config tool.</p>
<h2 id="test-vpn-connectivity">Test VPN connectivity</h2>
<p>Check the logs:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make traefik logs service=wireguard-client
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
wireguard-client-1  | 2024-09-28T08:42:09.445201647Z **** All tunnels are now active ****
</pre>
    </div>
</div>

<p>Enter the wireguard client shell to test networking parameters:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make traefik shell service=wireguard-client
</pre></code>
    </div>
</div>


<p>Show the connected wireguard peers:</p>


<div class="box notices cstyle run">
    <div class="box-label info">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this in the WireGuard Client shell</div>
    <div class="box-content">
        <code><pre>
wg
</pre></code>
    </div>
</div>



<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Look for the last handshake time</div>
  <div class="box-content">

<p>The output of <code>wg</code> should show the peer and the <code>latest handshake</code>
time, for example:</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>latest handshake: 45 seconds ago</span></span></code></pre></div><p>If you do not see a handshake time, then there is some kind of problem
connecting to the WireGuard server that you need to resolve.</p>
</div>
</div>
<p>Ping the WireGuard server (<code>10.13.16.1</code>):</p>


<div class="box notices cstyle run">
    <div class="box-label info">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this in the WireGuard Client shell</div>
    <div class="box-content">
        <code><pre>
ping -c3 10.13.16.1
</pre></code>
    </div>
</div>


<p>When you are done using the shell press <code>Ctrl-D</code> or type <code>exit</code> to
quit.</p>
<h2 id="check-that-whoami-is-available-publicly">Check that whoami is available publicly</h2>
<p>In the last chapter you created a layer 7 route for the URL
<code>https://whoami.pi.example.com</code>. Now that your wireguard connection
is active on both ends, it should be publicly accessible. Test the URL
in your personal web browser.</p>
<h2 id="next-steps">Next steps</h2>
<ul>
<li>Set up public SSH.</li>
<li>Install core services.</li>
<li>Install apps.</li>
</ul>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000620-forgejo">Forgejo</h1>
                    <div class="chapter-content">
                        
<p><a href="https://forgejo.org/" rel="external" target="_blank">Forgejo</a> is a self-hosted git forge similar to <a href="https://docs.github.com/en/get-started/start-your-journey/about-github-and-git" rel="external" target="_blank">GitHub</a>. Forgejo is a
fork of <a href="https://github.com/go-gitea/gitea?tab=readme-ov-file#gitea" rel="external" target="_blank">Gitea</a>, which is a fork of <a href="https://github.com/gogs/gogs" rel="external" target="_blank">Gogs</a>.</p>
<figure><img src="/img/portable-docker/forgejo-home.webp"/>
</figure>

<p>Installing Forgejo is useful for two unrelated purposes:</p>
<ul>
<li>Self-hosting your own git repositories.</li>
<li>Providing an OAuth2 identity service for your organization,
facilitating single-sign on to all of your apps via Traefik&rsquo;s
<a href="https://doc.traefik.io/traefik/middlewares/http/forwardauth/" rel="external" target="_blank">forward-auth middleware</a>.</li>
</ul>

<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Forgejo is fundamental infrastructure</div>
  <div class="box-content">

<p>You don&rsquo;t need to install Forgejo on every server you make, but having
at least one instance in your domain is recommended.</p>
<p>Even if you (or your users) have no need for storing git repositories,
Forgejo is part of the fundamental infrastructure of securing other
d.rymcg.tech apps via OAuth2. You can authenticate and authorize your
users to access your apps via their Forgejo account (sentry
authorization), see the next chapter: <a href="/portable-docker/install-core-services/traefik-forward-auth">Traefik Forward Auth</a>.</p>
</div>
</div>
<h2 id="configure-forgejo">Configure Forgejo</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make forgejo config
</pre></code>
    </div>
</div>


<p>Configure the domain name and service description:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
FORGEJO_TRAEFIK_HOST: Enter your forgejo domain name (eg. git.example.com)

: git.pi.example.com

APP_NAME: Enter the service description (eg. "git thing")

: pi5 git hosting

? Do you want to enable sentry authorization in front of this app (effectively making the entire site private)?
> No
  Yes, with Mutual TLS (mTLS)
</pre>
    </div>
</div>

<h2 id="install-forgejo">Install Forgejo</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make forgejo install
</pre></code>
    </div>
</div>


<h2 id="add-a-new-route-on-the-sentry">Add a new route on the sentry</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
> Advanced Routing (Layer 7 / Layer 4 / WireGuard)
  Error page template
  Logging level
  Access logs

? Traefik routes
> Configure layer 7 TLS proxy
  Configure layer 4 TCP/UDP proxy
  Configure wireguard VPN

? Layer 7 TLS Proxy:
  List layer 7 ingress routes
> Add new layer 7 ingress route
  Remove layer 7 ingress routes
  Disable layer 7 TLS Proxy

Enter the public domain (SNI) for the route:

: git.pi.example.com

Enter the destination IP address to forward to:

: 10.13.16.2

Enter the destination TCP port to forward to:

: 443

> Do you want to enable Proxy Protocol for this route? Yes

## Layer 7 TLS Proxy is ENABLED.
## Configured Layer 7 Routes:
Entrypoint           Destination_address  Destination_port  Proxy_protocol
----------           -------------------  ----------------  --------------
git.pi.example.com  10.13.16.2           443               2
</pre>
    </div>
</div>

<p>Press <code>ESC</code> three times to go back to the main menu, and re-install Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>After installation, press <code>ESC</code> to quit the config tool.</p>
<h2 id="finish-forgejo-installation">Finish Forgejo installation</h2>
<p>Immediately open the Foregjo application to finish the installation.
Open your web browser to <code>https://git.pi.example.com</code>.</p>
<p>This should show a page with the title <code>Initial configuration</code> at the
top. The <strong>only</strong> thing you need to change on this page is the admin
credentials found at the bottom (all of other settings are instead
derived from the environment variables found in the Forgejo
<code>.env_{CONTEXT}_{INSTANCE}</code> file created by d.rymcg.tech):</p>
<figure><img src="/img/portable-docker/forgejo-admin-account-settings.webp"/>
</figure>

<ul>
<li>You should create a dedicated admin account, separate from your
personal account.</li>
<li>Click <code>Administrator account settings</code> to expand the section.</li>
<li>Enter the <code>Adminstrator username</code>: <code>root</code></li>
<li>Enter the admin email address.</li>
<li>Enter a secure passphrase and confirmation.</li>
<li>Click the <code>Install Forgejo</code> button at the very bottom.</li>
</ul>
<p>Once logged in as <code>root</code>, you can create additional user accounts from
the account icon in the top right, which expands a menu.</p>
<figure><img src="/img/portable-docker/forgejo-admin-site-settings.webp"/>
</figure>

<ul>
<li>Click <code>Site adminstration</code>.</li>
<li>Click <code>Identity &amp; access</code>.</li>
<li>Click <code>User accounts</code>.</li>
</ul>
<figure><img src="/img/portable-docker/forgejo-admin-user-accounts.webp"/>
</figure>

<ul>
<li>Click <code>Create User Account</code> and create your own personal account.</li>
<li>Log out of the root account and test logging into the new account.</li>
</ul>
<h2 id="which-account-to-use">Which account to use?</h2>
<ul>
<li>You should use the <code>root</code> account for creating new OAuth2 apps and
for creating new users.</li>
<li>You should use your personal account for storing your git
repositories and for your identity when logging into other apps.</li>
</ul>
<h2 id="enable-access-to-repositories-by-ssh">Enable access to repositories by SSH</h2>
<p>By default, Forgejo only supports cloning its hosted git repositories
via HTTPS. To allow cloning by SSH, you must enable the Traefik SSH
entrypoint:</p>
<h3 id="enable-the-traefik-ssh-entrypoint">Enable the Traefik SSH entrypoint</h3>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
  Traefik user
> Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
  Advanced Routing (Layer 7 / Layer 4 / Wireguard)
  Error page template
v Logging level

? Traefik entrypoint config
  Show enabled entrypoints
> Configure stock entrypoints
  Configure custom entrypoints

? Select entrypoint to configure:
^ websecure : HTTPS (TLS encrypted HTTP)
  web_plain : HTTP (unencrypted; specifically NOT redirected to websecure; must use different port than web)
  mqtt : MQTT (mosquitto) pub-sub service
> ssh : SSH (forgejo) git (ssh) entrypoint
  xmpp_c2s : XMPP (ejabberd) client-to-server entrypoint
  xmpp_s2s : XMPP (ejabberd) server-to-server entrypoint
v mpd : Music Player Daemon (mopidy) control entrypoint

> Do you want to enable the ssh entrypoint? Yes

TRAEFIK_SSH_ENTRYPOINT_HOST: Enter the host ip address to listen on (0.0.0.0 to listen on all interfaces) (eg. 0.0.0.0)

: 0.0.0.0

TRAEFIK_SSH_ENTRYPOINT_PORT: Enter the host port to listen on (eg. 2222)

: 2222

? Is this entrypoint downstream from another trusted proxy?
> No, clients dial directly to this server. (Turn off Proxy Protocol)
  Yes, clients are proxied through a trusted server. (Turn on Proxy Protocol)
</pre>
    </div>
</div>


<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Do not enable Proxy Protocol</div>
  <div class="box-content">

<p>Do not enable Proxy Protocol, because it is not supported by SSH.</p>
</div>
</div>
<p>Press <code>ESC</code> three times to go back to the main menu, then re-install Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>Once reinstalled, press <code>ESC</code> to exit the config tool.</p>
<h3 id="create-an-entrypoint-on-the-sentry">Create an entrypoint on the sentry</h3>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
  Traefik user
> Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
  Advanced Routing (Layer 7 / Layer 4 / Wireguard)
  Error page template
v Logging level

? Custom Entrypoints: <canceled>

? Traefik entrypoint config
  Show enabled entrypoints
  Configure stock entrypoints
> Configure custom entrypoints

? Custom Entrypoints:
  List custom entrypoints
> Add new custom entrypoint
  Remove custom entrypoints

Adding a custom TCP/UDP entrypoint -

- Make sure to enable the port in all upstream firewalls.
- Make sure each entrypoint has a unique lower-case one-word name.

Enter the new entrypoint name:

: forgejo

Enter the entrypoint listen address:

: 0.0.0.0

Enter the entrypoint port:

: 2222

Enter the protocol (tcp or udp):

: tcp

? Is this entrypoint downstream from another trusted proxy?
> No, clients dial directly to this server. (Turn off Proxy Protocol)
  Yes, clients are proxied through another trusted proxy. (Turn on Proxoy Protocol)
</pre>
    </div>
</div>


<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Do not enable Proxy Protocol</div>
  <div class="box-content">

<p>SSH does not support <a href="https://www.haproxy.org/download/2.0/doc/proxy-protocol.txt" rel="external" target="_blank">Proxy Protocol</a>, so be sure to disable it.</p>
</div>
</div>
<p>Press <code>ESC</code> three times to go back to the main menu.</p>
<h3 id="create-a-route-from-the-sentry-to-the-pi">Create a route from the sentry to the Pi</h3>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
> Advanced Routing (Layer 7 / Layer 4 / Wireguard)
  Error page template
  Logging level
  Access logs

? Traefik routes
  Configure layer 7 TLS proxy
> Configure layer 4 TCP/UDP proxy
  Configure wireguard VPN

## Layer 4 TCP/UDP Proxy is DISABLED.
? Do you want to enable the layer 4 TCP/UDP proxy? (y/N) Yes

? Layer 4 TCP/UDP Proxy:
  List layer 4 ingress routes
> Add new layer 4 ingress route
  Remove layer 4 ingress routes
  Disable layer 4 TCP/UDP Proxy

? Entrypoint
> forgejo

Enter the destination IP address to forward to:

: 10.13.16.2

Enter the destination TCP port to forward to:

: 2222

##
## See https://www.haproxy.org/download/2.0/doc/proxy-protocol.txt

> Do you want to enable Proxy Protocol for this route? No
Set TRAEFIK_LAYER_4_TCP_UDP_PROXY_ROUTES=ssh_pi:10.13.16.2:22:0,forgejo:10.13.16.2:2222:0
## Configured Layer 4 Routes:
Entrypoint  Destination_address  Destination_port  Proxy_protocol
----------  -------------------  ----------------  --------------
forgejo     10.13.16.2           2222              0
</pre>
    </div>
</div>

<p>Press <code>ESC</code> three times to go back to main menu, then re-install
Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>Once reinstalled, press <code>ESC</code> to exit the config tool.</p>
<h3 id="test-cloning-a-repository-via-ssh">Test cloning a repository via SSH</h3>
<ul>
<li>Login to your Forgejo instance</li>
<li>Create a new repository</li>
<li>On the repository page, click on SSH and copy the SSH URL.</li>
</ul>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
git clone ssh://git@git.pi.example.com:2222/username/repository.git
</pre></code>
    </div>
</div>



                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000630-traefik-forward-auth">Traefik-Forward-Auth (sentry authorization)</h1>
                    <div class="chapter-content">
                        

<pre class="mermaid align-center ">
---
title: Traefik Forward Auth
---
graph LR;
    Start[Request...] --&gt;|HTTP| Traefik
    Traefik --&gt;|Sends the request to AuthServer| TFA[Traefik-Forward-Auth]
    TFA --&gt;|OAuth2| Forgejo
    Forgejo --&gt;|Oauth2 OK / KO| TFA
    TFA --&gt;|Returns OK / KO| Traefik
    Traefik --&gt;|If OK, proceed...| Proceed[...Access Granted]
    Traefik --&gt;|If KO, returns the error| Start
</pre>
<h2 id="sentry-authorization">Sentry authorization</h2>
<p>Some apps may already have their own authentication mechanisms, while
others may not. Sentry authorization creates a common authentication
and authorization framework <em>in front of</em> your applications via
Traefik middleware. Sentry authorization happens <em>before</em> any existing
auth mechanisms in the app itself, and so it acts as a front door
gatekeeper for your apps. It can&rsquo;t control what users are allowed to
do once they get in, but it does control who is allowed in through the
front door.</p>
<ul>
<li>Users are <em>authenticated</em> via the <a href="/portable-docker/install-core-services/forgejo/index.html">Forgejo</a> instance and <a href="https://github.com/EnigmaCurry/d.rymcg.tech/tree/master/traefik-forward-auth#traefik-forward-auth" rel="external" target="_blank">traefik-forward-auth</a>.</li>
<li>Users are <em>authorized</em> by a group membership filter applied on a
per-app basis.</li>
</ul>
<h2 id="configure-traefik-forward-auth">Configure traefik-forward-auth</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make traefik-forward-auth config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
TRAEFIK_FORWARD_AUTH_HOST: Enter the traefik-foward-auth host domain name (eg. auth.example.com)

: auth.pi.example.com

TRAEFIK_FORWARD_AUTH_COOKIE_DOMAIN: Enter the cookie domain name (ie ROOT domain) (eg. example.com)

: pi.example.com

? Select the OAuth provider to use
> gitea
  github
  google
  discord

TRAEFIK_FORWARD_AUTH_GITEA_DOMAIN: Enter your gitea domain name (eg. git.example.com)

: git.pi.example.com
</pre>
    </div>
</div>

<p>At this point it will open <code>w3m</code> to the gitea instance asking you to
sign in. Because this isn&rsquo;t very user friendly, so just press <code>q</code> and
then <code>y</code> to quit <code>w3m</code>.</p>
<ul>
<li>Open your preffered web browser and open up the gitea URL:
<code>https://git.pi.example.com</code></li>
<li>Make sure you are logged in as the <code>root</code> user.</li>
<li>Open the root user settings page, click <code>Applications</code>.</li>
<li>Fill in the section titled <code>Manage OAuth2 applications</code>:
<ul>
<li>Enter an application name as a public identifier.</li>
<li>Enter the redirect URI <code>https:://auth.pi.example.com/_oauth</code>.</li>
</ul>
</li>
<li>Click <code>Create Application</code>.</li>
</ul>
<figure><img src="/img/portable-docker/forgejo-admin-user-create-app.webp"/>
</figure>

<ul>
<li>This will show you the OAuth2 client ID and secret:</li>
</ul>
<figure><img src="/img/portable-docker/forgejo-admin-user-app-secret.webp"/>
</figure>

<p>Back in your terminal session, it should be asking you to fill these
same details in:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
TRAEFIK_FORWARD_AUTH_PROVIDERS_GENERIC_OAUTH_CLIENT_ID: Copy and Paste the OAuth2 client ID here

: 38d6c7f7-c712-43a9-967c-27888819e85f

TRAEFIK_FORWARD_AUTH_PROVIDERS_GENERIC_OAUTH_CLIENT_SECRET: Copy and Paste the OAuth2 client secret here

: gto_4g54tazy7oyslypqhr7z7khundcmtwezlkdeyghe7ctj7k4gltvq

TRAEFIK_FORWARD_AUTH_LOGOUT_REDIRECT: Enter the logout redirect URL

: https://git.pi.example.com/logout
</pre>
    </div>
</div>

<h2 id="install-traefik-forward-auth">Install Traefik-Forward-Auth</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make traefik-forward-auth install
</pre></code>
    </div>
</div>


<h2 id="add-a-new-route-on-the-sentry">Add a new route on the sentry</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
> Advanced Routing (Layer 7 / Layer 4 / WireGuard)
  Error page template
  Logging level
  Access logs

? Traefik routes
> Configure layer 7 TLS proxy
  Configure layer 4 TCP/UDP proxy
  Configure wireguard VPN

? Layer 7 TLS Proxy:
  List layer 7 ingress routes
> Add new layer 7 ingress route
  Remove layer 7 ingress routes
  Disable layer 7 TLS Proxy

Enter the public domain (SNI) for the route:

: auth.pi.example.com

Enter the destination IP address to forward to:

: 10.13.16.2

Enter the destination TCP port to forward to:

: 443

> Do you want to enable Proxy Protocol for this route? Yes

## Layer 7 TLS Proxy is ENABLED.
## Configured Layer 7 Routes:
Entrypoint           Destination_address  Destination_port  Proxy_protocol
----------           -------------------  ----------------  --------------
auth.pi.example.com  10.13.16.2           443               2
</pre>
    </div>
</div>

<p>Press <code>ESC</code> three times to go back to the main menu, and re-install Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>After installation, press <code>ESC</code> to quit the config tool.</p>
<h2 id="add-user-groups-for-sentry-authorization">Add user groups for sentry authorization</h2>
<p>With OAuth2 sentry authorization enabled, users are authorized to
access apps only if they are a member of an authorized group for that
app. You need to create the group membership lists in the Traefik
config:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
  Traefik user
  Entrypoints (including dashboard)
  TLS certificates and authorities
> Middleware (including sentry auth)
  Advanced Routing (Layer 7 / Layer 4 / Wireguard)
  Error page template
v Logging level

? Traefik middleware config:
  MaxMind geoIP locator
> OAuth2 sentry authorization (make sentry)

? Sentry Authorization Manager (main menu):
> Group Manager
  User Manager
  List all members
  List authorized callback URLs
  Quit

> Sentry Authorization Manager (main menu): Group Manager
? Choose a group to manage
> Create a new group

? Enter the name of the group to create: admin

> Do you want to add users to this group now? Yes

Enter the new user id(s) to add, one per line:
? Enter a user ID (Press Esc or enter a blank value to finish)  me@example.com
</pre>
    </div>
</div>


<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>Replace <code>me@example.com</code> with the same <strong>email address</strong> that you used
to sign up for your personal account in Forgejo. You can add more
users to the group if you wish, when done enter a blank line.</p>
</div>
</div>
<h2 id="re-configure-whoami-with-sentry-authorization--oauth2">Re-configure whoami with sentry authorization (OAuth2)</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make whoami config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
WHOAMI_TRAEFIK_HOST: Enter the whoami domain name (eg. whoami.example.com)

: whoami.pi.example.com

? Do you want to enable sentry authorization in front of this app (effectively making the entire site private)?
  No
  Yes, with HTTP Basic Authentication
> Yes, with Oauth2
  Yes, with Mutual TLS (mTLS)

? Which authorization group do you want to permit access to this app?
> admin
</pre>
    </div>
</div>


<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>This will allow only the <code>admin</code> authorization group to access this
instance.</p>
<p>Remember, you can create <a href="/portable-docker/install-core-services/traefik-forward-auth/#add-user-groups-for-sentry-authorization">extra authorization groups</a> in the Traefik
config, that way you can have separate user access per instance.</p>
</div>
</div>
<p>Re-install whoami:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make whoami install
</pre></code>
    </div>
</div>


<h2 id="test-login-for-whoami">Test login for whoami</h2>
<p>Open the whoami app in your web browser: <code>https://whoami.pi.example.com</code>.</p>
<p>You should be automatically redirected to the Foregjo app to login.</p>
<p>The first time a Forgejo user authenticates to a sentry authorization
protected app, they should see this prompt:</p>
<figure><img src="/img/portable-docker/forgejo-authorize-app.webp"/>
</figure>

<p>Confirm by clicking the button <code>Authorize Application</code>.</p>
<p>If the user is authorized, they should be automatically redirected
back to the whoami app.</p>
<p>The output of whoami now reflects the authorized user:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Name: default
Hostname: c863ccd86cec
IP: 127.0.0.1
IP: ::1
IP: 172.19.0.2
RemoteAddr: 172.19.0.1:38606
GET / HTTP/1.1
Host: whoami.pi.example.com
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:127.0) Gecko/20100101 Firefox/127.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Encoding: gzip, deflate, br, zstd
Accept-Language: en-US,en;q=0.5
Cookie: _forward_auth=xxxxxxxxxxxxxxxxxxxxxxxxxxx=|123456789|me@example.com
Dnt: 1
Priority: u=1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-site
Sec-Fetch-User: ?1
Te: trailers
Upgrade-Insecure-Requests: 1
X-Forwarded-For: 192.168.1.1
X-Forwarded-Host: whoami.pi.example.com
X-Forwarded-Port: 443
X-Forwarded-Proto: https
X-Forwarded-Server: pi
X-Forwarded-User: me@example.com
X-Real-Ip: 192.168.1.1
</pre>
    </div>
</div>

<p>The request shows the new details:</p>
<ul>
<li><code>Cookie</code> the cookie value is set by the traefik-forward-auth
middleware once the user is successfully authenticated.</li>
<li>The <code>X-Forwarded-User</code> is passed to the application to identify the
validated user id (email address).</li>
</ul>
<h2 id="reconfigure-other-apps-to-use-oauth2">Reconfigure other apps to use OAuth2</h2>
<p>All other apps may be protected with sentry authorization in the same manner as whoami.</p>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000640-postfix-relay">Postfix-Relay (MTA)</h1>
                    <div class="chapter-content">
                        
<p>Many apps require to send email for various purposes. Rather than
configure each such container with your secret mail credentials, you
can configure a single central mail forwarding service with
<a href="https://github.com/EnigmaCurry/d.rymcg.tech/tree/master/postfix-relay#readme" rel="external" target="_blank">postfix-relay</a>.</p>

<pre class="mermaid align-center ">
---
title: Authorized container networks may bridge with the Postfix-Relay to send outgoing email.
---
graph TD;
subgraph Docker network
    A[Container A] --&gt;|private mail-only network| D[Postfix-Relay]
    B[Container B] --&gt;|private mail-only network| D[Postfix-Relay]
    C[Container C] -.- F[Blocked]
end
D --&gt;|Internet| E[Public  SMTP server]
E --&gt; G[Allowed Email recipient]
E --&gt; H[Allowed Email recipient]
E -.- I[Blocked Email recipient]
</pre>
<h2 id="register-the-upstream-smtp-service">Register the upstream SMTP service</h2>
<p>You will need access to a public email (SMTP) service for outgoing
mail. Gather the following information from your provider:</p>
<ul>
<li>The SMTP server domain, e.g., <code>mail.example.com</code>.</li>
<li>The port, e.g., <code>465</code> (TLS) or <code>587</code> (STARTTLS).</li>
<li>The username, e.g., <code>me@example.com</code>.</li>
<li>The password, e.g., <code>hunter2</code>.</li>
</ul>
<h2 id="configure-postfix-relay">Configure Postfix-Relay</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make postfix-relay config
</pre></code>
    </div>
</div>


<p>Enter the domain name for this postfix instance:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
POSTFIX_RELAY_TRAEFIK_HOST: Enter the domain name for this instance

: smtp.d.example.com
</pre>
    </div>
</div>

<p>Enter the upstream SMTP server connection details:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
POSTFIX_RELAY_RELAYHOST: Enter the outgoing SMTP server domain:port (eg. smtp.example.com:587)

: mail.example.com:465

POSTFIX_RELAY_RELAYHOST_USERNAME: Enter the outgoing SMTP server username

: username@example.com

POSTFIX_RELAY_RELAYHOST_PASSWORD: Enter the outgoing SMTP server password

: xxxxxxxxxxxxxxxxxxxx
</pre>
    </div>
</div>

<p>Select which network subdomains should be masked at the root domain
(this is optional, and can be used to hide private subdomains from the
email headers):</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
POSTFIX_RELAY_MASQUERADED_DOMAINS: Enter the root domains (separated by space) that should mask its sub-domains

: example.com example.org
</pre>
    </div>
</div>

<h2 id="install">Install</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make postfix-relay install
</pre></code>
    </div>
</div>


<h2 id="test-sending-mail">Test sending mail</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
(
RECIPIENT="recipient@example.com"
SENDER="root@localhost"
SUBJECT="Test Email"
BODY="This is a test email sent from Docker."

docker run --rm \
  --network postfix-relay_default \
  -e RECIPIENT="$RECIPIENT" \
  -e SENDER="$SENDER" \
  -e SUBJECT="$SUBJECT" \
  -e BODY="$BODY" \
  alpine sh -c 'apk add --no-cache msmtp && \
  echo -e "Subject: $SUBJECT\n\n$BODY" | \
  msmtp --from="$SENDER" \
        --host=postfix-relay-postfix-relay-1 \
        --port=587 \
        --tls=off \
        --tls-starttls=off \
        "$RECIPIENT" && \
        echo "Email sent" || \
        echo "Email failed to send"'
)
</pre></code>
    </div>
</div>



                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000650-step-ca">Step-CA (mutual TLS)</h1>
                    <div class="chapter-content">
                        
<p>Mutual TLS (mTLS) is a form of transport security where both the
client and server authenticate each other using digital certificates.
Unlike traditional TLS (e.g., Let&rsquo;s Encrypt), where only the server&rsquo;s
identity is verified, mTLS provides mutual verification of the server
and client, making it ideal for protecting data exchanges in
interconnected environments like microservices and zero-trust
architectures. By using certificates issued by trusted Certificate
Authorities (CA), mTLS prevents unauthorized access and guarantees
that both parties using a communication channel are legitimate.</p>
<figure><img src="/img/portable-docker/treasure-map.webp"/>
</figure>

<p><a href="https://smallstep.com/docs/step-ca/" rel="external" target="_blank">Step-CA</a> is an open source Certificate Authority (CA) and an Automated
Certificate Management Enviornment (ACME). You can self-host Step-CA
and use it to add secure mTLS authentication in all of your
applications and infrastructure.</p>

<div class="box notices cstyle primary">
  <div class="box-label">Info</div>
  <div class="box-content">

<p>This chapter is focused soley on enhancing client authentication with
mTLS, but it still uses the Let&rsquo;s Encrypt CA for the server
certificates. If you don&rsquo;t want to rely upon Let&rsquo;s Encrypt, and you
want to run a fully self-hosted Public Key Infrastructure (PKI) for
all of your services, please see the appendix chapter <a href="/portable-docker/appendix/private-acme/">Private ACME</a>.</p>
<p>Although primarily used for machine-to-machine communication, mTLS can
also be used in the web browser to provide strong end-user client
authentication, enhancing security for sensitive web applications.
This is an advanced topic, and will be discussed in the appendix
chapter <a href="/portable-docker/appendix/mutual-tls-for-web-and-mobile/">Mutual TLS for Web and Mobile</a>.</p>
</div>
</div>
<h2 id="configure-step-ca">Configure Step-CA</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make step-ca config
</pre></code>
    </div>
</div>


<p>Set the hostname for Step-CA itself:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
STEP_CA_TRAEFIK_HOST: Enter the step-ca domain name (eg. ca.example.com)

: ca.pi.example.com
</pre>
    </div>
</div>

<p>Set the allowed list of domains to create certificates for:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
STEP_CA_AUTHORITY_POLICY_X509_ALLOW_DNS: Enter the list of allowed domain wildcards (comma separated) (eg. *.example.com,*.example.org)

: *.clients.pi.example.com
</pre>
    </div>
</div>


<div class="box notices cstyle primary">
  <div class="box-label">Info</div>
  <div class="box-content">

<p>In an earlier chapter Traefik was setup with <a href="/portable-docker/set-up-raspberry-pi/install-traefik/#configure-acme">ACME</a>. All of the
server-side applications on your Raspberry Pi already have automatic
TLS certificates issued via <a href="https://letsencrypt.org/getting-started/" rel="external" target="_blank">Let&rsquo;s Encrypt</a>, which is a free and public
CA, therfore, in this example Step-CA will not be required for any
server-side certificates. Lets Encrypt does not support requesting
client certificates, so Step-CA will be required only to create and
verify the client-side certificates (<code>*.clients.pi.example.com</code>).</p>
<p>In this mode, mTLS authentication works like this:</p>
<ul>
<li>The server will verify the client&rsquo;s certificate using the Step-CA
authority, whose root certificate must be added to the server&rsquo;s
trust store during install.</li>
<li>The client will verify the server&rsquo;s certificate using the Let&rsquo;s
Encrypt authority, whose root certificate is already widely trusted
in most operating systems factory default settings, which
simplifies installation.</li>
</ul>
<pre class="mermaid align-center ">
---
title: Mutual TLS with two separate Certificate Authorities
---
graph TD
    StepCA[Step CA]
    LetsEncrypt[Let&#39;s Encrypt CA]
    Client --&gt;|Client sends Step-CA signed cert| Server
    Server --&gt;|Server sends Let&#39;s Encrypt signed cert| Client
    Client &lt;--&gt;|Issues cert| StepCA
    Server &lt;--&gt;|Issues cert| LetsEncrypt
</pre>
<p>Theoretically you could just use Step-CA for both sides, but this
would require modifying the root certificate store on every client,
which is a risky and complex procedure, and ultimately unnecessary because
Let&rsquo;s Encrypt is already commonly trusted by all operating systems and
browsers.</p>
</div>
</div>

<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>Each client certificate must have a unique name (CN) written in domain
name format (e.g., <code>foo.clients.pi.example.com</code>), but this does not
need to resolve to any IP address. Each certificate can have an
arbitrary name as long as it matches the Step-CA policy
(<code>STEP_CA_AUTHORITY_POLICY_X509_ALLOW_DNS</code>). The certificate name is
used as the transport authentication id (essentially used as a
username), and it is forwarded to your backend HTTP services through a
trusted header <code>X-Client-CN</code> for the purpose of secondary
authorization by the app itself.</p>
</div>
</div>
<h3 id="define-default-tls-certificate-expiration">Define default TLS certificate expiration</h3>
<p>By default, TLS certificates are valid for 7 days, and then must be
re-issued. You can customize the certificate durations in the config.
There are three limits defined:</p>
<ul>
<li><code>STEP_CA_AUTHORITY_CLAIMS_MIN_TLS_CERT_DURATION=5m</code> the minimum
duration a certificate may be requested for, 5 minutes by default.</li>
<li><code>STEP_CA_AUTHORITY_CLAIMS_MAX_TLS_CERT_DURATION=2160h</code> the maximum
duration a certificate may be requested for, 90 days be default.</li>
<li><code>STEP_CA_AUTHORITY_CLAIMS_DEFAULT_TLS_CERT_DURATION=168h</code> the
default duration a certificate will be issued for if the client
does not specify one, 7 days by default.</li>
</ul>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
## Increase the minimum duration to 1 day:
pi make step-ca reconfigure var=STEP_CA_AUTHORITY_CLAIMS_MIN_TLS_CERT_DURATION=24h

## Increase the maximum duration to 1 year:
pi make step-ca reconfigure var=STEP_CA_AUTHORITY_CLAIMS_MAX_TLS_CERT_DURATION=8760h

## Increase the default duration to 90 days:
pi make step-ca reconfigure var=STEP_CA_AUTHORITY_CLAIMS_DEFAULT_TLS_CERT_DURATION=2160h
</pre></code>
    </div>
</div>


<h2 id="install-step-ca">Install Step-CA</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make step-ca install wait
</pre></code>
    </div>
</div>


<h2 id="retrieve-the-admin-password">Retrieve the admin password</h2>
<p>The admin password is printed in the container logs only the first
time it starts. Retrieve it by running:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make step-ca logs-out | grep password
</pre></code>
    </div>
</div>



<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>Save this password to a safe place, you will need it everytime you
sign a new (non-ACME) certificate.</p>
</div>
</div>
<h2 id="finish-step-ca-configuration-by-restarting-the-service">Finish Step-CA configuration by restarting the service</h2>

<div class="box notices cstyle primary">
  <div class="box-label">Important</div>
  <div class="box-content">

<p>After installation, you must restart Step-CA one more time to finish
the setup procedure. This will finalize the configuration in
<code>/home/step/config/ca.json</code>.</p>
<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
## Re-install forces the service to restart:
pi make step-ca reinstall
</pre></code>
    </div>
</div>
<p>This also has a side effect of clearing the admin password from the
logs, hope you saved it!</p>
</div>
</div>
<h2 id="retrieve-the-server-ca-cert-fingerprint">Retrieve the server CA cert fingerprint:</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make step-ca inspect-fingerprint
</pre></code>
    </div>
</div>


<p>The fingerprint is the public identifier of the Step-CA root
certificate. Copy it into your clipboard for use in the next section.</p>
<h2 id="reconfigure-traefik">Reconfigure Traefik</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make traefik config
</pre></code>
    </div>
</div>


<h3 id="configure-traefik-for-mtls">Configure Traefik for mTLS</h3>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
  Traefik user
  Entrypoints (including dashboard)
> TLS certificates and authorities
  Middleware (including sentry auth)
  Advanced Routing (Layer 7 / Layer 4 / Wireguard)
  Error page template
v Logging level

? Traefik TLS config:
> Configure certificate authorities (CA)
  Configure ACME (Let's Encrypt or Step-CA)
  Configure TLS certificates (make certs)

? How do you want to configure the list of trusted Certificate Authorities (CA)?
  Use the stock list, (alpine: ca-certificates ca-certificates-bundle).
> Use the stock list, plus add my own root Step-CA certificate.
  Delete the entire list, and add my own root Step-CA certificate.
  Delete the entire list.
  Cancel / Go back.
</pre>
    </div>
</div>

<p>Enter the Step-CA endpoint URL:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
TRAEFIK_STEP_CA_ENDPOINT: Enter your Step-CA endpoint URL (eg. https://ca.example.com)

: https://ca.pi.example.com
</pre>
    </div>
</div>

<p>You will need to paste the fingerprint you copied from the last
section into the answer for the next question:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
TRAEFIK_STEP_CA_FINGERPRINT: Enter your Step-CA root CA certificate
fingerprint (eg. xxxxxxxxxxxxxxxxxxxx)

: xxxxxxxxxxxxxxxxxxxxxxxxxxxx
</pre>
    </div>
</div>

<p>Press <code>ESC</code> two times to go back to the main menu, then re-install
Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>After installation, press <code>ESC</code> to quit the config tool.</p>
<h2 id="add-a-new-route-on-the-sentry">Add a new route on the sentry</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
> Advanced Routing (Layer 7 / Layer 4 / WireGuard)
  Error page template
  Logging level
  Access logs

? Traefik routes
> Configure layer 7 TLS proxy
  Configure layer 4 TCP/UDP proxy
  Configure wireguard VPN

? Layer 7 TLS Proxy:
  List layer 7 ingress routes
> Add new layer 7 ingress route
  Remove layer 7 ingress routes
  Disable layer 7 TLS Proxy

Enter the public domain (SNI) for the route:

: ca.pi.example.com

Enter the destination IP address to forward to:

: 10.13.16.2

Enter the destination TCP port to forward to:

: 443

> Do you want to enable Proxy Protocol for this route? Yes

## Layer 7 TLS Proxy is ENABLED.
## Configured Layer 7 Routes:
Entrypoint         Destination_address  Destination_port  Proxy_protocol
----------         -------------------  ----------------  --------------
ca.pi.example.com  10.13.16.2           443               2
</pre>
    </div>
</div>

<p>Press <code>ESC</code> three times to go back to the main menu, and re-install Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>After installation, press <code>ESC</code> to quit the config tool.</p>
<h2 id="log-in-with-the-step-cli-client">Log in with the step-cli client</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make step-ca client-bootstrap
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
The root certificate has been saved in /home/pi/.step/certs/root_ca.crt.
The authority configuration has been saved in /home/pi/.step/config/defaults.json.
</pre>
    </div>
</div>

<h2 id="create-certificates">Create certificates</h2>
<p>Do this anytime you wish to create a new client certificate:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make step-ca cert
</pre></code>
    </div>
</div>


<p>Enter the client certificate name (CN):</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Enter the subject (CN) to be certified, a domain name, or a client name

: foo.clients.pi.example.com
</pre>
    </div>
</div>

<p>When signing certificates, you need to enter the step-ca root admin
passphrase, and then the certificates will be signed:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Please enter the password to decrypt the provisioner key: xxxxx

 Provisioner: admin (JWK)
 Certificate: certs/foo.clients.pi.example.com.crt
 Private Key: certs/foo.clients.pi.example.com.key
</pre>
    </div>
</div>


<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div>
  <div class="box-content">

<p>The next question asks you to set a temporary passphrase to encrypt
the <code>.p12</code> formatted client key.</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Please enter a password to encrypt the .p12 file:
</pre>
    </div>
</div>
<p><strong>The <code>p12</code> password should NOT be the same as the root CA password! It
should be a separate password that you will share with the end user,
so that they can unlock the certificate you are giving them.</strong></p>
</div>
</div>
<p>Finally you will see some details printed about the issued
certificate.</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Certificate:
    Data:
       .....
        Validity
            Not Before: Oct 19 17:51:27 2024 UTC
            Not After : Oct 26 17:52:27 2024 UTC
        Subject: CN=foo.clients.pi.example.com
</pre>
    </div>
</div>

<p>The client certificate <code>foo</code> has been written to the <code>step-ca/certs</code>
directory (.e.g.,
<code>~/git/vendor/enigmacurry/d.rymcg.tech/step-ca/certs</code>.)</p>
<ul>
<li><code>foo.clients.pi.example.com.crt</code> This is the public
certificate for the <code>foo</code> client.</li>
<li><code>foo.clients.pi.example.com.key</code> This is the private key
for the <code>foo</code> certificate. <strong>This file is unencrypted</strong>.</li>
<li><code>foo.clients.pi.example.com.p12</code> This is also the private
key for the <code>foo</code> certificate written in a different format that is
used on some devices, this file is encrypted with the temporary
passphrase you chose and needs to be provided to the client when
installing the certificate.</li>
</ul>
<h2 id="configure-apps-for-mtls">Configure apps for mTLS</h2>
<p>For demo purposes, enable mTLS for the <code>whoami</code> service:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make whoami config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
WHOAMI_TRAEFIK_HOST: Enter the whoami domain name (eg. whoami.example.com)

: whoami.pi.example.com

? Do you want to enable sentry authorization in front of this app (effectively making the entire site private)?
  No
  Yes, with HTTP Basic Authentication
  Yes, with Oauth2
> Yes, with Mutual TLS (mTLS)

WHOAMI_MTLS_AUTHORIZED_CERTS: Enter comma separated list of allowed client certificate names (or blank to allow all) (eg. *.clients.whoami.example.com)

: *.clients.pi.example.com
</pre>
    </div>
</div>


<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>Make sure to enter the same authorized cert wildcard that matches your
client certificate, otherwise you will encounter the error <code>No matching DNS names.</code></p>
</div>
</div>
<p>Re-install whoami:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make whoami install
</pre></code>
    </div>
</div>


<p>Test the service without specifying a certificate:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
curl https://whoami.pi.example.com
</pre></code>
    </div>
</div>


<p>You should now receive one of the following errors, both indicating
that a client certificate is required:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
curl: (56) OpenSSL SSL_read: OpenSSL/3.0.14: error:0A00045C:SSL routines::tlsv13 alert certificate required, errno 0
curl: (55) getpeername() failed with errno 107: Transport endpoint is not connected
</pre>
    </div>
</div>

<p>Now test it with your client certificate:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
(
NAME=foo.clients.pi.example.com
CERTS=~/git/vendor/enigmacurry/d.rymcg.tech/step-ca/certs

curl https://whoami.pi.example.com \
--cert ${CERTS}/${NAME}.crt \
--key ${CERTS}/${NAME}.key
)
</pre></code>
    </div>
</div>


<p>With the correctly supplied certificate and key, the server now
resolves to the whoami response:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Name: default
Hostname: 427db0a29c30
IP: 127.0.0.1
IP: ::1
IP: 172.19.0.2
RemoteAddr: 172.19.0.1:45068
GET / HTTP/1.1
Host: whoami.pi.example.com
User-Agent: curl/7.88.1
Accept: */*
Accept-Encoding: gzip
X-Client-Cn: CN=foo.clients.pi.example.com
X-Forwarded-For: 127.0.0.1
X-Forwarded-Host: whoami.pi.example.com
X-Forwarded-Port: 443
X-Forwarded-Proto: https
X-Forwarded-Server: pi5
X-Forwarded-User: CN=foo.clients.pi.example.com
X-Real-Ip: 127.0.0.1
</pre>
    </div>
</div>

<p>Notice that there are two headers sent to the whoami backend:</p>
<ul>
<li><code>X-Client-Cn</code></li>
<li><code>X-Forwarded-User</code></li>
</ul>
<p>These two headers contain the same information, identifying the client
cert id to the backend server. Either of these may be used for
secondary authorization in your app.</p>
<h2 id="next-steps">Next steps</h2>
<ul>
<li>Install apps.</li>
</ul>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="000660-docker-registry">Docker Registry</h1>
                    <div class="chapter-content">
                        
<figure><img src="/img/portable-docker/registry.webp"/>
</figure>

<p>A Docker registry is a service for storing and distributing Docker
images (OCI images). Public registries like <a href="https://hub.docker.com/" rel="external" target="_blank">Docker
Hub</a> are common, but private registries offer
more control and security. By using a registry, you can version
images, enforce access policies, and simplify deployment, making it a
key part of your infrastructure.</p>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="007100-immich">Immich</h1>
                    <div class="chapter-content">
                        
<p><a href="https://immich.app/" rel="external" target="_blank">Immich</a> is an open-source self-hosted photo and video management
solution.</p>
<figure><img src="/img/portable-docker/immich-gallery.webp"/>
</figure>

<h2 id="configure-immich">Configure Immich</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make immich config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
IMMICH_TRAEFIK_HOST: Enter the Immich domain name (e.g., immich.example.com)

: immich.pi.example.com

? Do you want to enable sentry authorization in front of this app (effectively making the entire site private)?
> No
  Yes, with HTTP Basic Authentication
  Yes, with Oauth2
  Yes, with Mutual TLS (mTLS)

? Select the hardware acceleration to use for machine learning
> CPU
  ...

? Select the hardware acceleration to use for transcoding
> CPU
  ...

? Select whether you want Immich to upload images to a bind mount on the host or to a named Docker volume
  bind mount
> Docker volume
</pre>
    </div>
</div>



<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make immich install wait
</pre></code>
    </div>
</div>


<p>Wait for the services to start and report themselves as healthy:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Waiting until all services are started and become healthy ...
All services healthy.
</pre>
    </div>
</div>

<h2 id="add-a-new-route-on-the-sentry">Add a new route on the sentry</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
> Advanced Routing (Layer 7 / Layer 4 / WireGuard)
  Error page template
  Logging level
  Access logs

? Traefik routes
> Configure layer 7 TLS proxy
  Configure layer 4 TCP/UDP proxy
  Configure wireguard VPN

? Layer 7 TLS Proxy:
  List layer 7 ingress routes
> Add new layer 7 ingress route
  Remove layer 7 ingress routes
  Disable layer 7 TLS Proxy

Enter the public domain (SNI) for the route:

: immich.pi.example.com

Enter the destination IP address to forward to:

: 10.13.16.2

Enter the destination TCP port to forward to:

: 443

> Do you want to enable Proxy Protocol for this route? Yes

## Layer 7 TLS Proxy is ENABLED.
## Configured Layer 7 Routes:
Entrypoint              Destination_address  Destination_port  Proxy_protocol
----------              -------------------  ----------------  --------------
immich.pi.example.com  10.13.16.2           443               2
whoami.pi.example.com  10.13.16.2           443               2
</pre>
    </div>
</div>

<p>Press <code>ESC</code> three times to go back to the main menu, and re-install Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>After installation, press <code>ESC</code> to quit the config tool.</p>
<h2 id="finish">Finish</h2>
<p>The app is now deployed at the URL you configured: <code>https://immich.pi.example.com</code></p>

<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Immediately secure the admin account</div>
  <div class="box-content">

<p>You should immediately open the URL in your web browser:
<code>https://immich.pi.example.com</code> and complete the initial
configuration to secure the admin user account.</p>
</div>
</div>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="007200-sftp">SFTP (and Thttpd)</h1>
                    <div class="chapter-content">
                        
<p><a href="https://www.rfc-editor.org/rfc/rfc4253" rel="external" target="_blank">SFTP</a> (SSH File Transfer Protocol) is a standard and secure method of
transferring files. There are clients available for all platforms. You
can configure an SFTP server to send and receive files directly with
your Docker volumes.</p>
<h2 id="install-a-demo-web-server--thttpd">Install a demo web server (thttpd)</h2>
<p><a href="https://www.acme.com/software/thttpd/" rel="external" target="_blank">Thttpd</a> is a tiny static HTTP server for hosting websites. It will be
used for demonstration purposes in showing the effect of transferring
files directly into its volume, via SFTP. You can substitute this with
<a href="/portable-docker/install-web-services/nginx-and-php/">Nginx</a> if you prefer. This same approach will work with any Docker
volume.</p>

<pre class="mermaid align-center ">
---
title: SFTP and Thttpd share the same volume
---
graph TD;
B[Web browser] --|internet|--&gt; C
D[SFTP client] --|internet|--&gt; A
subgraph Docker network
    C[Thttpd container] --|volume link|--&gt; V((volume: \nthttpd_files))
    A[SFTP container] --|volume link|--&gt; V((volume: \nthttpd_files))
end
</pre>
<h3 id="configure-thttpd">Configure thttpd</h3>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make thttpd config
</pre></code>
    </div>
</div>


<p>Thttpd will serve a website at a URL of your choosing:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
THTTPD_TRAEFIK_HOST: Enter the website domain name (eg. thttpd.example.com)

: www.pi.example.com

? Do you want to enable sentry authorization in front of this app (effectively making the entire site private)?
> No
  Yes, with HTTP Basic Authentication
  Yes, with Oauth2
  Yes, with Mutual TLS (mTLS)
</pre>
    </div>
</div>

<p>Install thttpd:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make thttpd install
</pre></code>
    </div>
</div>


<h3 id="configure-the-thttpd-route-on-the-sentry">Configure the thttpd route on the sentry</h3>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
> Advanced Routing (Layer 7 / Layer 4 / Wireguard)
  Error page template
  Logging level
  Access logs

? Traefik routes
> Configure layer 7 TLS proxy
  Configure layer 4 TCP/UDP proxy
  Configure wireguard VPN

? Layer 7 TLS Proxy:
  List layer 7 ingress routes
> Add new layer 7 ingress route
  Remove layer 7 ingress routes
  Disable layer 7 TLS Proxy

Enter the public domain (SNI) for the route:

: www.pi.example.com

Enter the destination IP address to forward to:

: 10.13.16.2

Enter the destination TCP port to forward to:

: 443

> Do you want to enable Proxy Protocol for this route? Yes
</pre>
    </div>
</div>

<p>Press <code>ESC</code> three times to go back to the main menu, then re-install Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>Once re-installed, press <code>ESC</code> to quit the config tool.</p>
<h3 id="open-the-website-in-your-browser">Open the website in your browser</h3>
<ul>
<li>Open <code>https://www.pi.example.com</code> in your web browser.</li>
<li>Because there are no files uploaded yet, the page will show only an
index:</li>
</ul>
<figure><img src="/img/portable-docker/thttpd-index.webp"/>
</figure>

<h2 id="configure-sftp">Configure SFTP</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make sftp config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
SFTP_PORT: Enter the public SSH port (eg. 2223)

: 2223

SFTP_USERS: Enter the user:uid list (eg. ryan:1000,gary:1001)

: www:54321
</pre>
    </div>
</div>


<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Use the same UID as thttpd</div>
  <div class="box-content">

<p>The thttpd container has a user with UID <code>54321</code>, so the SFTP user
(<code>www</code>) has to have the same UID <code>54321</code>.</p>
</div>
</div>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
SFTP_VOLUMES: Enter the volume:user:mount list (can be blank)

: thttpd_files:www:public_html
</pre>
    </div>
</div>


<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> SFTP_VOLUMES</div>
  <div class="box-content">

<p>The <code>SFTP_VOLUMES</code> setting is a list of 3-tuple separated by the
character <code>:</code></p>
<ol>
<li>The Docker volume to mount (e.g., <code>thttpd_files</code>)</li>
<li>The SFTP user that should own the mountpoint (e.g., <code>www</code>.)</li>
<li>An arbitrary mount point sub-directory, only visible to the SFTP
user</li>
</ol>
<p>In the example above, the Docker volume named <code>thttpd_files</code> is
mounted inside the <code>www</code> user&rsquo;s SFTP home directory, in a
sub-directory named <code>public_html</code>.</p>
<p>The user may have access to multiple volumes, each with a different
mount point. Additional volumes may be mounted as a comma separated
list of 3-tuples:</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>thttpd_files:www:public_html,other_volume:www:other_files</span></span></code></pre></div><p>If mounting multiple volumes under one SFTP user, all volume files
must share the same owner. If the files require different ownership,
you must use different SFTP users.</p>
</div>
</div>
<p>Install sftp:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make sftp install
</pre></code>
    </div>
</div>


<h2 id="enable-sftp-traffic">Enable SFTP traffic</h2>
<h3 id="enable-the-sftp-entrypoint-on-the-sentry">Enable the SFTP entrypoint on the sentry</h3>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
  Traefik user
> Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
  Advanced Routing (Layer 7 / Layer 4 / Wireguard)
  Error page template
v Logging level

? Traefik entrypoint config
  Show enabled entrypoints
  Configure stock entrypoints
> Configure custom entrypoints

? Custom Entrypoints:
  List custom entrypoints
> Add new custom entrypoint
  Remove custom entrypoints

Enter the new entrypoint name:

: sftp

Enter the entrypoint listen address:

: 0.0.0.0

Enter the entrypoint port:

: 2223

Enter the protocol (tcp or udp):

: tcp

? Is this entrypoint downstream from another trusted proxy?
> No, clients dial directly to this server. (Turn off Proxy Protocol)
  Yes, clients are proxied through another trusted proxy. (Turn on Proxoy Protocol)
</pre>
    </div>
</div>


<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Do not enable Proxy Protocol</div>
  <div class="box-content">

<p>SSH does not support <a href="https://www.haproxy.org/download/2.0/doc/proxy-protocol.txt" rel="external" target="_blank">Proxy Protocol</a>, so be sure to disable it.</p>
</div>
</div>
<p>Press <code>ESC</code> three times to go back to the main menu.</p>
<h3 id="create-the-sftp-route-on-the-sentry">Create the SFTP route on the sentry</h3>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
> Advanced Routing (Layer 7 / Layer 4 / Wireguard)
  Error page template
  Logging level
  Access logs

? Traefik routes
  Configure layer 7 TLS proxy
> Configure layer 4 TCP/UDP proxy
  Configure wireguard VPN

? Layer 4 TCP/UDP Proxy:
  List layer 4 ingress routes
> Add new layer 4 ingress route
  Remove layer 4 ingress routes
  Disable layer 4 TCP/UDP Proxy

? Entrypoint
> sftp

Enter the destination IP address to forward to:

: 10.13.16.2

Enter the destination TCP port to forward to:

: 2223

> Do you want to enable Proxy Protocol for this route? No
</pre>
    </div>
</div>


<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Do not enable Proxy Protocol</div>
  <div class="box-content">

<p>SSH does not support <a href="https://www.haproxy.org/download/2.0/doc/proxy-protocol.txt" rel="external" target="_blank">Proxy Protocol</a>, so be sure to disable it.</p>
</div>
</div>
<p>Press <code>ESC</code> three times to go back to the main menu, then re-install Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>Once re-installed, press <code>ESC</code> to exit the config tool.</p>
<h2 id="authorize-your-client-s-ssh-public-key">Authorize your client&rsquo;s SSH public key</h2>
<p>Copy the contents of your SSH pubkey from your personal workstation to
your clipboard:</p>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
## Your key may be in a different location
cat ~/.ssh/id_ed25519.pub
</pre></code>
    </div>
</div>


<p>Authorize the key to access the server:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make sftp ssh-authorize-key
</pre></code>
    </div>
</div>


<p>Enter the information at the prompt:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Which SSH username do you want to add a key for? : www
Enter the SSH public key : xxxxxxxxxxxxxxxxxxxxxxxxxxxx
</pre>
    </div>
</div>

<ul>
<li>Enter the SSH username (e.g., <code>www</code>.)</li>
<li>Paste the SSH key from your clipboard, then press <code>Enter</code>.</li>
</ul>
<p>If you want to authorize multiple keys, repeat the last step. (If you
want to remove all the authorized keys for a user, run <code>pi make sftp ssh-clear-id</code> and it will prompt for you to enter the username.)</p>
<h2 id="configure-your-personal-workstation-as-a-client">Configure your personal workstation as a client</h2>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
cat &lt;&lt;EOF &gt&gt ~/.ssh/config
Host sftp.pi.example.com
    User www
    Port 2223
    ControlMaster auto
    ControlPersist yes
    ControlPath /tmp/ssh-%u-%r@%h:%p
EOF
</pre></code>
    </div>
</div>


<p>Test connecting:</p>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
sftp sftp.pi.example.com
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
The authenticity of host '[sftp.pi.example.com]:2223 ([X.X.X.X]:2223)' can't be established.
ED25519 key fingerprint is SHA256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.
This key is not known by any other names.

Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
</pre>
    </div>
</div>

<p>If connected successfully, you should see the <code>sftp&gt;</code> prompt. Type
<code>ls</code> and you should see the <code>public_html</code> sub-directory listed:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
sftp> ls
public_html
</pre>
    </div>
</div>

<p>Press <code>Ctrl-D</code> to quit.</p>
<h2 id="test-uploading-a-new-index-dot-html-to-thttpd-volume">Test uploading a new index.html to thttpd volume</h2>
<p>Create a temporary test folder on your personal workstation and create
an index.html file:</p>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
cd $(mktemp -d)
echo '&lt;h1&gt;Hello, World!&lt;/h1&gt;' > index.html
</pre></code>
    </div>
</div>


<p>Copy the files to the server into the <code>public_html</code> folder:</p>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
scp index.html sftp.pi.example.com:public_html/
</pre></code>
    </div>
</div>


<h3 id="refresh-the-website-in-your-browser">Refresh the website in your browser</h3>
<p>The new page should now be public (e.g., <code>https://www.pi.example.com</code>):</p>
<figure><img src="/img/portable-docker/thttpd-hello-world.webp"/>
</figure>

<h2 id="use-rclone-to-synchronize-whole-directories-to-sftp">Use Rclone to synchronize whole directories to SFTP</h2>
<p>Unfortunately, the traditional tool <a href="https://man.archlinux.org/man/rsync.1" rel="external" target="_blank">rsync</a> only works with SSH, not
SFTP. An alternative tool named <a href="https://rclone.org/" rel="external" target="_blank">Rclone</a> can be used in place of it.</p>
<ul>
<li>On your personal workstation, install <code>rclone</code> via your package
manager (preferred) or <a href="https://rclone.org/install/" rel="external" target="_blank">from the
official site</a>.</li>
</ul>
<h3 id="create-rclone-config-file">Create rclone config file</h3>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
mkdir -p ~/.config/rclone

cat &lt;&lt;EOF &gt;&gt; ~/.config/rclone/rclone.conf
[pi]
type = sftp
host = pi.example.com
user = www
port = 2223
EOF
</pre></code>
    </div>
</div>


<h3 id="how-to-use-rclone">How to use rclone</h3>
<p>Read the <a href="https://rclone.org/docs/" rel="external" target="_blank">rclone docs</a> for comprehensive usage information.</p>
<h4 id="list-all-the-remote-files">List all the remote files</h4>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
rclone ls pi:
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
2 public_html/.gitignore
23 public_html/index.html
</pre>
    </div>
</div>

<h4 id="syncronize-a-local-directory-to-the-remote-public-html-folder">Syncronize a local directory to the remote public_html folder</h4>
<p>Sync the current directory ( . ):</p>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
## dangerous:
rclone -v sync . pi:public_html/
</pre></code>
    </div>
</div>



<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div>
  <div class="box-content">

<p>This is a potentially destructive command: it makes the remote
directory <em>exactly</em> like your local directory. <strong>All existing files in
the remote destination directory are deleted if they do not exist
locally</strong>.</p>
</div>
</div>

<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>It is recommended to create an alias so that you don&rsquo;t fat-finger the
<code>sync</code> command. For example, setup your local web root in your home
directory <code>~/public_html</code>:</p>
<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
mkdir -p ~/public_html
</pre></code>
    </div>
</div>
<p>Next create this alias in your <code>~/.bashrc</code> file:</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>alias sync-web=&#34;rclone -v sync ~/public_html pi:public_html/&#34;</span></span></code></pre></div><p>Then run the alias whenever you want to sync your local website to the
remote public site:</p>
<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
sync-web
</pre></code>
    </div>
</div>
</div>
</div>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="007210-minio-s3">MinIO S3 (and Filestash)</h1>
                    <div class="chapter-content">
                        
<p><a href="https://en.wikipedia.org/wiki/Amazon_S3" rel="external" target="_blank">S3</a> is a storage API first implemented at Amazon AWS, but has since
been copied and re-implemented as open source <a href="https://github.com/minio/minio" rel="external" target="_blank">MinIO</a>. MinIO is a
service you can install to centrally store files in your network via
the S3 API. With a web frontend like <a href="https://github.com/mickael-kerjean/filestash" rel="external" target="_blank">Filestash</a>, you can host a file
manager webapp for easy file sharing.</p>
<figure><img src="/img/portable-docker/filestash-window.webp"/>
</figure>


<pre class="mermaid align-center ">
graph LR;
    Browser[Web Browser\nFileStash UI] --&gt;|HTTP request for app page| FileStash
    Browser --&gt;|API request for object data| Minio

subgraph Docker
    FileStash[FileStash\nWWW]
    Minio((Minio S3\nObject store))
end
</pre>

<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>Running MinIO on a single Raspberry Pi is perfect for personal use.
However, for heavier production use, you will need to plan to use
beefier hardware with redundant storage.</p>
</div>
</div>
<h2 id="configure-minio">Configure MinIO</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make minio config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
MINIO_TRAEFIK_HOST: Enter the minio domain name (eg. s3.example.com)

: s3.pi.example.com

MINIO_CONSOLE_TRAEFIK_HOST: Enter the minio console domain name (eg. console.s3.example.com)

: s3-console.pi.example.com

MINIO_SITE_REGION: Enter the self-described region of the server (eg. default)

: default

MINIO_ROOT_USER: Enter the minio root username (eg. root)

: root

? Do you want to enable sentry authorization in front of this app (effectively making the entire site private)?
> No
  Yes, with Mutual TLS (mTLS)
</pre>
    </div>
</div>

<h2 id="enable-admin-console--optional">Enable admin console (optional)</h2>
<p>The admin console is optional and it is blocked by default. If you
want to access the console, you must unblock it, by providing your
client IP address:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
## Unblock the console for your specific IP address:
pi make minio reconfigure var=CONSOLE_SOURCERANGE=X.X.X.X/32
</pre></code>
    </div>
</div>



<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>To allow any IP address access to the minio console use <code>0.0.0.0/0</code>:</p>
<div class="box notices cstyle run">
    <div class="box-label other">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
## To unblock the console for any IP address:
pi make minio reconfigure var=CONSOLE_SOURCERANGE=0.0.0.0/0
</pre></code>
    </div>
</div>
<p>Once installed, the console will be accessible at
<code>https://s3-console.pi.example.com</code>. You will need to enter the
username (<code>root</code>) and the password can be retrieved from the
<code>.env_{CONTEXT}_{INSTANCE}</code> file:</p>
<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
## To retrieve the minio console root password:
pi make minio dotenv_get var=MINIO_ROOT_PASSWORD
</pre></code>
    </div>
</div>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
XxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXx
</pre>
    </div>
</div>
</div>
</div>
<h2 id="install-minio">Install MinIO</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make minio install wait
</pre></code>
    </div>
</div>


<h2 id="add-two-new-routes-on-the-sentry">Add two new routes on the sentry</h2>
<p>Create a route for S3 and the console:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
> Advanced Routing (Layer 7 / Layer 4 / WireGuard)
  Error page template
  Logging level
  Access logs

? Traefik routes
> Configure layer 7 TLS proxy
  Configure layer 4 TCP/UDP proxy
  Configure wireguard VPN

? Layer 7 TLS Proxy:
  List layer 7 ingress routes
> Add new layer 7 ingress route
  Remove layer 7 ingress routes
  Disable layer 7 TLS Proxy

Enter the public domain (SNI) for the route:

: s3.pi.example.com

Enter the destination IP address to forward to:

: 10.13.16.2

Enter the destination TCP port to forward to:

: 443

> Do you want to enable Proxy Protocol for this route? Yes

## Layer 7 TLS Proxy is ENABLED.
## Configured Layer 7 Routes:
Entrypoint         Destination_address  Destination_port  Proxy_protocol
----------         -------------------  ----------------  --------------
s3.pi.example.com  10.13.16.2           443               2

? Layer 7 TLS Proxy:
  List layer 7 ingress routes
> Add new layer 7 ingress route
  Remove layer 7 ingress routes
  Disable layer 7 TLS Proxy

Enter the public domain (SNI) for the route:

: s3-console.pi.example.com

Enter the destination IP address to forward to:

: 10.13.16.2

Enter the destination TCP port to forward to:

: 443

> Do you want to enable Proxy Protocol for this route? Yes

## Layer 7 TLS Proxy is ENABLED.
## Configured Layer 7 Routes:
Entrypoint                 Destination_address  Destination_port  Proxy_protocol
----------                 -------------------  ----------------  --------------
s3.pi.example.com          10.13.16.2           443               2
s3-console.pi.example.com  10.13.16.2           443               2
</pre>
    </div>
</div>

<p>Press <code>ESC</code> three times to go back to the main menu, and re-install Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>After installation, press <code>ESC</code> to quit the config tool.</p>
<h2 id="create-an-s3-bucket-and-credentials">Create an S3 bucket and credentials</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make minio bucket
</pre></code>
    </div>
</div>


<p>Create the bucket name: <code>demo</code> and then leave the policy, group, and
username blank to use the same value:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Enter a new bucket name (test): demo
Enter a new policy name (demo):
Enter a new group name (demo):
Enter a new user name (demo):
</pre>
    </div>
</div>

<p>This will create the bucket and the output the endpoint and access
credentials, which is all of the information necessary to provide
access:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Bucket: demo
Endpoint: s3.pi.example.com
Access Key: demo
Secret Key: XxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXx
</pre>
    </div>
</div>

<h2 id="configure-filestash-instance">Configure Filestash instance</h2>
<p>It is likely you will want several instances of filestash for
different buckets, so you you should configure them separately as
named instances:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
## Create an instance named test:

pi make filestash config instance=test
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
FILESTASH_TRAEFIK_HOST: Enter the filestash domain name (eg. filestash.example.com)

: filestash-test.pi.example.com

? Do you want to enable sentry authorization in front of this app (effectively making the entire site private)?
  No
  Yes, with HTTP Basic Authentication
> Yes, with Oauth2
  Yes, with Mutual TLS (mTLS)
</pre>
    </div>
</div>


<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div>
  <div class="box-content">

<p><strong>sentry authorization is a requirement</strong> as the S3 credentials are
stored in the filestash client (i.e., web browser), therefore you
should not allow anyone you do not trust with this information to
access the page.</p>
</div>
</div>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Which authorization group do you want to permit access to this app?
> admin
</pre>
    </div>
</div>


<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>This will allow only the <code>admin</code> authorization group to access this
instance.</p>
<p>Remember, you can create <a href="/portable-docker/install-core-services/traefik-forward-auth/#add-user-groups-for-sentry-authorization">extra authorization groups</a> in the Traefik
config, that way you can have separate user access per instance.</p>
</div>
</div>
<h2 id="install-the-filestash-instance">Install the Filestash instance</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
## Install the instance named test:

pi make filestash install instance=test
</pre></code>
    </div>
</div>



<div class="box notices cstyle primary">
  <div class="box-label">Info</div>
  <div class="box-content">

<p>The build process for filestash may take awhile, as it is built from
source code. This is because the <a href="https://hub.docker.com/r/machines/filestash/" rel="external" target="_blank">upstream images</a> were out of date for
ARM64.</p>
</div>
</div>
<h2 id="add-a-new-route-on-the-sentry">Add a new route on the sentry</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
> Advanced Routing (Layer 7 / Layer 4 / WireGuard)
  Error page template
  Logging level
  Access logs

? Traefik routes
> Configure layer 7 TLS proxy
  Configure layer 4 TCP/UDP proxy
  Configure wireguard VPN

? Layer 7 TLS Proxy:
  List layer 7 ingress routes
> Add new layer 7 ingress route
  Remove layer 7 ingress routes
  Disable layer 7 TLS Proxy

Enter the public domain (SNI) for the route:

: filestash-test.pi.example.com

Enter the destination IP address to forward to:

: 10.13.16.2

Enter the destination TCP port to forward to:

: 443

> Do you want to enable Proxy Protocol for this route? Yes

## Layer 7 TLS Proxy is ENABLED.
## Configured Layer 7 Routes:
Entrypoint                     Destination_address  Destination_port  Proxy_protocol
----------                     -------------------  ----------------  --------------
filestash-test.pi.example.com  10.13.16.2           443               2
</pre>
    </div>
</div>

<p>Press <code>ESC</code> three times to go back to the main menu, and re-install Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>After installation, press <code>ESC</code> to quit the config tool.</p>
<h2 id="open-filestash">Open Filestash</h2>
<p>Open the URL in your browser: <code>https://filestash-test.pi.example.com</code>.</p>
<ul>
<li>The initial page will ask you to create an admin password.</li>
</ul>
<h2 id="administer-filestash">Administer Filestash</h2>
<p>The admin page is only accessible from
<code>https://filestash-test.pi.example.com/admin/</code>, and it is here you
must configure the storage backend.</p>
<ul>
<li>Click <code>Backend</code> in the menu.</li>
<li>Remove every backend except for <code>S3</code>.</li>
<li>Do not select any authentication middleware.</li>
<li>Click the icon in the upper left to go to main page, or simply go
to <code>https://filestash-test.pi.example.com/</code>.</li>
</ul>
<p>On the main page, enter the credentials for the S3 connection:</p>
<ul>
<li>Click <code>Advanced</code></li>
<li>Enter the Access key ID</li>
<li>Enter the Secret Access Key</li>
<li>Enter the Endpoint</li>
<li>Leave the other options blank.</li>
</ul>
<figure><img src="/img/portable-docker/filestash-connect.webp"/>
</figure>

<ul>
<li>Click <code>Connect</code>.</li>
</ul>
<p>Once logged in you should see a single folder with the same name as
the bucket (<code>test</code>):</p>
<figure><img src="/img/portable-docker/filestash-folder.webp"/>
</figure>

<ul>
<li>Click the Share icon in the top right of the folder container.</li>
</ul>
<figure><img src="/img/portable-docker/filestash-share-link.webp"/>
</figure>

<ul>
<li>
<p>Choose the appropriate permission for the person you are sharing
with:</p>
<ul>
<li><code>Editor</code> has full access, download, upload, view, and delete.</li>
<li><code>Viewer</code> is read only.</li>
<li><code>Uploader</code> is write only (they won&rsquo;t be able to see any files,
not even the ones they upload.)</li>
</ul>
</li>
<li>
<p>Under <code>Advanced</code> settings, you may optionally set an expiration for
the link, or customize the link URL.</p>
</li>
<li>
<p>Do not set a password, as you can rely upon the sentry
authorization instead.</p>
</li>
<li>
<p>Copy the link, and share this link with your friends!</p>
</li>
<li>
<p>Try the link yourself in an Incognito browser window so that you
test it with no existing cookies. It should force you to login
through Forgejo first, and then once on the filestash page, test
the permissions you set are working.</p>
</li>
</ul>

<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>Because you enabled sentry authorization for this route, your friends
will also need to create Forgejo accounts, and you will need to add
them to the <a href="/portable-docker/install-core-services/traefik-forward-auth/#add-user-groups-for-sentry-authorization">sentry authorization group</a> in the Traefik config.</p>
</div>
</div>

<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>Create an admin link for yourself, so that you don&rsquo;t need to enter the
S3 credentials again, and you can create new share links too:</p>
<ul>
<li>Create a new share link like before.</li>
<li>Choose <code>Editor</code> privilege.</li>
<li>Click <code>Advanced</code>.</li>
<li>Click <code>Can Reshare</code>.</li>
</ul>
<figure><img src="/img/portable-docker/filestash-share-admin.webp"/>
</figure>
</div>
</div>
<h2 id="using-filestash">Using filestash</h2>
<ul>
<li>
<p>You can upload multiple files at a time by draging and dropping
them directly from your computer&rsquo;s file manager into the browser
window (FYI the dropzone is only near the top of the page).</p>
</li>
<li>
<p>Many media types are supported with rich viewers, including images,
audio, and video.</p>
</li>
</ul>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="007300-homepage">Homepage</h1>
                    <div class="chapter-content">
                        
<p><a href="https://gethomepage.dev/" rel="external" target="_blank">Homepage</a> is a customizable dashboard for all of your self-hosted apps
and services.</p>
<figure><img src="/img/portable-docker/homepage-dashboard.webp"/>
</figure>

<h2 id="configure-homepage">Configure Homepage</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make homepage config
</pre></code>
    </div>
</div>


<p>You need to configure two sub-domains, one for homepage itself, and
one for its webhooks:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
HOMEPAGE_TRAEFIK_HOST: Enter the homepage domain name (eg. homepage.example.com)

: homepage.pi.example.com

HOMEPAGE_WEBHOOK_HOST: Enter the separate webhook domain name (eg. homepage-webhook.example.com)

: homepage-webhook.pi.example.com
</pre>
    </div>
</div>

<p>It is recommended to enable some form of <a href="/install-core-services/traefik-forward-auth/">sentry authorization</a> to
protect homepage, e.g., with OAuth2:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Do you want to enable sentry authorization in front of this app (effectively making the entire site private)?
  No
  Yes, with HTTP Basic Authentication
> Yes, with Oauth2
  Yes, with Mutual TLS (mTLS)

? Which authorization group do you want to permit access to this app?
> admin
</pre>
    </div>
</div>


<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>This will allow only the <code>admin</code> authorization group to access this
instance.</p>
<p>Remember, you can create <a href="/portable-docker/install-core-services/traefik-forward-auth/#add-user-groups-for-sentry-authorization">extra authorization groups</a> in the Traefik
config, that way you can have separate user access per instance.</p>
</div>
</div>
<h3 id="homepage-auto-config">HOMEPAGE_AUTO_CONFIG</h3>
<p>Homepage has optional auto configuration:</p>
<ul>
<li>If <code>HOMEPAGE_AUTO_CONFIG=true</code>, homepage will create a template
automatically that will discover all of your existing services.</li>
<li>If <code>HOMEPAGE_AUTO_CONFIG=false</code>, homepage will clone a default
template from a git repository, or you may provide your own
repository via <code>HOMEPAGE_TEMPLATE_REPO</code>.</li>
</ul>
<p>For now, enable the auto-configuration:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Do you want to auto-configure Homepage and to discover all of your
running d.rymcg.tech apps of the current docker context? (Y/n) Yes
</pre>
    </div>
</div>

<h2 id="install-homepage">Install Homepage</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make homepage install wait
</pre></code>
    </div>
</div>


<h2 id="add-two-new-routes-on-the-sentry">Add two new routes on the sentry</h2>
<p>You need to create two routes: one for homepage, and one for the
webhooks:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
> Advanced Routing (Layer 7 / Layer 4 / WireGuard)
  Error page template
  Logging level
  Access logs

? Traefik routes
> Configure layer 7 TLS proxy
  Configure layer 4 TCP/UDP proxy
  Configure wireguard VPN

? Layer 7 TLS Proxy:
  List layer 7 ingress routes
> Add new layer 7 ingress route
  Remove layer 7 ingress routes
  Disable layer 7 TLS Proxy

Enter the public domain (SNI) for the route:

: homepage.pi.example.com

Enter the destination IP address to forward to:

: 10.13.16.2

Enter the destination TCP port to forward to:

: 443

> Do you want to enable Proxy Protocol for this route? Yes

## Layer 7 TLS Proxy is ENABLED.
## Configured Layer 7 Routes:
Entrypoint               Destination_address  Destination_port  Proxy_protocol
----------               -------------------  ----------------  --------------
homepage.pi.example.com  10.13.16.2           443               2

? Layer 7 TLS Proxy:
  List layer 7 ingress routes
> Add new layer 7 ingress route
  Remove layer 7 ingress routes
  Disable layer 7 TLS Proxy

Enter the public domain (SNI) for the route:

: homepage-webhooks.pi.example.com

Enter the destination IP address to forward to:

: 10.13.16.2

Enter the destination TCP port to forward to:

: 443

> Do you want to enable Proxy Protocol for this route? Yes

## Layer 7 TLS Proxy is ENABLED.
## Configured Layer 7 Routes:
Entrypoint                       Destination_address  Destination_port  Proxy_protocol
----------                       -------------------  ----------------  --------------
homepage.pi.example.com           10.13.16.2           443               2
homepage-webhooks.pi.example.com  10.13.16.2           443               2
</pre>
    </div>
</div>

<p>Press <code>ESC</code> three times to go back to the main menu, and re-install Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>After installation, press <code>ESC</code> to quit the config tool.</p>
<h2 id="open-homepage">Open Homepage</h2>
<p>Open <code>https://homepage.pi.example.com</code> in your web browser.</p>
<h2 id="redeploy-homepage-after-you-have-installed-new-services">Redeploy Homepage after you have installed new services</h2>
<p>The Homepage auto-config only happens at install time. If you install
or remove services, you should reinstall homepage to update the
dashboard:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make homepage install
</pre></code>
    </div>
</div>


<h2 id="customize-hompepage-template">Customize Hompepage template</h2>
<p>To customize your homepage template, you must set
<code>HOMEPAGE_AUTO_CONFIG=false</code> and provide <code>HOMEPAGE_TEMPLATE_REPO</code> in
the <code>.env_{CONTEXT}_{INSTANCE}</code> file:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make homepage reconfigure \
  var=HOMEPAGE_TEMPLATE_REPO=https://github.com/EnigmaCurry/d.rymcg.tech_homepage-template.git

pi make homepage reconfigure \
  var=HOMEPAGE_AUTO_CONFIG=false
</pre></code>
    </div>
</div>



<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>You can <a href="https://github.com/EnigmaCurry/d.rymcg.tech_homepage-template" rel="external" target="_blank">fork the default template repository</a> and provide your own
<code>HOMEPAGE_TEMPLATE_REPO</code> and it will automatically pull the
template from your URL.</p>
<p>If your template repository is not public, you must create a deploy key:</p>
<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make homepage git-deploy-key
</pre></code>
    </div>
</div>
<p>This will generate and save a new SSH key in the config volume
(<code>/app/config/ssh/id_rsa</code>). It will print out the public key, which
you need to copy and paste into your Forgejo, Github, or Gitlab
repository settings (Search for Deploy Key in the settings, and add
this public key to allow cloning from the private repository.)</p>
<figure><img src="/img/portable-docker/github-deploy-key.webp"/>
</figure>
</div>
</div>
<h2 id="reloading-webhook">Reloading webhook</h2>
<p>An optional feature when using a custom template repository
(<code>HOMEPAGE_TEMPLATE_REPO</code>) is you can send a webhook from your git
forge to your homepage instance, telling it to restart and pull the
changes automatically.</p>
<p>First you must enable <code>HOMEPAGE_TEMPLATE_REPO_SYNC_ON_START=true</code> in
the homepage <code>.env_{CONTEXT}_{INSTANCE}</code> file. Note that this setting
will delete your existing config everytime homepage restarts, and it
will redownload the template repository from scratch:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make homepage reconfigure \
  var=HOMEPAGE_TEMPLATE_REPO_SYNC_ON_START=true
</pre></code>
    </div>
</div>


<p>Next you must configure your Forgejo, Github, or Gitlab repository to
send the webhook on <code>git push</code> events:</p>
<ul>
<li>Webhook URL is of the format: <a href="https://homepage.example.com/reloader/restart" rel="external" target="_blank">https://homepage.example.com/reloader/restart</a></li>
<li>Choose the data type: <code>application/json</code></li>
<li>Webhook Secret is found in your <code>.env_{INSTANCE}_{CONTEXT}</code> as
<code>HOMEPAGE_RELOADER_HMAC_SECRET</code>. This secret is used to validate that
the request is actually coming from your git host.</li>
</ul>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make homepage dotenv_get \
  var=HOMEPAGE_RELOADER_HMAC_SECRET
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
xXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxX
</pre>
    </div>
</div>

<ul>
<li>No extra authorization header is required.</li>
</ul>
<figure><img src="/img/portable-docker/github-webhook.webp"/>
</figure>

<p>Finally, redeploy homepage:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make homepage install
</pre></code>
    </div>
</div>



                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="007400-yourls">Yourls</h1>
                    <div class="chapter-content">
                        
<p><a href="https://yourls.org/" rel="external" target="_blank">Yourls</a> is a URL shortener.</p>
<h2 id="configure-yourls">Configure Yourls</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make yourls config
</pre></code>
    </div>
</div>


<p>Follow the prompts to configure the domain name and admin user
authentication.</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
YOURLS_TRAEFIK_HOST: Enter the YOURLS domain name (e.g., yourls.example.com)

: yourls.pi.example.com

? Do you want to enable sentry authorization in front of this app (effectively making the entire site private)?
> No
  Yes, with HTTP Basic Authentication
  Yes, with Oauth2
  Yes, with Mutual TLS (mTLS)

YOURLS_USER: Enter the admin username for your YOURLS instance

: admin

YOURLS_PASS: Enter the password for 'admin'

: 528e0e36fc170
</pre>
    </div>
</div>

<p>Choose your own a secure passphrase!</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make yourls install wait
</pre></code>
    </div>
</div>


<p>Wait for the services to start and report themselves as healthy:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
Waiting until all services are started and become healthy ...
All services healthy.
</pre>
    </div>
</div>

<h2 id="add-a-new-route-on-the-sentry">Add a new route on the sentry</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
> Advanced Routing (Layer 7 / Layer 4 / WireGuard)
  Error page template
  Logging level
  Access logs

? Traefik routes
> Configure layer 7 TLS proxy
  Configure layer 4 TCP/UDP proxy
  Configure wireguard VPN

? Layer 7 TLS Proxy:
  List layer 7 ingress routes
> Add new layer 7 ingress route
  Remove layer 7 ingress routes
  Disable layer 7 TLS Proxy

Enter the public domain (SNI) for the route:

: yourls.pi.example.com

Enter the destination IP address to forward to:

: 10.13.16.2

Enter the destination TCP port to forward to:

: 443

> Do you want to enable Proxy Protocol for this route? Yes

## Layer 7 TLS Proxy is ENABLED.
## Configured Layer 7 Routes:
Entrypoint              Destination_address  Destination_port  Proxy_protocol
----------              -------------------  ----------------  --------------
yourls.pi.example.com  10.13.16.2           443               2
</pre>
    </div>
</div>

<p>Press <code>ESC</code> three times to go back to the main menu, and re-install Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>After installation, press <code>ESC</code> to quit the config tool.</p>
<h2 id="finish">Finish</h2>

<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Immediately secure the admin account</div>
  <div class="box-content">

<p>You should immediately open the URL in your web browser:
<code>https://yourls.pi.example.com/admin</code> and complete the initial
configuration to finsh installation.</p>
<p>There is no page at the root URL (Forbidden.) To administer the site,
you must go to the page <code>https://yourls.pi.example.com/admin</code>.</p>
</div>
</div>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="007500-nginx-and-php">Nginx and PHP</h1>
                    <div class="chapter-content">
                        
<p>d.rymcg.tech ships with a traditional <a href="https://www.php.net/" rel="external" target="_blank">PHP</a> webstack, including <a href="https://github.com/nginx/nginx" rel="external" target="_blank">Nginx</a>
proxy, with <a href="https://www.postgresql.org/" rel="external" target="_blank">PostgreSQL</a> database and <a href="https://github.com/redis/redis" rel="external" target="_blank">Redis</a> session store. These extra
features can all be turned off, turning Nginx into a simple static
file server instead.</p>
<h2 id="configure-nginx">Configure Nginx</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make nginx config
</pre></code>
    </div>
</div>


<p>Make sure you choose a unique domain for this service (<code>www</code> is also
the default for <code>thttpd</code>, so if you installed that too, just make sure
this is unique:)</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
NGINX_TRAEFIK_HOST: Enter the nginx domain name (eg. www.example.com)

: nginx.pi.example.com
</pre>
    </div>
</div>

<p>Choose the optional features you want to enable: <code>postgres</code>, <code>php-fpm</code>:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Choose the docker-compose profiles to enable:
  [x] nginx - Base Nginx config (don't unselect this, it is required)
  [x] postgres - PostgreSQL database
> [x] php-fpm - PHP script support + Redis session store
</pre>
    </div>
</div>

<p>Choose one of the default PHP apps to install:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Choose the index PHP file to install
  default.php
> phpinfo.php
  https://github.com/adminerevo/adminerevo/releases/download/v4.8.3/adminer-4.8.3.php
</pre>
    </div>
</div>

<p>Turn on one of the sentry authorization options to protect your
instance:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Do you want to enable sentry authorization in front of this app (effectively making the entire site private)?
  No
  Yes, with HTTP Basic Authentication
> Yes, with Oauth2
  Yes, with Mutual TLS (mTLS)

? Which authorization group do you want to permit access to this app?
> admin
</pre>
    </div>
</div>


<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>This will allow only the <code>admin</code> authorization group to access this
instance.</p>
<p>Remember, you can create <a href="/portable-docker/install-core-services/traefik-forward-auth/#add-user-groups-for-sentry-authorization">extra authorization groups</a> in the Traefik
config, that way you can have separate user access per instance.</p>
</div>
</div>
<h2 id="install-nginx">Install Nginx</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make nginx install wait
</pre></code>
    </div>
</div>


<h2 id="add-a-new-route-on-the-sentry">Add a new route on the sentry</h2>
<p>You need to create two routes: one for homepage, and one for the
webhooks:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
> Advanced Routing (Layer 7 / Layer 4 / WireGuard)
  Error page template
  Logging level
  Access logs

? Traefik routes
> Configure layer 7 TLS proxy
  Configure layer 4 TCP/UDP proxy
  Configure wireguard VPN

? Layer 7 TLS Proxy:
  List layer 7 ingress routes
> Add new layer 7 ingress route
  Remove layer 7 ingress routes
  Disable layer 7 TLS Proxy

Enter the public domain (SNI) for the route:

: nginx.pi.example.com

Enter the destination IP address to forward to:

: 10.13.16.2

Enter the destination TCP port to forward to:

: 443

> Do you want to enable Proxy Protocol for this route? Yes

## Layer 7 TLS Proxy is ENABLED.
## Configured Layer 7 Routes:
Entrypoint            Destination_address  Destination_port  Proxy_protocol
----------            -------------------  ----------------  --------------
nginx.pi.example.com  10.13.16.2           443               2
</pre>
    </div>
</div>

<p>Press <code>ESC</code> three times to go back to the main menu, and re-install Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>After installation, press <code>ESC</code> to quit the config tool.</p>
<h2 id="open-nginx-webpage">Open Nginx webpage</h2>
<p>Open <code>https://nginx.pi.example.com</code> in your web browser.</p>
<h2 id="upload-site-files-with-sftp">Upload site files with SFTP</h2>
<p>Manage the Nginx volume (<code>nginx_files</code>) with <a href="/portable-docker/install-web-services/sftp/">SFTP</a> (the same way as
with <code>thttpd</code>), and you can use this as a simple way to publish your
websites.</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make sftp config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
SFTP_PORT: Enter the public SSH port (eg. 2223)

: 2223

SFTP_USERS: Enter the user:uid list (eg. ryan:1000,gary:1001)

: www:54321

SFTP_VOLUMES: Enter the volume:user:mount list (can be blank)

: nginx_files:www:nginx
</pre>
    </div>
</div>



<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make sftp install
</pre></code>
    </div>
</div>


<p>Authorize your SSH key:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make sftp ssh-authorize-key
</pre></code>
    </div>
</div>


<ul>
<li>Enter the username <code>nginx</code></li>
<li>Enter the SSH public key (copy this from your local
<code>~/.ssh/id_ed25519.pub</code>)</li>
</ul>
<h2 id="create-counters-demo-app">Create counters demo app</h2>
<p>Let&rsquo;s create a demo PHP script that shows how to connect to the
PostgreSQL database and make a web page hit counter:</p>
<p>Create a new project directory on your personal workstation:</p>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
mkdir -p ~/php-demo
</pre></code>
    </div>
</div>




<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
cat &lt;&lt;'EOF' > ~/php-demo/counter.php
&lt;?php
// Load environment variables using the standard PostgreSQL environment variable names
$host = getenv('PGHOST') ?: 'localhost'; // Default to localhost if PGHOST is not set
$dbname = getenv('PGDATABASE') ?: 'your_default_database';
$user = getenv('PGUSER') ?: 'your_default_user';
$password = getenv('PGPASSWORD') ?: 'your_default_password';
$port = getenv('PGPORT') ?: '5432'; // Default to port 5432 if PGPORT is not set

// Check if all the necessary environment variables are set
if (!$host || !$dbname || !$user || !$password || !$port) {
    die('Missing required PostgreSQL environment variables.');
}

// Establish a connection to the PostgreSQL database
try {
    $dsn = "pgsql:host=$host;port=$port;dbname=$dbname";
    $pdo = new PDO($dsn, $user, $password, [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]);
} catch (PDOException $e) {
    die('Connection failed: ' . $e->getMessage());
}

// Function to check if the table exists
function checkTableExists($pdo, $tableName) {
    $query = $pdo->prepare("SELECT to_regclass(:table_name) AS exists");
    $query->execute(['table_name' => $tableName]);
    $result = $query->fetch(PDO::FETCH_ASSOC);
    return $result['exists'] !== null;
}

// Create the table if it does not exist
if (!checkTableExists($pdo, 'page_counters')) {
    $createTableQuery = "
    CREATE TABLE page_counters (
        id SERIAL PRIMARY KEY,
        counter_name VARCHAR(255) UNIQUE NOT NULL,
        count BIGINT DEFAULT 0
    );
    ";
    $pdo->exec($createTableQuery);
}

// Determine the counter name from the query string, defaulting to 'default'
$counterName = isset($_GET['counter']) ? $_GET['counter'] : 'default';

// Check if the counter exists in the database
$stmt = $pdo->prepare("SELECT count FROM page_counters WHERE counter_name = :counter_name");
$stmt->execute(['counter_name' => $counterName]);
$counter = $stmt->fetch(PDO::FETCH_ASSOC);

if ($counter) {
    // If the counter exists, increment it
    $newCount = $counter['count'] + 1;
    $updateStmt = $pdo->prepare("UPDATE page_counters SET count = :count WHERE counter_name = :counter_name");
    $updateStmt->execute(['count' => $newCount, 'counter_name' => $counterName]);
} else {
    // If the counter does not exist, create it with a value of 1
    $newCount = 1;
    $insertStmt = $pdo->prepare("INSERT INTO page_counters (counter_name, count) VALUES (:counter_name, :count)");
    $insertStmt->execute(['counter_name' => $counterName, 'count' => $newCount]);
}

// Output the current counter value
echo "Counter '$counterName': $newCount";
EOF
</pre></code>
    </div>
</div>




<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
scp ~/php-demo/counter.php sftp.pi.example.com:nginx/public/
</pre></code>
    </div>
</div>



<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>Instead of <code>scp</code>, you can follow the same instructions as for <a href="/portable-docker/install-web-services/sftp/#use-rclone-to-synchronize-whole-directories-to-sftp">Thttpd</a>,
and setup Rclone with an easy to use <code>sync-web</code> alias for
synchronizing your web files.</p>
</div>
</div>
<h2 id="visit-counter-page">Visit counter page</h2>
<p>Try these URLs in your browser (replacing your root domain):</p>
<ul>
<li><code>https://nginx.pi.example.com/counter.php</code></li>
<li><code>https://nginx.pi.example.com/counter.php?counter=two</code></li>
</ul>
<p>Refresh each one multiple times and watch the counter grow.</p>
<figure><img src="/img/portable-docker/php-counter.webp"/>
</figure>


                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="007600-jupyterlab">Jupyterlab</h1>
                    <div class="chapter-content">
                        
<p><a href="https://jupyter.org/" rel="external" target="_blank">JupyterLab</a> is an interactive programming notebook which lets you write
and test code in a persistent web browser environment. Notebooks are
useful for simple experiments, reproducible research, and easy sharing
and collaboration.</p>
<figure><img src="/img/portable-docker/jupyterlab-notebook.webp"/>
</figure>

<h2 id="configure-jupyterlab">Configure Jupyterlab</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make jupyterlab config
</pre></code>
    </div>
</div>


<h2 id="install-jupyterlab">Install Jupyterlab</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make jupyterlab install wait
</pre></code>
    </div>
</div>


<h2 id="add-a-new-route-on-the-sentry">Add a new route on the sentry</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik config
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
> Config
  Install (make install)
  Admin
  Exit (ESC)

? Traefik Configuration:
^ Entrypoints (including dashboard)
  TLS certificates and authorities
  Middleware (including sentry auth)
> Advanced Routing (Layer 7 / Layer 4 / WireGuard)
  Error page template
  Logging level
  Access logs

? Traefik routes
> Configure layer 7 TLS proxy
  Configure layer 4 TCP/UDP proxy
  Configure wireguard VPN

? Layer 7 TLS Proxy:
  List layer 7 ingress routes
> Add new layer 7 ingress route
  Remove layer 7 ingress routes
  Disable layer 7 TLS Proxy

Enter the public domain (SNI) for the route:

: jupyterlab.pi.example.com

Enter the destination IP address to forward to:

: 10.13.16.2

Enter the destination TCP port to forward to:

: 443

> Do you want to enable Proxy Protocol for this route? Yes

## Layer 7 TLS Proxy is ENABLED.
## Configured Layer 7 Routes:
Entrypoint                 Destination_address  Destination_port  Proxy_protocol
----------                 -------------------  ----------------  --------------
jupyterlab.pi.example.com  10.13.16.2           443               2
</pre>
    </div>
</div>

<p>Press <code>ESC</code> three times to go back to the main menu, and re-install Traefik:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Traefik:
  Config
> Install (make install)
  Admin
  Exit (ESC)
</pre>
    </div>
</div>

<p>After installation, press <code>ESC</code> to quit the config tool.</p>
<h2 id="retrieve-the-login-token">Retrieve the login token</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make jupyterlab token
</pre></code>
    </div>
</div>


<p>Copy the token that is output to your clipboard:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
xXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxX
</pre>
    </div>
</div>

<h2 id="open-jupyterlab">Open Jupyterlab</h2>
<p>Open <code>https://jupyterlab.pi.example.com</code> in your web browser. Paste
the login token, and optionally set a new password.</p>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="009002-backup">Native Backup</h1>
                    <div class="chapter-content">
                        
<p>Backup of native machines is much harder than for virtual machines,
that&rsquo;s just the way it goes. With VMs, your hypervisor should have a
builtin backup feature which can suspend (pause) the entire machine,
make a snapshot of the disk and the entire RAM contents, resume the
machine, and continue backing up the snapshot in the background. If
you have the luxury of running your server as a VM (e.g., <a href="https://www.proxmox.com/en/proxmox-virtual-environment/overview" rel="external" target="_blank">Proxmox PVE</a>,
or any cloud provider), it makes backups so much easier.</p>
<p>When running Docker natively on a Raspberry Pi, you do not have that
option. This chapter deals with the more intricate procedure of the
backup of a <em>non-virtual</em> machine.</p>
<h2 id="restic">Restic</h2>
<p><a href="https://restic.net/" rel="external" target="_blank">Restic</a> is a modern open source backup tool, which has many great
features including incremental backups, encryption, and offsite
upload. It can maintain backups of huge sizes, and it only needs to
upload the changes since the last backup.</p>
<p>One of the best ways to install Restic is with the script found on
this blog post:</p>
<p><a href="https://blog.rymcg.tech/blog/linux/restic_backup/" rel="external" target="_blank">Daily backups to S3 with Restic and systemd timers</a></p>

<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div>
  <div class="box-content">

<p>The only problem with backing up files this way is that with
containers that are always running, you need to make sure that the
files are flushed to disk before the backup starts, otherwise your
backup could become corrupted. For files that are only written to once
(photos, videos, etc.) this might not be such a big deal, but for
files that are constantly changing (e.g., databases) this is a
problem.</p>
</div>
</div>

<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>Evaluating <a href="https://blog.rymcg.tech/blog/linux/restic_backup/" rel="external" target="_blank">this Restic script</a>:</p>
<p>Pros:</p>
<ul>
<li>It&rsquo;s a self contained script not dependent on Docker.</li>
<li>It can backup several directories and upload to an offsite S3
bucket. Point the script at any directory and it will make a backup
of it (e.g., <code>/home/pi/</code>, <code>/var/lib/docker/volumes</code> [see Cons].)</li>
<li>It supports a space-efficient incremental backup strategy.</li>
<li>It&rsquo;s a good option for backup of home directories and large media
folders.</li>
</ul>
<p>Cons:</p>
<ul>
<li>No integration with Docker; it cannot shutdown containers before
backup. Backup of <code>/var/lib/docker/volumes</code> is not 100% safe. Files
that are modified <strong>during</strong> the backup may become corrupted.</li>
<li>Restoration requires the original script and for you to re-install
Restic.</li>
</ul>
</div>
</div>
<h2 id="backup-volume">Backup-Volume</h2>
<p><a href="https://github.com/EnigmaCurry/backup-volume" rel="external" target="_blank">Backup-Volume</a> is another backup tool that is specifically configured
to backup Docker volumes and uploading archives to offsite storage
(S3, SSH, DropBox).</p>
<p><strong>Backup-Volume can only handle complete backups (no incremental
storage)</strong>. For small datasets this is ideal, because each backup gets
stored in a separate <code>backup-XXXX.tar.gz</code>, and its easy to restore
with one file. For larger datasets, the duplication of backup files
would be prohibitively expensive/wasteful (although you can tune the
retention and pruning parameters to save some space, it won&rsquo;t compare
to the efficiency of Restic).</p>
<p>Backup-Volume has a trick it can use in its favor: it can
automatically stop and start containers before and after the backup
runs. This makes this style of backup much safer for write intensive
volumes (e.g., databases) and ensures that the data gets flushed
before the backup starts.</p>

<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>Evaluating <a href="https://github.com/EnigmaCurry/backup-volume" rel="external" target="_blank">Backup-Volume</a>:</p>
<p>Pros:</p>
<ul>
<li>Specifically designed to backup Docker volumes on a cron-like
schedule.</li>
<li>Manages the lifecycle of the containers to shut them down before a
backup starts and to restart them afterward.</li>
<li>Each backup is contained in a single file (<code>backup-XXXX.tar.gz</code>)
which is uploaded to your S3 provider. Restoration is easy, just
download the latest tarball and extract it.</li>
<li>Automatic pruning of old archives helps to save some space.</li>
</ul>
<p>Cons:</p>
<ul>
<li>No incremental backup support. Each backup duplicates the entire
dataset. Ill-suited for large datasets.</li>
</ul>
</div>
</div>
<h2 id="setup-backup-volume">Setup Backup-Volume</h2>
<h3 id="prepare-an-s3-bucket-offsite">Prepare an S3 bucket offsite</h3>
<p>You may want to use your own <a href="/portable-docker/install-web-services/minio-s3/index.html">minio</a> S3 service (preferably installed on
a separate offsite server), or a third party provider (AWS S3,
DigitalOcean Spaces, Wasabi, etc.)</p>
<p>You will need to provide the S3 bucket and credentials that the backup
process will use when uploading archives:</p>
<ul>
<li>S3 Endpoint domain. e.g., <code>s3.example.com</code>.</li>
<li>S3 bucket name. e.g., <code>test</code></li>
<li>S3 access key id. e.g., <code>test</code>.</li>
<li>S3 secret key. e.g., <code>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</code>.</li>
</ul>
<h3 id="configure-backup-volume">Configure Backup-Volume</h3>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
## Configures the default backup-volume instance:
pi make backup-volume config
</pre></code>
    </div>
</div>


<p>Select multiple existing volumes to backup together as one archive:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Select all the volumes to backup
> [x] test1_data
  [ ] forgejo_data
  [x] icecast_config
  [ ] icecast_logs
  [ ] mosquitto_mosquitto
  [ ] traefik_geoip_database
v [ ] traefik_traefik
</pre>
    </div>
</div>

<p>Choose the backup schedule in <a href="https://github.com/EnigmaCurry/d.rymcg.tech/blob/73648904e5a954e17077368c299a23a19947ab16/backup-volume/.env-dist#L23-L59" rel="external" target="_blank">cron format</a> :</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
BACKUP_CRON_EXPRESSION: Enter the cron expression (eg. @daily)

: @every 24h
</pre>
    </div>
</div>


<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>Other example schedules:</p>
<ul>
<li><code>@every 1h15m</code></li>
<li><code>@daily</code></li>
<li><code>@weekly</code></li>
<li><a href="https://github.com/EnigmaCurry/d.rymcg.tech/blob/19ee7e0e5e39350b86ec6317c4e1d3765c806378/backup-volume/.env-dist#L23-L59" rel="external" target="_blank">See more in the .env-dist file</a></li>
</ul>
</div>
</div>
<p>Choose the retention length (number of days) to keep backup archives
before automatic pruning happens:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
BACKUP_RETENTION_DAYS: Rotate backups older than how many days? (eg. 30)

: 30
</pre>
    </div>
</div>

<p>You can choose any of the supported storage mechanisms. For demo
purposes, choose S3:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
> Which remote storage do you want to use? s3

BACKUP_AWS_ENDPOINT: Enter the S3 endpoint (e.g., s3.example.com)

: s3.d.example.com

BACKUP_AWS_S3_BUCKET_NAME: Enter the S3 bucket name (e.g., my-bucket)

: backup-test-1

BACKUP_AWS_ACCESS_KEY_ID: Enter the S3 access key id (e.g., my-access-key)

: backup-test-1

BACKUP_AWS_SECRET_ACCESS_KEY: Enter the S3 secret access key

: OEuL3lMSdvdoFyVjEQTM4Trj/7VhHq7Q7cOFEpQPuxMHxsTVK3Hxne7st6Ty

BACKUP_AWS_S3_PATH: Choose a directory inside the bucket (blank for root)

:
</pre>
    </div>
</div>


<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>You should use a dedicated bucket for each backup instance, or you can
share the same bucket between several instances, as long as you are
careful to configure a unique <code>BACKUP_AWS_S3_PATH</code> bucket
sub-directory for each instance.</p>
</div>
</div>
<p>You may optionally preserve an additional copy of the archive in a
local volume:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
> Do you want to keep a local backup in addition to the remote one? No
</pre>
    </div>
</div>

<p>You can choose to turn on notifications (see separate instructions
below.)</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Do you want to receive notifications for backup failure?
> No.
  Yes, via email.
  Yes, via webhook.
</pre>
    </div>
</div>

<h3 id="install">Install</h3>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
## installs the default backup instance:
pi make backup-volume install
</pre></code>
    </div>
</div>


<h3 id="instances">Instances</h3>
<p>All volume selections will backup to the same archive on the same
schedule. To back up different volumes on different schedules, you
should create more than one instance of Backup-Volume to create
separate configs:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
## Creates a new backup instance named test:
pi make backup-volume instance instance=test
pi make backup-volume install instance=test
</pre></code>
    </div>
</div>


<h3 id="verify-backup-schedule">Verify backup schedule</h3>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make backup-volume logs
</pre></code>
    </div>
</div>


<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
backup-1  | 2024-10-16T02:37:00.263838944Z time=2024-10-16T02:37:00.262Z level=INFO msg="Successfully scheduled backup from environment with expression @daily"
backup-1  | 2024-10-16T02:37:00.266773318Z time=2024-10-16T02:37:00.266Z level=INFO msg="The backup will start at 12:00 AM"
</pre>
    </div>
</div>


<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>You should see a plain text log message describing when the backup
will occur (<code>The backup will start at 12:00 AM</code>), except it will be
ommitted if you use the <code>@every</code> syntax.</p>
</div>
</div>
<h3 id="restore">Restore</h3>
<p>To restore a volume from a backup, simply untar the archive into the
appropriate directory under <code>/var/lib/docker/volumes</code>.</p>
<h3 id="notifications">Notifications</h3>
<p>In the event of a failed backup job, a notification can be sent to a
configurable receiver with <a href="https://containrrr.dev/shoutrrr/v0.8/services/overview/" rel="external" target="_blank">Shoutrrr</a> (including Email, Matrix, Discord,
Ntfy, IFTTT etc.)</p>
<h4 id="email-notifications">Email notifications</h4>

<div class="box notices cstyle primary">
  <div class="box-label">Info</div>
  <div class="box-content">

<p>To enable email notifications, you must setup postfix-relay separately
and configure it to allow clients from the the <code>backup-volume</code> network
to send mail.</p>
</div>
</div>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
? Do you want to receive notifications for backup failure?
  No.
> Yes, via email.
  Yes, via webhook.

Enter the sender email address

: backup-volume-default@pi.example.com

Enter the recipient email address

: test@example.com
</pre>
    </div>
</div>

<h4 id="matrix-notifications-via-webhook">Matrix notifications via webhook</h4>
<p>You will need to setup the <a href="https://matrix-org.github.io/matrix-hookshot/latest/index.html" rel="external" target="_blank">Matrix Hookshot</a> bot in order to receive a
generic webhook from Backup-Volume that notifies the Matrix room you
share with the bot.</p>
<ul>
<li>Create a new room and invite the hookshot bot to it.</li>
<li>Message the room: <code>!hookshot setup-widget</code>.</li>
<li>Open the room Extensions tab and click on the Hookshot extension.</li>
<li>Create a new <code>Inbound (Generic) Webhook</code>.</li>
<li>Name the webhook <code>backup-volume.example.com</code> after your
backup-volume instance.</li>
<li>Copy the long URL it gives you, e.g.,
<code>https://matrix.example.com/hookshot/webhooks/webhook/xxxxxx</code>.</li>
<li>Click <code>Save</code>.</li>
</ul>
<p>Reconfigure the <code>.env_{CONTEXT}_{INSTANCE}</code> file of the backup-volume
instance, setting the notification URL as a <a href="https://containrrr.dev/shoutrrr/v0.8/services/generic/" rel="external" target="_blank">Generic webhook</a>:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make backup-volume reconfigure var=BACKUP_NOTIFICATION_URLS="generic://matrix.example.com/hookshot/webhooks/webhook/xxxxx?template=json"
</pre></code>
    </div>
</div>



<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>Important: the Shoutrrr webhook notification URL should start with
<code>generic://</code> (not <code>https://</code>). It should end with <code>?template=json</code>.</p>
</div>
</div>
<p>Re-install to load the new config:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
pi make backup-volume install
</pre></code>
    </div>
</div>


<p>To test the notification, you can consider setting
<code>BACKUP_CRON_EXPRESSION=@every 1m</code> and change the S3 credentials so
that they are incorrect, thus triggering a failure notification to be
sent.</p>
<p>You should see the JSON notification in the channel, which
unfortunately is not formatted very nicely :</p>

<div class="box notices cstyle default">
  <div class="box-label">Example matrix message:</div>
  <div class="box-content">

<p>{
&ldquo;message&rdquo;: &ldquo;Running backup-volume failed with error: main.(*script).copyArchive: error copying archive: s3.(*s3Storage).Copy: error uploading backup to remote storage: [Message]: &lsquo;The specified bucket does not exist.&rsquo;, [Code]: NoSuchBucket, [StatusCode]: 404\n\nLog output of the failed run was:\n\ntime=2024-10-16T19:45:27.092Z level=INFO msg=\&ldquo;Stopping 1 out of 26 running container(s) as they were labeled backup-volume.stop-during-backup=true.\&quot;\ntime=2024-10-16T19:45:27.713Z level=INFO msg=\&ldquo;Created backup of `/backup` at `/tmp/backup-default-2024-10-16T19-45-27.tar.gz`.\&quot;\ntime=2024-10-16T19:45:27.972Z level=INFO msg=\&ldquo;Restarted 1 container(s).\&quot;\ntime=2024-10-16T19:45:28.259Z level=INFO msg=\&ldquo;Removed tar file `/tmp/backup-default-2024-10-16T19-45-27.tar.gz`.\&quot;\n&rdquo;,
&ldquo;title&rdquo;: &ldquo;Failure running backup-volume at 2024-10-16T19:45:27Z&rdquo;
}</p>
</div>
</div>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="009003-upgrade">Upgrade</h1>
                    <div class="chapter-content">
                        
<h2 id="upgrade-raspberry-pi-os">Upgrade Raspberry Pi OS</h2>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sudo apt update
sudo apt full-upgrade
sudo reboot
</pre></code>
    </div>
</div>


<h2 id="upgrade-container-images">Upgrade container images</h2>
<p>Each application is configured via its own <code>.env_{CONTEXT}_{INSTANCE}</code>
file in the project folder of each app.</p>
<p>The version of the app is usually controlled via an environment
variable named <code>PROJECT_IMAGE</code> or <code>PROJECT_VERSION</code>. For some apps,
this will be labeled as <code>latest</code> so that it always installs the latest
version, while others are locked to a specific know working version.
The <code>d.rymcg.tech</code> authors will update the <code>.env-dist</code> file
automatically, but you must still update this in your own
<code>.env_{CONTEXT}_{INSTANCE}</code> config files.</p>
<p>You can edit the .env file for any app instance:</p>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
## Immich is just an example app:
pi make immich config-edit instance=default
</pre></code>
    </div>
</div>


<p>This will open the config file in the default editor (<code>nano</code>), find
the appropriate environment variable that affects the version of the
application (usually there&rsquo;s a comment or URL to go to), edit it so
that it points to the latest version, and save the file.</p>
<p>You must reinstall the application to install the new version:</p>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
## Immich is just an example app:
pi make immich install
</pre></code>
    </div>
</div>


<h2 id="upgrade-sentry">Upgrade sentry</h2>
<p>The sentry should also be upgraded from time to time:</p>
<ul>
<li>Update the Traefik version.</li>
<li>Update the WireGuard version.</li>
</ul>


<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on your Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sentry make traefik config-edit
</pre></code>
    </div>
</div>



                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="009004-troubleshooting">Troubleshooting</h1>
                    <div class="chapter-content">
                        
<h2 id="monitor-kernel-logs">Monitor kernel logs</h2>
<p>During the first day or so of setting this machine up, it is
recommended to actively monitor the kernel logs, checking for errors.</p>


<div class="box notices cstyle run">
    <div class="box-label primary">
        <i class="fa-fw fas fa-dollar-sign"></i>[bash]: Run this on your workstation:</div>
    <div class="box-content">
        <code><pre>
## Just leave this running in a separate terminal as you keep working..
sudo dmesg -w
</pre></code>
    </div>
</div>


<h3 id="disable-power-saving-on-nvme-storage">Disable power saving on NVME storage</h3>

<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> How to disable power saving on the NVME drive</div>
  <div class="box-content">

<p>Out of two identical kits, I encountered one error in the kernel log
on one machine but not on the other, so you may or may not run into
this error:</p>
<div class="box notices cstyle stdout">
    <div class="box-label"><i class="fa-fw fas fa-angle-right"></i>(stdout)</div>
    <div class="box-content">
        <pre>
[  359.477209] nvme nvme0: controller is down; will reset: CSTS=0xffffffff, PCI_STATUS=0x11
[  359.477218] nvme nvme0: Does your device have a faulty power saving mode enabled?
[  359.477220] nvme nvme0: Try "nvme_core.default_ps_max_latency_us=0 pcie_aspm=off" and report a bug
[  359.545210] nvme 0000:01:00.0: enabling device (0000 -> 0002)
[  359.549032] nvme nvme0: Shutdown timeout set to 10 seconds
[  359.722783] nvme nvme0: 4/0/0 default/read/poll queues
</pre>
    </div>
</div>
<p>This error seems to indicate there is a faulty power saving feature in hardware or in
the NVME firmware or kernel code. It may be fixed by following the advice
to turn off the power saving feature of the NVME:</p>
<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sudo nano /boot/firmware/cmdline.txt
</pre></code>
    </div>
</div>
<p>This file should contain a single long line of text. You should find
the very end of the line, and add the following to the end of it:</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>nvme_core.default_ps_max_latency_us=0 pcie_aspm=off</span></span></code></pre></div><p>The whole line should now look like:</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>console=serial0,115200 console=tty1 root=PARTUUID=xxxxxxxx-02 rootfstype=ext4 fsck.repair=yes rootwait cfg80211.ieee80211_regdom=US   nvme_core.default_ps_max_latency_us=0 pcie_aspm=off</span></span></code></pre></div><p>Press <code>Ctrl+S</code> to save the file. Press <code>Ctrl+X</code> to quit <code>nano</code>.</p>
<p>Reboot the pi:</p>
<div class="box notices cstyle run">
    <div class="box-label secondary">
        <i class="fa-fw fas fa-dollar-sign"></i>Run this on the Raspberry Pi</div>
    <div class="box-content">
        <code><pre>
sudo reboot
</pre></code>
    </div>
</div>
<p>Check to see if the error goes away, but if not, you probably have a
hardware issue.</p>
</div>
</div>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="010001-Private ACME">Private ACME</h1>
                    <div class="chapter-content">
                        
<p>TODO</p>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="010010-Mutual TLS for Web and Mobile">Mutual TLS for Web and Mobile</h1>
                    <div class="chapter-content">
                        
<p>TODO</p>

                    </div>
                </div>
                
                <div class="chapter" style="page-break-after: always;">
                    <h1 id="single"></h1>
                    <div class="chapter-content">
                        

                    </div>
                </div>
                
                
            </main>
        </div>    
    </body>
</html>
