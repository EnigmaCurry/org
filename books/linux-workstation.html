<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-06-02 Sun 19:57 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="author" content="ryan" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org9de6f66">1. Linux Workstation</a></li>
<li><a href="#org947f391">2. Introduction</a>
<ul>
<li><a href="#org2f55de1">2.1. Introduction</a></li>
<li><a href="#org19dd394">2.2. Fedora Sway Atomic</a></li>
<li><a href="#orgb561b42">2.3. Requirements</a></li>
</ul>
</li>
<li><a href="#org7f4c7fb">3. Install Linux (Fedora Atomic)</a>
<ul>
<li>
<ul>
<li><a href="#orgad5bd4f">3.0.1. Create USB installation media</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orga6d992a">4. Upgrading</a></li>
<li><a href="#orgf09feb6">5. Layering packages</a>
<ul>
<li><a href="#org480f4bc">5.1. Examples of applications you might want to layer</a></li>
<li><a href="#orgf779a68">5.2. Check the list of layers:</a></li>
<li><a href="#orgcbe409b">5.3. Reset all layers back to stock</a></li>
</ul>
</li>
<li><a href="#org515cd5b">6. Config</a>
<ul>
<li><a href="#orgbdbe90a">6.1. Config</a></li>
<li><a href="#org3cf3af0">6.2. Sway</a>
<ul>
<li><a href="#org08d17f5">6.2.1. Sway Config</a></li>
<li><a href="#orgead72b2">6.2.2. Setup display resolutions and orientation</a></li>
</ul>
</li>
<li><a href="#orgc28d729">6.3. Firefox</a>
<ul>
<li><a href="#org7975dcb">6.3.1. Remove clutter</a></li>
<li><a href="#org6717247">6.3.2. Firefox Settings</a></li>
<li><a href="#org1240a47">6.3.3. Extensions and Themes</a></li>
</ul>
</li>
<li><a href="#org16f8b48">6.4. Toolbox</a>
<ul>
<li><a href="#org4e7d687">6.4.1. Dev toolbox (Fedora)</a></li>
<li><a href="#org552537b">6.4.2. Arch Linux toolbox</a></li>
<li><a href="#org7b133a9">6.4.3. Managing toolbox containers</a></li>
</ul>
</li>
<li><a href="#org4e17c49">6.5. Emacs</a>
<ul>
<li><a href="#orgf921935">6.5.1. Install Emacs</a></li>
<li><a href="#orgd52195e">6.5.2. Create Emacs script</a></li>
<li><a href="#orgfebc739">6.5.3. Install dependencies</a></li>
<li><a href="#orgb5e2779">6.5.4. Remove any existing Emacs config</a></li>
<li><a href="#org3c87781">6.5.5. Install my Emacs config</a></li>
<li><a href="#org1127a7c">6.5.6. Start Emacs to finish the installation</a></li>
<li><a href="#orgb50965f">6.5.7. Read the README for my config</a></li>
</ul>
</li>
<li><a href="#orgff31cf8">6.6. SSH</a>
<ul>
<li><a href="#org3844cd0">6.6.1. Create SSH Keys</a></li>
<li><a href="#org5e385a7">6.6.2. Setup the ssh-agent</a></li>
<li><a href="#org074e06f">6.6.3. Add your solokey identity per session</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org355b095">7. KVM / libvirt</a>
<ul>
<li><a href="#org2d6f78f">7.1. KVM / libvirt</a></li>
<li><a href="#orgb7c337f">7.2. Setup libvirtd</a>
<ul>
<li><a href="#org460aab8">7.2.1. Install libvirt packages</a></li>
<li><a href="#orgc7ef868">7.2.2. Enable libvirtd service</a></li>
<li><a href="#orgc60cdc8">7.2.3. Start the default network</a></li>
<li><a href="#orgb64950a">7.2.4. Configure /etc/group</a></li>
</ul>
</li>
<li><a href="#org201a0e9">7.3. Create VM admin</a>
<ul>
<li><a href="#orga75b168">7.3.1. Create <code>libvirt-admin</code> user</a></li>
<li><a href="#orgc0aec4d">7.3.2. Configure systemd for the <code>libvirt-admin</code> user</a></li>
<li><a href="#org7016ed3">7.3.3. Copy your public SSH key into the <code>libvirt-admin</code> home directory</a></li>
</ul>
</li>
<li><a href="#orgf0595c1">7.4. Configure VM</a>
<ul>
<li><a href="#orgb2f7970">7.4.1. Choose hardware sizes</a></li>
<li><a href="#org52129fa">7.4.2. Choose cloud image</a></li>
<li><a href="#orgd0b2652">7.4.3. Find the default subnet (<code>virbr0</code>)</a></li>
<li><a href="#org44dacaa">7.4.4. Configure Hostname, IP Address, and MAC address</a></li>
<li><a href="#orgba1a21f">7.4.5. Create static DHCP lease</a></li>
<li><a href="#org6eb6dcf">7.4.6. Create env file to store main config settings</a></li>
</ul>
</li>
<li><a href="#orge0d3e15">7.5. Create VM</a>
<ul>
<li><a href="#org9464ca5">7.5.1. Source the config</a></li>
<li><a href="#org6b83677">7.5.2. Create directories to hold the VM disks and config files:</a></li>
<li><a href="#org383873e">7.5.3. Create the cloud-init config file:</a></li>
<li><a href="#org45dd340">7.5.4. Download the cloud image:</a></li>
<li><a href="#org1d19ae1">7.5.5. Clean up old VMs with the same name:</a></li>
<li><a href="#org1ef988e">7.5.6. Create the disk image for the new VM:</a></li>
<li><a href="#org41926c9">7.5.7. Create the VM:</a></li>
<li><a href="#org88331af">7.5.8. Watch the console for any errors</a></li>
<li><a href="#org31a842f">7.5.9. Disconnect from the VM console</a></li>
<li><a href="#org9358864">7.5.10. Shutdown the VM</a></li>
<li><a href="#orgf140be6">7.5.11. Restart VM</a></li>
<li><a href="#orgdc6c4bf">7.5.12. Enable auto start on boot</a></li>
</ul>
</li>
<li><a href="#org51d9c60">7.6. Setup workstation SSH config</a>
<ul>
<li><a href="#orgbdfb322">7.6.1. Install Docker or something else</a></li>
<li><a href="#orgafa92d3">7.6.2. Reboot your workstation</a></li>
<li><a href="#org6565ad9">7.6.3. OK what if autostart didn't work?</a></li>
</ul>
</li>
<li><a href="#orgede1914">7.7. VM management commands</a>
<ul>
<li><a href="#org654babb">7.7.1. List all defined VMs</a></li>
<li><a href="#orgb47ea09">7.7.2. Start VM (named debian-dev)</a></li>
<li><a href="#orgefe651a">7.7.3. Stop VM (named debian-dev)</a></li>
<li><a href="#orgf3f1809">7.7.4. Show network interface (MAC address)</a></li>
<li><a href="#org880903b">7.7.5. Undefine VM (named debian-dev)</a></li>
<li><a href="#org824d12c">7.7.6. Serial console of VM (named debian-dev)</a></li>
</ul>
</li>
<li><a href="#orgdfaa199">7.8. Public routes to VMs</a>
<ul>
<li><a href="#org6b3bb8a">7.8.1. Download the port-forwarding hook</a></li>
<li><a href="#orgf3638bf">7.8.2. Install the port-forwarding hook</a></li>
<li><a href="#org36a4901">7.8.3. Customize the port-forwarding hook</a></li>
<li><a href="#orge370489">7.8.4. Shutdown your VM</a></li>
<li><a href="#org6c4d99d">7.8.5. Restart libvirtd</a></li>
<li><a href="#org1a8dc9c">7.8.6. Restart your VM</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org9de6f66" class="outline-2">
<h2 id="org9de6f66"><span class="section-number-2">1.</span> Linux Workstation</h2>
<div class="outline-text-2" id="text-1">
<p>
This book describes how I setup a Linux Workstation (on a personal
Desktop or Laptop computer).
</p>

<div class="index" id="org0c9948c">
<p>
index
</p>

</div>
</div>
</div>
<div id="outline-container-org947f391" class="outline-2">
<h2 id="org947f391"><span class="section-number-2">2.</span> Introduction</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org2f55de1" class="outline-3">
<h3 id="org2f55de1"><span class="section-number-3">2.1.</span> Introduction</h3>
<div class="outline-text-3" id="text-2-1">
<p>
A Linux Workstation is a single user computer that you use as your
primary interface for computing, especially for "work" purposes. At a
bare minimum, a workstation includes a keyboard to type on, and a
display to display things on. Historically, there has been a hardware
distinction between a personal computer (PC) and a Unix workstation,
but ever since the introduction of Linux, the difference in hardware
doesn't really exist anymore, and any computing device can become a
workstation. The only important distinction for a workstation is the
role that it serves, and how <i>you</i> configure and use it on daily
basis.
</p>

<p>
The role of a workstation is very different than that of a server. A
workstation's only purpose is to serve you, the user, while
interacting with its physical keyboard/mouse/etc interface. A
workstation <i>is</i> usually connected to a network, but only as a client,
not as a server. (Of course, you may bend this rule if you like, to
make your computer a server-workstation or "Sworkstation", but it is
cleaner, and more secure, to use separate machines for these very
different roles.)
</p>

<p>
This book will describe my preferred method for setting up a brand new
computer for use as a personal workstation. It will also show how to
bend the rules a bit, and create a few virtual machines (VM) for
running local development servers.
</p>

<div class="index" id="orgcb3955a">
<p>
index
</p>

</div>
</div>
</div>
<div id="outline-container-org19dd394" class="outline-3">
<h3 id="org19dd394"><span class="section-number-3">2.2.</span> Fedora Sway Atomic</h3>
<div class="outline-text-3" id="text-2-2">
<p>
I have tried a great many different Linux distributions over the
years, but I have recently settled on using <a href="https://fedoraproject.org/atomic-desktops/sway/">Fedora Sway Atomic</a> for my
desktop and laptop workstations.
</p>

<p>
<a href="https://github.com/swaywm/sway">Sway</a> is a minimal tiling window manager for Wayland. It is ideal for
efficient keyboard centric development and for getting out of your
way.
</p>

<p>
The "Atomic" part refers to <a href="https://coreos.github.io/rpm-ostree/">rpm-ostree</a> which was developed by the
CoreOS team to build an operating system that is built entirely to
support containers. The root file system of the host operating system
is mounted read-only, and the packages are distributed in an image,
rather than installed individually. This makes updating (or rolling
back) the system far easier, and makes for a more stable environment.
There is no need to replace packages one-by-one, you just download the
new image provided by the distro, and then reboot the system to use
it.
</p>

<p>
The base image includes all the typical things everyone needs:
coreutils, a display manager, web browser, terminal apps etc. However,
the base image is still pretty bare bones. Furthermore, the image is
read-only, so you can't install packages like you can with a more
traditional Linux distro. If you want to install something that isn't
in the base image, you have a few different options:
</p>

<ul class="org-ul">
<li>Podman or Docker containers. Since containers use their own image,
they are separate from the main image, and can be freely created
and destroyed separately.</li>
<li>Flatpak is a type of application container that includes all of its
dependencies, and it is sandboxed/isolated from the host system,
therefore they can be installed/managed separately from the base
image.</li>
<li>Use rpm-ostree itself to create a new image <b>layer</b>. This extends
the base layer with extra packages you want to install. This is
fully supported, but not optimal, as when you upgrade the base
image, this layer needs to be recreated each time.</li>
</ul>

<p>
I only use a couple of Flatpak apps for a few things. For almost
everything else I use Podman containers via <a href="https://docs.fedoraproject.org/en-US/fedora-silverblue/toolbox/">toolbox</a> and/or <a href="https://distrobox.it/">distrobox</a>
and these can even include graphical applications. Creating your own
<a href="https://docs.fedoraproject.org/en-US/iot/adding-layered/">rpm-ostree layers</a> is to be avoided if possible, but some things don't
like running in containers, so this remains an option.
</p>
</div>
</div>
<div id="outline-container-orgb561b42" class="outline-3">
<h3 id="orgb561b42"><span class="section-number-3">2.3.</span> Requirements</h3>
<div class="outline-text-3" id="text-2-3">
<p>
You will need the following hardware:
</p>

<ul class="org-ul">
<li>An x86<sub>64</sub> desktop or laptop computer.</li>
<li>A USB drive for copying the .iso installer to.</li>
<li>A <a href="https://solokeys.com/">solokey</a> or other FIDO2 compatible hardware authentication key.
(This is optional, but highly recommended for storing secure shell
keys, PGP keys, and logging into websites with Webauthn.)</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org7f4c7fb" class="outline-2">
<h2 id="org7f4c7fb"><span class="section-number-2">3.</span> Install Linux (Fedora Atomic)</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgad5bd4f" class="outline-4">
<h4 id="orgad5bd4f"><span class="section-number-4">3.0.1.</span> Create USB installation media</h4>
<div class="outline-text-4" id="text-3-0-1">
<div class="button" id="org3f86cfa">
<p>
Download the Fedora Sway Atomic iso image.
</p>

</div>


<p>
Assuming you are temporarily using another Linux workstation, write
the .iso image to a USB drive:
</p>

<div class="run" id="org27ab1d0">
<p>
dd if=Fedora-Sericea-ostree-x86<sub>64</sub>-40-1.14.iso \
   of=/dev/sdX bs=10M status=progress conv=sync
</p>

</div>

<div class="notice" id="org4340818">
<p>
Replace <code>/dev/sdX</code> with your device name, and double check the <code>.iso</code>
filename, it may have changed.
</p>

</div>

<p>
Boot the target workstation computer using the USB drive. You will
boot into the Anaconda install wizard. Just follow the prompts to
install it, it is exactly the same as any other Fedora / Redhat
install.
</p>

<p>
Tips:
</p>

<ul class="org-ul">
<li>Enable whole disk encryption and choose a secure passphrase.
Especially for laptop computers that you may travel with, this an
important thing to do to keep your files safe at rest.</li>
<li>Use the entire disk for the install. Dual booting another operating
system on the same workstation is not considered a safe/secure
thing to do. If you want to run Windows or play games, use a
separate computer for that.</li>
</ul>

<p>
Once the installer finishes, reboot, remove the USB, and login to your
new system.
</p>
</div>
</div>
</div>
<div id="outline-container-orga6d992a" class="outline-2">
<h2 id="orga6d992a"><span class="section-number-2">4.</span> Upgrading</h2>
<div class="outline-text-2" id="text-4">
<p>
As mentioned before, Fedora Atomic is distributed as a full system
image. You can both upgrade the image, as well as rollback the image
(in case you have any issues with the upgrade.)
</p>

<p>
To upgrade to the latest image:
</p>

<div class="run" id="org7f99b98">
<p>
sudo rpm-ostree upgrade
</p>

</div>

<p>
Let it finish downloading the new image, and then you must reboot:
</p>

<div class="run" id="org1f09f49">
<p>
sudo systemctl reboot
</p>

</div>
<p>
The boot manager lists the last several images, which are still
available to choose from. The default is to boot the newly upgraded
image.
</p>

<p>
The above will <i>not</i> upgrade to a new release version, eg. Fedora 39
to Fedora 40. It will only update the packages for the currently
installed release.
</p>

<p>
To find the list of all released versions, run :
</p>

<div class="run" id="orgdc9b1e4">
<p>
ostree remote refs fedora | grep "\((uname -m)/sericea\)"
</p>

</div>

<p>
Upgrade to the new release (eg. 40):
</p>

<div class="run" id="orgc265a8c">
<p>
rpm-ostree rebase fedora:fedora/40/x86<sub>64</sub>/sericea
</p>

</div>

<p>
Let it finish downloading the new image, and then reboot again.
</p>
</div>
</div>
<div id="outline-container-orgf09feb6" class="outline-2">
<h2 id="orgf09feb6"><span class="section-number-2">5.</span> Layering packages</h2>
<div class="outline-text-2" id="text-5">
<p>
See the <a href="https://docs.fedoraproject.org/en-US/iot/add-layered/">Fedora docs for Adding Layered Packages</a>. For most packages,
you should not install them this way, but you should prefer installing
them inside of a toolbox / distrobox container instead. On the Fedora
Atomic host, you should install (layer) only those packages that
cannot be run from a container (or you really just want to run them
natively for some reason).
</p>

<p>
To create efficient layers, <b>you should try to install everything in
one go</b>, using as few layers as possible. Here is a list of packages
you might want to add all together as one layer:
</p>

<div class="run" id="org4d1e3af">
<p>
sudo rpm-ostree install qemu-kvm libvirt virt-manager virt-viewer \
     virt-install libvirt-daemon-config-network libvirt-daemon-kvm \
     libguestfs-tools python3-libguestfs virt-top net-tools \
     gvfs-smb gvfs-archive gvfs-nfs gvfs-fuse gvfs-mtp \
     distrobox file-roller thunar-volman
</p>

</div>

<p>
<a href="https://fedoraproject.org/atomic-desktops/sway/">Fedora Atomic Sway edition (Sericea) already includes a lot of
packages layered on top of the core Fedora Atomic.</a> So before you
install new things, check what comes preinstalled.
</p>
</div>
<div id="outline-container-org480f4bc" class="outline-3">
<h3 id="org480f4bc"><span class="section-number-3">5.1.</span> Examples of applications you might want to layer</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>File explorer (thunar) plugins for archives and removeable drives.</li>
<li>Virtual filesystem plugins (gvfs).</li>
<li>Container tools (Distrobox).</li>
<li>Virtual Machine tools (Qemu and libvirt).</li>
<li>Basic network tools (net-tools arp)</li>
</ul>

<p>
Web browsers are fickle. Although they mostly work inside toolbx
containers just fine, Sericea includes Firefox in its base layer as a
native app, and that seems to work great. However, I have also tested
Chromium inside of a toolbx container without issue. For use cases
where Chromium needs to have native USB access, you might not want to
run it in a container.
</p>
</div>
</div>
<div id="outline-container-orgf779a68" class="outline-3">
<h3 id="orgf779a68"><span class="section-number-3">5.2.</span> Check the list of layers:</h3>
<div class="outline-text-3" id="text-5-2">
<div class="run" id="org519e9b1">
<p>
sudo rpm-ostree status
</p>

</div>

<p>
The top layer should list the <code>LayeredPackages</code> in your new layer.
</p>

<p>
Reboot.
</p>
</div>
</div>
<div id="outline-container-orgcbe409b" class="outline-3">
<h3 id="orgcbe409b"><span class="section-number-3">5.3.</span> Reset all layers back to stock</h3>
<div class="outline-text-3" id="text-5-3">
<div class="notice" id="orgbf9fcd9">
<p>
This will reset all the layered packages back to the stock image. This
may be useful if you are trying to clean up from lots of testing.
</p>

<p>
<b>All package layers will be destroyed!</b>
</p>

<p>
Your user home directories (<code>/var/home/</code>) and system configuration
(<code>/etc/</code>) are not affected.
</p>

<div class="run" id="org091ab88">
<p>
sudo rpm-ostree reset
sudo rpm-ostree cleanup -r
</p>

</div>

</div>
</div>
</div>
</div>
<div id="outline-container-org515cd5b" class="outline-2">
<h2 id="org515cd5b"><span class="section-number-2">6.</span> Config</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orgbdbe90a" class="outline-3">
<h3 id="orgbdbe90a"><span class="section-number-3">6.1.</span> Config</h3>
<div class="outline-text-3" id="text-6-1">
<div class="index" id="org40d1571">
<p>
index
</p>

</div>
</div>
</div>
<div id="outline-container-org3cf3af0" class="outline-3">
<h3 id="org3cf3af0"><span class="section-number-3">6.2.</span> Sway</h3>
<div class="outline-text-3" id="text-6-2">
<p>
<a href="https://github.com/swaywm/sway?tab=readme-ov-file#readme">Sway</a> is a reimagining of <a href="https://i3wm.org/">i3wm</a> (X11), rewritten for Wayland. Sway (like
i3wm) is a keyboard centric tiling window manager. Although not a
source fork of i3wm, the configuration and user interface of Sway is
almost identical to that of i3wm.
</p>
</div>
<div id="outline-container-org08d17f5" class="outline-4">
<h4 id="org08d17f5"><span class="section-number-4">6.2.1.</span> Sway Config</h4>
<div class="outline-text-4" id="text-6-2-1">
<p>
The Fedora Atomic Sway edition includes a default configuration for
Sway. It's pretty nice out of the box, and so if you like it, you can
just use it. However, I use <a href="https://github.com/enigmacurry/sway-home">my own custom configuration</a> that I replace
it with, and you can do the same if you like.
</p>

<p>
Open the default terminal emulator (foot) with the keyboard shortcut:
<code>Win+Enter</code> (hold down the "Windows" key on your keyboard, then
simultaneously press Enter.)
</p>

<p>
My custom config replaces several of the default configuration files.
So you must first get rid of these files, by renaming them with the
suffix <code>.orig</code> for posterity:
</p>

<div class="run" id="org9cde0ef">
<p>
mv ~/.config ~/.config.orig
mv ~/.bashrc ~/.bashrc.orig
mv ~/.bash<sub>profile</sub> ~/.bash<sub>profile.orig</sub>
</p>

</div>

<p>
Next, install my <a href="https://github.com/enigmacurry/sway-home">customized sway config repository</a> :
</p>

<div class="run" id="org5663e7b">
<p>
git clone <a href="https://github.com/enigmacurry/sway-home">https://github.com/enigmacurry/sway-home</a> \
  ~/git/vendor/enigmacurry/sway-home
</p>

</div>

<p>
Run the included setup script:
</p>

<div class="run" id="org396419b">
<p>
cd ~/git/vendor/enigmacurry/sway-home
./setup.sh
</p>

</div>

<p>
The <code>setup.sh</code> script will make <a href="https://github.com/EnigmaCurry/sway-home/blob/master/setup.sh#L57-L61">symlinks</a> to the repository files from
the same original paths as the files you just moved. It also asks you
some questions to help setup your git profile.
</p>

<p>
Once you have finished entering the information setup asks for, press
<code>Win+Shift+E</code>, and choose Log Out. Log back in, and this will load the
new config files.
</p>
</div>
</div>
<div id="outline-container-orgead72b2" class="outline-4">
<h4 id="orgead72b2"><span class="section-number-4">6.2.2.</span> Setup display resolutions and orientation</h4>
<div class="outline-text-4" id="text-6-2-2">
<p>
Fedora Sway Atomic ships with <a href="https://git.sr.ht/~emersion/kanshi">kanshi</a> for display setup. Kanshi does
not include any GUI for setting it up, so another program called
<a href="https://github.com/artizirk/wdisplays">wdisplays</a> is useful, however it is not included in the base Atomic
distribution, and you will have to install it via <a href="file:///linux-workstation/toolbox">toolbox</a>.
</p>

<div class="run" id="org4298999">
<p>
sudo dnf install wdisplays
</p>

</div>

<p>
You can configure all of your displays using the wdisplays GUI
program, however, the configuration will not persist across login
sessions. So what you need to do is set it up how you like it, and
then transfer that information into the Kanshi config file so that it
sets it up the same way everytime you login.
</p>

<p>
For example, on my test system I have two display port monitors, with
outputs named <code>DP-3</code> and <code>DP-4</code>. These are shown in wdisplays and I
have set up the size, position, and DPI scaling exactly how I like it:
</p>

<p>
DP-3:
</p>


<div id="org221c51a" class="figure">
<p><img src="file:///img/wdisplays1.webp" alt="wdisplays1.webp" />
</p>
</div>

<p>
DP-4:
</p>


<div id="org0e371b0" class="figure">
<p><img src="file:///img/wdisplays2.webp" alt="wdisplays2.webp" />
</p>
</div>

<p>
Open the Kanshi config file <code>~/.config/kanshi/config</code> and copy the
information into the config file:
</p>

<div class="edit" id="org57f8cdb">
<p>
profile {
   output DP-3 enable mode 2560x1440 position 3840,0 scale 1 transform normal
   output DP-4 enable mode 3840x2160 position 1920,360 scale 2 transform normal
}
</p>

</div>

<p>
Check out <code>man 5 kanshi</code> for more config options. Kanshi is
<a href="https://github.com/EnigmaCurry/sway-home/blob/9a7af6fbd60a671a7059ba7bd35f35c2ec3cbd1f/config/sway/config.d/autostart_applications#L2">automatically started</a> when sway is, so you can test it by logging out
and logging back in.
</p>
</div>
</div>
</div>
<div id="outline-container-orgc28d729" class="outline-3">
<h3 id="orgc28d729"><span class="section-number-3">6.3.</span> Firefox</h3>
<div class="outline-text-3" id="text-6-3">
<p>
Fedora Atomic ships with the Firefox browser preinstalled. This
section describes how I like to set it up.
</p>
</div>
<div id="outline-container-org7975dcb" class="outline-4">
<h4 id="org7975dcb"><span class="section-number-4">6.3.1.</span> Remove clutter</h4>
<div class="outline-text-4" id="text-6-3-1">
</div>
<ol class="org-ol">
<li><a id="org62e4337"></a>Remove <code>Firefox View</code>, right click the upper left icon and select <code>Remove from toolbar</code>.<br />
<div class="outline-text-5" id="text-6-3-1-1">

<div id="orgf384058" class="figure">
<p><img src="file:///img/firefox/firefox-view.webp" alt="firefox-view.webp" />
</p>
</div>
</div>
</li>
<li><a id="orgf84f151"></a>Remove existing bookmarks from bookmark bar, right click each one and select <code>Delete</code>.<br /></li>

<li><a id="orge3e835c"></a>Remove <code>Pocket</code>, right click the pocket icon in the upper right toolbar, select <code>Remove from toolbar</code><br />
<div class="outline-text-5" id="text-6-3-1-3">

<div id="org2f8790a" class="figure">
<p><img src="file:///img/firefox/firefox-pocket.webp" alt="firefox-pocket.webp" />
</p>
</div>
</div>
</li>
<li><a id="org8b5f0fc"></a>Remove <code>Firefox Account</code> icon, select <code>Remove from toolbar</code><br />
<div class="outline-text-5" id="text-6-3-1-4">

<div id="orgf42eba5" class="figure">
<p><img src="file:///img/firefox/firefox-account.webp" alt="firefox-account.webp" />
</p>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org6717247" class="outline-4">
<h4 id="org6717247"><span class="section-number-4">6.3.2.</span> Firefox Settings</h4>
<div class="outline-text-4" id="text-6-3-2">
<p>
Go into the Firefox settings: click the "hamburger" menu in the top
right toolbar. Select <code>Settings</code>.
</p>


<div id="org74f2663" class="figure">
<p><img src="file:///img/firefox/firefox-settings.webp" alt="firefox-settings.webp" />
</p>
</div>
</div>
<ol class="org-ol">
<li><a id="org2cc9e64"></a>General Settings<br />
<ol class="org-ol">
<li><a id="orgf2f472f"></a>Select <code>Open previous windows and tabs</code><br /></li>

<li><a id="orgee51d17"></a>Turn on Dark mode<br />
<div class="outline-text-6" id="text-6-3-2-1-2">

<div id="orgcecb808" class="figure">
<p><img src="file:///img/firefox/firefox-general.webp" alt="firefox-general.webp" />
</p>
</div>
</div>
</li>
<li><a id="orgf65b8b9"></a>Turn off <code>Recommend extensions as you browse</code><br /></li>

<li><a id="org5799931"></a>Turn off <code>Recommend features as you browse</code><br />
<div class="outline-text-6" id="text-6-3-2-1-4">

<div id="orgf661189" class="figure">
<p><img src="file:///img/firefox/firefox-browsing.webp" alt="firefox-browsing.webp" />
</p>
</div>
</div>
</li>
</ol>
</li>
<li><a id="org87bf54e"></a>Home settings<br />
<ol class="org-ol">
<li><a id="orgccf481d"></a><code>New Windows and Tabs</code><br />
<div class="outline-text-6" id="text-6-3-2-2-1">
<p>
Select <code>Blank Page</code> for both new windows and tabs.
</p>


<div id="orgb4842b3" class="figure">
<p><img src="file:///img/firefox/firefox-home.webp" alt="firefox-home.webp" />
</p>
</div>
</div>
</li>
<li><a id="org1806a2f"></a>Firefox Home Content<br />
<div class="outline-text-6" id="text-6-3-2-2-2">
<p>
The home content won't show if you set <code>Blank Page</code> above, but I go
ahead and turn off all the home stuff anyway.
</p>
</div>
</li>
</ol>
</li>
<li><a id="org26a4201"></a>Search Settings<br />
<ol class="org-ol">
<li><a id="orgc9c5301"></a>Choose a non-Google default search engine, eg. <code>DuckDuckGo</code>.<br /></li>

<li><a id="org22e8d05"></a>Turn off all Search Suggestions<br /></li>

<li><a id="org8612cde"></a>Delete all the corporate Search Shortcuts other than your preferred one (eg. DuckDuckGo).<br />
<div class="outline-text-6" id="text-6-3-2-3-3">
<p>
You can select each one and click <code>Remove</code> or you can press the Delete
key. Delete Google, Amazon, Bing, eBay, Wikipedia etc.
</p>


<div id="orgb266e51" class="figure">
<p><img src="file:///img/firefox/firefox-search.webp" alt="firefox-search.webp" />
</p>
</div>
</div>
</li>
</ol>
</li>
<li><a id="orga04ad52"></a>Privacy &amp; Security settings<br />
<ol class="org-ol">
<li><a id="orgbb4ab27"></a>Enhanced Tracking Protection, select <code>Strict</code><br /></li>

<li><a id="org6200783"></a>Set <code>Do Not Track</code> to <code>Always</code><br />
<div class="outline-text-6" id="text-6-3-2-4-2">

<div id="orgc4d485c" class="figure">
<p><img src="file:///img/firefox/firefox-privacy-1.webp" alt="firefox-privacy-1.webp" />
</p>
</div>
</div>
</li>
<li><a id="org7541d6d"></a>Logins and Passwords<br />
<div class="outline-text-6" id="text-6-3-2-4-3">
<p>
Unselect <code>Suggest Firefox relay email masks</code>
</p>

<p>
Unselect <code>Show alerts about passwords for breached websites</code> (You
already use unique passwords for every website, right??)
</p>
</div>
</li>
<li><a id="orgea93642"></a>IMPORTANT: select <code>Use a Primary Password</code><br />
<div class="outline-text-6" id="text-6-3-2-4-4">

<div id="orgbeb1643" class="figure">
<p><img src="file:///img/firefox/firefox-privacy-2a.webp" alt="firefox-privacy-2a.webp" />
</p>
</div>

<p>
Without setting a primary password, any password that firefox saves
will be <b><b>unencrypted</b></b>! You must set a primary (master) password, and
you will need to type it in each time you restart your browser, to
unlock the password manager.
</p>
</div>
</li>
<li><a id="orgc5c69d1"></a>Address Bar - Firefox Suggest<br />
<div class="outline-text-6" id="text-6-3-2-4-5">
<p>
Unselect <code>Search engines</code>
</p>

<p>
Unselect <code>Suggestions from the web</code>
</p>

<p>
Unselect <code>Suggestions from sponsors</code>
</p>


<div id="orgc06ca24" class="figure">
<p><img src="file:///img/firefox/firefox-privacy-2b.webp" alt="firefox-privacy-2b.webp" />
</p>
</div>
</div>
</li>
<li><a id="orgc6e9eca"></a>Firefox Data Collection and Use<br />
<div class="outline-text-6" id="text-6-3-2-4-6">
<p>
Unselect everything here.
</p>


<div id="org4a68812" class="figure">
<p><img src="file:///img/firefox/firefox-privacy-3a.webp" alt="firefox-privacy-3a.webp" />
</p>
</div>
</div>
</li>
<li><a id="org53a1b52"></a>HTTPs-Only mode<br />
<div class="outline-text-6" id="text-6-3-2-4-7">
<p>
Choose <code>Enable HTTPS-Only Mode in all windows</code>
</p>


<div id="orgad3b8d3" class="figure">
<p><img src="file:///img/firefox/firefox-privacy-3b.webp" alt="firefox-privacy-3b.webp" />
</p>
</div>
</div>
</li>
<li><a id="org91fb5ad"></a>DNS over HTTPS<br />
<div class="outline-text-6" id="text-6-3-2-4-8">
<p>
Especially if you use a portable laptop, or connect to various WiFi
access points, you should choose <code>Max Protection</code>.
</p>


<div id="org672b9b3" class="figure">
<p><img src="file:///img/firefox/firefox-dns.webp" alt="firefox-dns.webp" />
</p>
</div>
</div>
</li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-org1240a47" class="outline-4">
<h4 id="org1240a47"><span class="section-number-4">6.3.3.</span> Extensions and Themes</h4>
<div class="outline-text-4" id="text-6-3-3">
<p>
From the Settings menu, near the bottom, click <code>Extensions &amp; Themes</code>.
</p>
</div>
<ol class="org-ol">
<li><a id="orgf87a1a6"></a>Themes<br />
<div class="outline-text-5" id="text-6-3-3-1">
<p>
Choose a theme you like. For example, click <code>Dark</code> and then click <code>Enable</code>.
</p>
</div>
</li>
<li><a id="org2705409"></a>Extensions<br />
<div class="outline-text-5" id="text-6-3-3-2">
<p>
Go to <a href="https://addons.mozilla.org">addons.mozilla.org</a> and install the following extensions:
</p>

<p>
<a href="https://addons.mozilla.org/en-US/firefox/addon/darkreader/">Dark Reader</a>
</p>

<p>
Dark reader makes all sites darker, and you can customize each site by
clicking on the Dark Reader extension in the menu bar.
</p>

<p>
<a href="https://addons.mozilla.org/en-US/firefox/addon/ublock-origin">Ublock Origin</a>
</p>

<p>
Disables almost all ads on all websites. There's not much to configure
here, it basically works out of the box. However, you can customize it
per site if you want to enable ads on certain pages.
</p>

<p>
<a href="https://addons.mozilla.org/en-US/firefox/addon/noscript">NoScript</a>
</p>

<p>
By default, all sites will have javascript disabled. On each site you
trust, you can customize the javascript availability by clicking the
NoScript extension in the menu bar.
</p>

<p>
<a href="https://addons.mozilla.org/en-US/firefox/addon/adsum-notabs">No Tabs</a>
</p>

<p>
If you're using a tiling window manager (Sway), you might consider
disabling Firefox tabs, and have every site in its own window instead.
This extension does that.
</p>

<p>
<a href="https://addons.mozilla.org/en-US/firefox/addon/vimium-ff/">Vimium</a>
</p>

<p>
Once vimium is installed, click the icon in the menu bar and click
<code>Enable all hosts permission</code>.
</p>

<p>
<a href="https://addons.mozilla.org/en-US/firefox/addon/multi-account-containers/">Firefox Multi-Account Containers</a>
</p>

<p>
Read about <a href="https://support.mozilla.org/en-US/kb/containers">how to use Firefox Containers</a>. Configure sites you trust to
open in specific containers, that way you can save your cookies per
container. By default, new sites will always open in temporary ones,
and so when you close your browser all the cookies for that site
disappears.
</p>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-org16f8b48" class="outline-3">
<h3 id="org16f8b48"><span class="section-number-3">6.4.</span> Toolbox</h3>
<div class="outline-text-3" id="text-6-4">
<p>
<a href="https://docs.fedoraproject.org/en-US/fedora-silverblue/toolbox/">Toolbox</a> is an integral part of Fedora Atomic, being one of the main
methods of installing software (the alternative being Flatpak), it
lets you run your applications inside of <a href="https://podman.io">Podman</a> containers. Toolbox
can actually be used on any Linux system that is capable of running
Podman, but is especially useful on Atomic hosts. Toolbox is more
tightly integrated with your host OS than Docker or Podman containers
normally are. Toolbox containers share the same <code>/home</code> directory with
the host (bind mounted), and they live in the same network and process
namespace as the host (ie. you can run <code>ps</code> or <code>kill</code> from inside the
toolbox, and it will see/affect the host.) Toolbox containers are not
sandboxed like normal Docker containers are, but they are a
convenience for installing/removing software on Atomic hosts, because
theres not really any other way (since the host filesystem is
read-only). The applications you install in the container will live
only inside the toolbox.
</p>

<p>
The killer feature of a toolbox is that it lets you try things out,
and if you want to start over, you can just delete the toolbox
container, and create a new one. You are less likely to mess up the
host by playing around inside the toolbox. Just remember that <code>/home</code>
is bind mounted to the host, and so if you change or delete things in
those directories, they are also affected the same way on the host.
</p>
</div>
<div id="outline-container-org4e7d687" class="outline-4">
<h4 id="org4e7d687"><span class="section-number-4">6.4.1.</span> Dev toolbox (Fedora)</h4>
<div class="outline-text-4" id="text-6-4-1">
<p>
Let's create a toolbox to install some of the common development tools
we will use on a daily basis.
</p>

<div class="run" id="org9a1f220">
<p>
toolbox create dev
</p>

</div>

<p>
This will create a new toolbox container called <code>dev</code> based upon the
same Fedora version as the host (the toolbox itself is not Atomic
though, but the normal Fedora Workstation version instead.)
</p>

<p>
To enter the toolbox run:
</p>

<div class="run" id="org17b60a4">
<p>
toolbox enter dev
</p>

</div>

<p>
This will enter the toolbox container, and now you can install extra
software:
</p>

<div class="run" id="orgdb3443e">
<p>
sudo dnf install keychain htop
sudo dnf groupinstall "Development Tools" "Development Libraries"
</p>

</div>
</div>
</div>
<div id="outline-container-org552537b" class="outline-4">
<h4 id="org552537b"><span class="section-number-4">6.4.2.</span> Arch Linux toolbox</h4>
<div class="outline-text-4" id="text-6-4-2">
<p>
You are not limited to running Fedora toolboxes, in fact you can run
any container image you want, or even build your own from a
<code>Dockerfile</code>. Here is a Dockerfile for Arch Linux you can use to build
an Arch Linux toolbox container:
</p>

<div class="edit" id="orgf261f23">
<p>
FROM docker.io/archlinux/archlinux:latest
ENV NAME=arch-toolbox VERSION=rolling
LABEL com.github.containers.toolbox="true" \
  name="$NAME" \
  version="$VERSION"
RUN pacman -Syu &#x2013;noconfirm \
    &amp;&amp; pacman  -S &#x2013;noconfirm sudo inetutils less \
       git base-devel go \
       noto-fonts noto-fonts-cjk \
       noto-fonts-emoji noto-fonts-extra \
    &amp;&amp; pacman -Scc &#x2013;noconfirm \
    &amp;&amp; echo "%wheel ALL=(ALL) NOPASSWD: ALL" &gt; /etc/sudoers.d/toolbox
RUN sudo -u nobody git clone <a href="https://aur.archlinux.org/yay-bin.git">https://aur.archlinux.org/yay-bin.git</a> /tmp/yay \
    &amp;&amp; cd /tmp/yay \
    &amp;&amp; sudo -u nobody makepkg -s \
    &amp;&amp; pacman -U &#x2013;noconfirm yay-bin-*.pkg.tar.zst
CMD ["bash"]
</p>

</div>

<p>
Write this to a file named <code>Dockerfile</code> and open your host terminal to
the same directory. Then run this command to build the container:
</p>

<div class="run" id="orgc222170">
<p>
podman build -t arch .
</p>

</div>

<p>
Now you can create a new toolbox based on the new image (both called
<code>arch</code>):
</p>

<div class="run" id="orgafe660f">
<p>
toolbox create &#x2013;image arch arch
</p>

</div>

<p>
To enter the Arch Linux container, run:
</p>

<div class="run" id="orga3937c6">
<p>
toolbox enter arch
</p>

</div>

<p>
Now that you're inside the toolbox, you can run any Arch Linux command
(consult the <a href="http://wiki.archlinux.org/">Arch Wiki</a>).
</p>

<div class="run" id="org310d86f">
<p>
sudo pacman -Syu
sudo pacman -S keychain base-devel
</p>

</div>
</div>
</div>
<div id="outline-container-org7b133a9" class="outline-4">
<h4 id="org7b133a9"><span class="section-number-4">6.4.3.</span> Managing toolbox containers</h4>
<div class="outline-text-4" id="text-6-4-3">
<p>
You can list all of your toolboxes that you've created:
</p>

<div class="run" id="orgf94443d">
<p>
toolbox list
</p>

</div>

<p>
You can remove existing toolboxes:
</p>

<div class="run" id="orgad52922">
<p>
toolbox rm &#x2013;force arch
</p>

</div>

<p>
(force is only required if the toolbox is currently running.)
</p>
</div>
</div>
</div>
<div id="outline-container-org4e17c49" class="outline-3">
<h3 id="org4e17c49"><span class="section-number-3">6.5.</span> Emacs</h3>
<div class="outline-text-3" id="text-6-5">
<p>
<a href="https://www.gnu.org/software/emacs/">Emacs</a> is my long time favorite code editor (IDE) and for writing
documentation (including this book).
</p>
</div>
<div id="outline-container-orgf921935" class="outline-4">
<h4 id="orgf921935"><span class="section-number-4">6.5.1.</span> Install Emacs</h4>
<div class="outline-text-4" id="text-6-5-1">
<p>
Because Sway runs on Wayland, you'll want to install the Wayland
(pgtk) version of Emacs. In Fedora 40 onwards, the Wayland (pgtk)
version is already the default. For Fedora 39, <a href="https://copr.fedorainfracloud.org/coprs/enigm-a/emacs-pgtk-nativecomp">you can use this COPR</a>
(a COPR is to Fedora what PPA is to Ubuntu and what AUR is to Arch
Linux), which includes a custom build for Wayland (pgtk).
</p>

<p>
To enable this, you need to be running your dev toolbox:
</p>

<div class="run" id="org0a75edd">
<p>
toolbox enter dev
</p>

</div>

<p>
Install Emacs:
</p>

<div class="run" id="org7b00aa7">
<p>
sudo dnf install emacs
</p>

</div>
</div>
</div>
<div id="outline-container-orgd52195e" class="outline-4">
<h4 id="orgd52195e"><span class="section-number-4">6.5.2.</span> Create Emacs script</h4>
<div class="outline-text-4" id="text-6-5-2">
<p>
In order to be able to quickly launch Emacs inside the toolbox from
the host, you will need a little script installed on the host.
</p>

<p>
You can create this script and put it in <code>/usr/local/bin/emacs</code>. Run
this on the host (not in the toolbox), to create it as the root user:
</p>

<div class="edit" id="org2bd7825">
<p>
#!/bin/bash
## Run Emacs in the dev toolbox and pass it any args:
toolbox run -c dev emacs $@
</p>

</div>

<div class="run" id="org2372184">
<p>
sudo chmod a+x /usr/local/bin/emacs
</p>

</div>

<p>
Now you can run Emacs from the host, and it will run inside the
Toolbox.
</p>
</div>
</div>
<div id="outline-container-orgfebc739" class="outline-4">
<h4 id="orgfebc739"><span class="section-number-4">6.5.3.</span> Install dependencies</h4>
<div class="outline-text-4" id="text-6-5-3">
<p>
Most Emacs packages are written in Emacs Lisp, and therefore have no
external dependencies. The one exception is for Vterm terminal
support, which requires compiling a C library (libvterm). This
compilation can be done automatically by Emacs, but it requires you
have some tools preinstalled:
</p>

<ul class="org-ul">
<li>CMake</li>
<li>libtool</li>
</ul>

<p>
Install the dependencies inside the toolbox:
</p>

<div class="run" id="orgc1ec66a">
<p>
sudo dnf install cmake libtool
</p>

</div>
</div>
</div>
<div id="outline-container-orgb5e2779" class="outline-4">
<h4 id="orgb5e2779"><span class="section-number-4">6.5.4.</span> Remove any existing Emacs config</h4>
<div class="outline-text-4" id="text-6-5-4">
<p>
Assuming you want to use my Emacs config, you need to delete any
existing config you already have. Also note that Emacs creates a
default config the first time it runs, so if you started Emacs
already, you may have a config and not even know it.
</p>

<p>
Here's how to remove the existing Emacs config:
</p>

<div class="run" id="orgffc41b4">
<p>
rm ~/.emacs ~/.emacs.d -rf
</p>

</div>
</div>
</div>
<div id="outline-container-org3c87781" class="outline-4">
<h4 id="org3c87781"><span class="section-number-4">6.5.5.</span> Install my Emacs config</h4>
<div class="outline-text-4" id="text-6-5-5">
<p>
<a href="https://github.com/EnigmaCurry/emacs">My Emacs config is on github</a>. Install it with the following script:
</p>

<div class="run" id="orgdee0927">
<p>
REMOTE=git@github.com:EnigmaCurry/emacs.git
REPO=${HOME}/git/vendor/enigmacurry/emacs
BRANCH=straight
</p>

<p>
(set -e
test -d ~/.emacs.d &amp;&amp; (echo "~/.emacs.d already exists. Aborting install." &amp;&amp; exit 1)
test -d ${REPO} || git clone -b ${BRANCH} ${REMOTE} ${REPO}
mkdir ~/.emacs.d &amp;&amp; ls -1 ${REPO}/*.el | xargs -iXX ln -s XX ~/.emacs.d
mkdir ~/.emacs.d/straight &amp;&amp; ln -s ${REPO}/straight-versions ~/.emacs.d/straight/versions
ln -s ${REPO}/snippets ~/.emacs.d/snippets
)
</p>

</div>
</div>
</div>
<div id="outline-container-org1127a7c" class="outline-4">
<h4 id="org1127a7c"><span class="section-number-4">6.5.6.</span> Start Emacs to finish the installation</h4>
<div class="outline-text-4" id="text-6-5-6">
<p>
The first time Emacs starts, it will install all of the dependencies
listed in the main config file <code>~/.emacs.d/init.el</code>.
</p>

<p>
Run:
</p>

<div class="run" id="org571a4c2">
<p>
emacs
</p>

</div>

<p>
Wait for everything to install. You may see a blank screen for up to
10 minutes, but you should see some minimal information of the
progress in the bottom minibuffer.
</p>

<p>
If it gets stuck at any point, quit and restart it, and it should
continue where it left off. If you get any error message, you may want
to start Emacs again with debug mode turned on:
</p>

<div class="run" id="orge0d3e75">
<p>
emacs &#x2013;debug-init
</p>

</div>

<p>
This will usually give you a more verbose error message which can be
helpful in debugging the startup.
</p>
</div>
</div>
<div id="outline-container-orgb50965f" class="outline-4">
<h4 id="orgb50965f"><span class="section-number-4">6.5.7.</span> Read the README for my config</h4>
<div class="outline-text-4" id="text-6-5-7">
<p>
More notes are available in the <a href="https://github.com/EnigmaCurry/emacs#readme">README</a>.
</p>
</div>
</div>
</div>
<div id="outline-container-orgff31cf8" class="outline-3">
<h3 id="orgff31cf8"><span class="section-number-3">6.6.</span> SSH</h3>
<div class="outline-text-3" id="text-6-6">
<p>
SSH (secure shell) is a secure networking tool used between a client
and a server. Using an encrypted network protocol, it can be used to
securely login to a server remotely, as well as for more advanded
networking scenarios. Typical use cases for SSH include:
</p>

<ul class="org-ul">
<li>Access to a server's console shell, remotely.</li>
<li>Transfer files between the server and client (using <code>rsync</code>, <code>scp</code>,
or <code>sftp</code>).</li>
<li>Create network tunnels to access private servers, in both
directions, either on the server, or on the client.</li>
<li>Create a server that acts as a bastion or "jump" host, to be a port
of entry into a larger private network. SSH is configured to only
allow authorized client keys access through the bastion host.</li>
<li>Create a server to act as an HTTP (socks) client proxy, to allow
remote clients to browse the web, using the server's IP address as
the origin.</li>
<li>Remote controlling a Docker server using the <code>docker</code> command line
client (SSH Docker Context).</li>
</ul>

<p>
SSH is based upon public key cryptography. Both the client and the
server need to create their own public/private keypair. Keys can be
encrypted on disk (eg. <code>~/.ssh/id_ecdsa</code>) or they may also be loaded
from a USB hardware token. Upon connecting to a remote server for the
first time, the client asks the user to validate the server's public
key fingerprint, and then the server's public key is written into a
file called <code>~/.ssh/known_hosts</code>, which marks the connection as
trusted from then on. The server also authorizes the client through a
predefined <code>authorized_keys</code> file. If either side rejects the key
presented by the other, the connection is unauthorized, and is closed
immediately.
</p>
</div>
<div id="outline-container-org3844cd0" class="outline-4">
<h4 id="org3844cd0"><span class="section-number-4">6.6.1.</span> Create SSH Keys</h4>
<div class="outline-text-4" id="text-6-6-1">
<p>
This book recommends the use of hardware authentication tokens, like
the <a href="https://solokeys.com/">Solokey</a>. Traditional SSH keyfiles are also acceptable, but these
should be considered as a legacy format, as they are less secure.
Finally, plain password authentication (non-key based) is fully
deprecated and should <b>never</b> be used.
</p>
</div>
<ol class="org-ol">
<li><a id="orgd2d5ba9"></a>Setup Solokey (FIDO2) hardware authentication<br />
<div class="outline-text-5" id="text-6-6-1-1">
<p>
Plug in your Solokey (or compatible hardware) to the USB port.
</p>

<p>
Initialize the hardware with a new SSH key:
</p>

<div class="run" id="orgaac2fd8">
<p>
## You only need to do this one time per solokey!
ssh-keygen -t ed25519-sk -O resident -O verify-required
</p>

</div>

<p>
You will be required to create/enter a PIN for the Solokey.
</p>
</div>
</li>
<li><a id="org793fd48"></a>Traditional SSH keyfiles<br />
<div class="outline-text-5" id="text-6-6-1-2">
<p>
The Solokey still has some drawbacks, and cannot be used in all cases.
Traditional SSH keyfiles are still useful for automated and unattended
clients. Technically, the solokey is supposed to be able to work in a
"touchless" mode, by using the <code>-O no-touch-required</code> option, but I
never got this to work.
</p>

<p>
Key files should be created uniquely for each user and workstation.
They should never be shared between multiple users or workstations.
</p>
</div>
<ol class="org-ol">
<li><a id="orgd5c8ae1"></a>Choosing the SSH key type<br />
<div class="outline-text-6" id="text-6-6-1-2-1">
<p>
It is recommended to use the newer <code>ed25519</code> key type, which uses the
latest encryption standards. Your distribution may still use the older
standard <code>rsa</code> by default (which is acceptable). You should explicitly
select the key type when creating the keyfile to be sure.
</p>

<p>
Some older servers don't accpet <code>ed25519</code> keys, and so in those cases
you should still create an <code>rsa</code> key as well. Each key type is stored
in a different file, so its OK to have multiple types installed on the
same machine.
</p>
</div>
</li>
<li><a id="org3b67a44"></a>Create the new SSH keys<br />
<div class="outline-text-6" id="text-6-6-1-2-2">
<p>
Create the <code>rsa</code> key type:
</p>

<div class="run" id="org318fe0f">
<p>
ssh-keygen -t rsa -f ~/.ssh/id<sub>rsa</sub>
</p>

</div>

<p>
Create the <code>ed25519</code> key type:
</p>

<div class="run" id="org1e39783">
<p>
ssh-keygen -t ed25519 -f ~/.ssh/id<sub>ed25519</sub>
</p>

</div>

<p>
You will be prompted to enter an encryption passphrase for each file,
which you should definitely not skip!
</p>
</div>
</li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-org5e385a7" class="outline-4">
<h4 id="org5e385a7"><span class="section-number-4">6.6.2.</span> Setup the ssh-agent</h4>
<div class="outline-text-4" id="text-6-6-2">
<p>
Because your keyfiles are encrypted with a passphrase, you need to
enter the passphrase everytime you use it. This is inconvenient, so
you can run <code>ssh-agent</code> to temporarily store your key/identity in
memory, and therefore you only need to enter your passphrase once,
when you log in. (In the case of the solokey, the key is never held in
memory, but you still need to hold the identity of it in the
ssh-agent.)
</p>

<p>
Keychain is a program that helps you setup the ssh-agent. Install
<code>keychain</code>:
</p>

<div class="run" id="org1163540">
<p>
sudo dnf install keychain
</p>

</div>

<div class="run" id="orgc3b57e6">
<p>
sudo apt install keychain
</p>

</div>

<div class="run" id="org0542a99">
<p>
sudo pacman -S keychain
</p>

</div>

<p>
To configure keychain, edit your <code>~/.bashrc</code> file:
</p>

<div class="edit" id="orga1b0564">
<p>
## Put this line in your ~/.bashrc:
## (If you're using my config, this is already in it.)
eval $(keychain &#x2013;eval &#x2013;quiet)
</p>

</div>

<p>
Log out of your desktop session, and log back in. Open your terminal,
and you should be automatically prompted to enter your SSH passphrase.
Once you have entered the passphrase, the SSH key will remain resident
in memory until you log out.
</p>

<p>
Double check that the key has been loaded, run:
</p>

<div class="run" id="org6a50687">
<p>
ssh-add -L
</p>

</div>

<p>
The above should print your public key, loaded into the running
<code>ssh-agent</code>. Now you should be able to use your key without entering a
passphrase. Copy the output and upload it to your services as your
authorized key. For servers, put the key into
<code>~/.ssh/authorized_keys</code>. For hosted services, like GitHub, paste the
key into your SSH settings page.
</p>
</div>
</div>
<div id="outline-container-org074e06f" class="outline-4">
<h4 id="org074e06f"><span class="section-number-4">6.6.3.</span> Add your solokey identity per session</h4>
<div class="outline-text-4" id="text-6-6-3">
<p>
Apparently, keychain does not yet know how to load the Solokey
automatically. You must add the Solokey to the ssh-agent manually, one
time, each time you boot your workstation:
</p>

<div class="run" id="orgdb0ac82">
<p>
## Do this to load your Solokey into the ssh-agent:
ssh-add -K
</p>

</div>

<p>
You will be prompted one time to enter your Solokey pin to unlock the
key.
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org355b095" class="outline-2">
<h2 id="org355b095"><span class="section-number-2">7.</span> KVM / libvirt</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org2d6f78f" class="outline-3">
<h3 id="org2d6f78f"><span class="section-number-3">7.1.</span> KVM / libvirt</h3>
<div class="outline-text-3" id="text-7-1">
<p>
You can bend the "No sworkstations" rule, a bit, by hosting some
development servers inside of virtual machines (VM). Your workstation
will stay clean, because these VMs are isolated from your normal
account, running under a dedicated VM user account instead. You can
treat these VMs just like any other remote Linux host, and access them
by (local) SSH connection, from your normal account, and you can
configure them to automatically start when your workstation boots.
</p>

<p>
These instructions will install a barebones Debian or Fedora server in
a VM, with NAT networking (private IP address, no public ports open),
for local development/testing purposes only.
</p>

<p>
These instructions have been tested as working on Fedora Atomic and
Arch Linux workstations.
</p>

<div class="index" id="orgc64b061">
<p>
index
</p>

</div>


<div class="toc" id="org7f40173">
<p>
table of contents
</p>

</div>
</div>
</div>
<div id="outline-container-orgb7c337f" class="outline-3">
<h3 id="orgb7c337f"><span class="section-number-3">7.2.</span> Setup libvirtd</h3>
<div class="outline-text-3" id="text-7-2">
</div>
<div id="outline-container-org460aab8" class="outline-4">
<h4 id="org460aab8"><span class="section-number-4">7.2.1.</span> Install libvirt packages</h4>
<div class="outline-text-4" id="text-7-2-1">
</div>
<ol class="org-ol">
<li><a id="orgf84b4be"></a>Fedora Atomic<br />
<div class="outline-text-5" id="text-7-2-1-1">
<div class="notice" id="org741d6ba">
<p>
If you are running Fedora Atomic, full package installation is covered
in the chapter on <a href="file:///linux-workstation/layering-packages">Layering packages</a>.
</p>

</div>
</div>
</li>
<li><a id="org23ec59b"></a>Arch Linux<br />
<div class="outline-text-5" id="text-7-2-1-2">
<div class="run" id="org53e201d">
<p>
sudo pacman -S libvirt iptables-nft dnsmasq qemu-base virt-install \
               sysfsutils bridge-utils ebtables git make which jq
</p>

</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgc7ef868" class="outline-4">
<h4 id="orgc7ef868"><span class="section-number-4">7.2.2.</span> Enable libvirtd service</h4>
<div class="outline-text-4" id="text-7-2-2">
<div class="run" id="org2b62001">
<p>
sudo systemctl enable &#x2013;now libvirtd
sudo systemctl status &#x2013;no-pager libvirtd
</p>

</div>
</div>
</div>
<div id="outline-container-orgc60cdc8" class="outline-4">
<h4 id="orgc60cdc8"><span class="section-number-4">7.2.3.</span> Start the default network</h4>
<div class="outline-text-4" id="text-7-2-3">
<div class="run" id="orgbb9d9cf">
<p>
virsh net-start default
virsh net-autostart default
</p>

</div>
</div>
</div>
<div id="outline-container-orgb64950a" class="outline-4">
<h4 id="orgb64950a"><span class="section-number-4">7.2.4.</span> Configure /etc/group</h4>
<div class="outline-text-4" id="text-7-2-4">
<p>
Add the existing <code>libvirt</code> group to <code>/etc/group</code>, if it isn't already:
</p>

<div class="run" id="org85e4bf6">
<p>
grep "<sup>libvirt</sup>:" /etc/group || sudo bash -c "getent group libvirt &gt;&gt; /etc/group"
</p>

</div>
</div>
</div>
</div>
<div id="outline-container-org201a0e9" class="outline-3">
<h3 id="org201a0e9"><span class="section-number-3">7.3.</span> Create VM admin</h3>
<div class="outline-text-3" id="text-7-3">
<p>
This will create a new user account on your workstation named
<code>libvirt-admin</code>. This user will be used as the owner for all the VM
disk images, config files, and for running the libvirt (qemu)
processes that run your VM.
</p>

<p>
This separation from the normal account you use is important to limit
the privileges that you have over the VM infrastructure. Your normal
account should be able to SSH <i>into</i> the VM and have full root
privleges inside the VM. But your normal account should <i>not</i> have
access to the underlying VM disk image files, nor its configuration.
Access to all VM administrative tasks must be done through <code>sudo</code> to
control the <code>libvirt-admin</code> account.
</p>
</div>
<div id="outline-container-orga75b168" class="outline-4">
<h4 id="orga75b168"><span class="section-number-4">7.3.1.</span> Create <code>libvirt-admin</code> user</h4>
<div class="outline-text-4" id="text-7-3-1">
<div class="run" id="org054bced">
<p>
VM<sub>ADMIN</sub>=libvirt-admin
sudo useradd -m ${VM<sub>ADMIN</sub>} -G libvirt
</p>

</div>
</div>
</div>
<div id="outline-container-orgc0aec4d" class="outline-4">
<h4 id="orgc0aec4d"><span class="section-number-4">7.3.2.</span> Configure systemd for the <code>libvirt-admin</code> user</h4>
<div class="outline-text-4" id="text-7-3-2">
<div class="run" id="org01d0211">
<p>
sudo loginctl enable-linger ${VM<sub>ADMIN</sub>}
sudo su ${VM<sub>ADMIN</sub>} -c "mkdir -p ~/.bashrc.d"
sudo su \({VM_ADMIN} -c "echo export XDG_RUNTIME_DIR=/run/user/\\)(id -u) &gt; ~/.bashrc.d/xdg"
</p>

</div>
</div>
</div>
<div id="outline-container-org7016ed3" class="outline-4">
<h4 id="org7016ed3"><span class="section-number-4">7.3.3.</span> Copy your public SSH key into the <code>libvirt-admin</code> home directory</h4>
<div class="outline-text-4" id="text-7-3-3">
<div class="run" id="org867cb3a">
<p>
SSH<sub>KEY</sub>=~/.ssh/id<sub>ed25519.pub</sub>
TMP<sub>SSH</sub>=$(mktemp)
cat ${SSH<sub>KEY</sub>} &gt; ${TMP<sub>SSH</sub>}
chmod a+r ${TMP<sub>SSH</sub>}
sudo su ${VM<sub>ADMIN</sub>:-libvirt-admin} -c "mkdir -p ~/libvirt &amp;&amp; cp ${TMP<sub>SSH</sub>} ~/libvirt/user-ssh.pub"
</p>

</div>
</div>
</div>
</div>
<div id="outline-container-orgf0595c1" class="outline-3">
<h3 id="orgf0595c1"><span class="section-number-3">7.4.</span> Configure VM</h3>
<div class="outline-text-3" id="text-7-4">
</div>
<div id="outline-container-orgb2f7970" class="outline-4">
<h4 id="orgb2f7970"><span class="section-number-4">7.4.1.</span> Choose hardware sizes</h4>
<div class="outline-text-4" id="text-7-4-1">
<div class="env" id="orge34d97e">
<p>
MEMORY=1024
CPUS=2
DISK<sub>SIZE</sub>=50
</p>

</div>
</div>
</div>
<div id="outline-container-org52129fa" class="outline-4">
<h4 id="org52129fa"><span class="section-number-4">7.4.2.</span> Choose cloud image</h4>
<div class="outline-text-4" id="text-7-4-2">
<p>
You can choose any standard cloud image that supports cloud-init.
</p>
</div>
<ol class="org-ol">
<li><a id="orgd949557"></a>Debian 12<br />
<div class="outline-text-5" id="text-7-4-2-1">
<div class="env" id="orgcbbf0fc">
<p>
OS<sub>VARIANT</sub>=debian12
CLOUD<sub>IMAGE</sub>=<a href="https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-generic-amd64.qcow2">https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-generic-amd64.qcow2</a>
</p>

</div>
</div>
</li>
<li><a id="org1fb865b"></a>Fedora 40<br />
<div class="outline-text-5" id="text-7-4-2-2">
<div class="env" id="orgb3ce407">
<p>
OS<sub>VARIANT</sub>=fedora40
CLOUD<sub>IMAGE</sub>=<a href="https://download.fedoraproject.org/pub/fedora/linux/releases/40/Cloud/x86_64/images/Fedora-Cloud-Base-Generic.x86_64-40-1.14.qcow2">https://download.fedoraproject.org/pub/fedora/linux/releases/40/Cloud/x86_64/images/Fedora-Cloud-Base-Generic.x86_64-40-1.14.qcow2</a>
</p>

</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgd0b2652" class="outline-4">
<h4 id="orgd0b2652"><span class="section-number-4">7.4.3.</span> Find the default subnet (<code>virbr0</code>)</h4>
<div class="outline-text-4" id="text-7-4-3">
<div class="run" id="orgc733ce3">
<p>
ip route | grep virbr0 | cut -d " " -f 1
</p>

</div>
<div class="stdout" id="org09b6cf2">
<p>
192.168.122.0/24
</p>

</div>
</div>
</div>
<div id="outline-container-org44dacaa" class="outline-4">
<h4 id="org44dacaa"><span class="section-number-4">7.4.4.</span> Configure Hostname, IP Address, and MAC address</h4>
<div class="outline-text-4" id="text-7-4-4">
<div class="env" id="org62e6b6b">
<p>
NAME=debian-dev
IP<sub>ADDRESS</sub>=192.168.122.2
MAC<sub>ADDRESS</sub>=$(printf '00:60:2F:%02X:%02X:%02X\n' $[RANDOM%256] $[RANDOM%256] | tr '[:upper:]' '[:lower:]')
</p>

</div>

<div class="notice" id="orgee0edfc">
<p>
You need to choose a valid IP<sub>ADDRESS</sub> in the range of your subnet. The
Gateway should be the same subnet with the address ending in <code>.1</code>. The
MAC address will be random.
</p>

</div>
</div>
</div>
<div id="outline-container-orgba1a21f" class="outline-4">
<h4 id="orgba1a21f"><span class="section-number-4">7.4.5.</span> Create static DHCP lease</h4>
<div class="outline-text-4" id="text-7-4-5">
<div class="run" id="orge8db8f7">
<p>
sudo virsh net-update default add-last ip-dhcp-host "&amp;lt;host mac='\({MAC_ADDRESS}' name='\){NAME}' ip='${IP<sub>ADDRESS</sub>}' /&amp;gt;" &#x2013;live &#x2013;config &#x2013;parent-index 0
</p>

</div>

<div class="notice" id="org8e0349a">
<p>
You can edit the file manually to do more cleanup. After editing, you
must stop (destroy) and restart the network.
</p>

<div class="run" id="orgb123ad4">
<p>
sudo virsh net-edit default
sudo virsh net-destroy default
sudo virsh net-start default
</p>

</div>

</div>
</div>
</div>
<div id="outline-container-org6eb6dcf" class="outline-4">
<h4 id="org6eb6dcf"><span class="section-number-4">7.4.6.</span> Create env file to store main config settings</h4>
<div class="outline-text-4" id="text-7-4-6">
<div class="run" id="orgdc7bd7b">
<p>
TMP<sub>ENV</sub>=$(mktemp)
cat &lt;&lt; EOF &gt; \({TMP_ENV}
export NAME=\){NAME}
export OS<sub>VARIANT</sub>=\({OS_VARIANT}
export IP_ADDRESS=\){IP<sub>ADDRESS</sub>}
export MAC<sub>ADDRESS</sub>=\({MAC_ADDRESS}
export CLOUD_IMAGE=\){CLOUD<sub>IMAGE</sub>}
export MEMORY=\({MEMORY}
export CPUS=\){CPUS}
export DISK<sub>SIZE</sub>=\({DISK_SIZE}
export USER_DATA=~/libvirt/cloud-init/\){NAME}.yaml
EOF
chmod a+r ${TMP<sub>ENV</sub>}
sudo su ${VM<sub>ADMIN</sub>:-libvirt-admin} -c \
    "mkdir -p ~/libvirt &amp;&amp; cp \({TMP_ENV} ~/libvirt/\){NAME}.env"
</p>

</div>

<div class="notice" id="org7c03dd3">
<p>
This will create a new config file <b>in the libvirt-admin user's home directory</b>
<code>~/libvirt/${NAME}.env</code>.
</p>

</div>
</div>
</div>
</div>
<div id="outline-container-orge0d3e15" class="outline-3">
<h3 id="orge0d3e15"><span class="section-number-3">7.5.</span> Create VM</h3>
<div class="outline-text-3" id="text-7-5">
<div class="notice" id="org1784fd1">
<p>
<b>For this entire section you need to perform the VM config as the <code>libvirt-admin</code> user.</b>
</p>

<p>
Login to the shell account of  <code>libvirt-admin</code>:
</p>

<div class="run" id="org3db2840">
<p>
sudo su libvirt-admin -l
</p>

</div>

</div>
</div>
<div id="outline-container-org9464ca5" class="outline-4">
<h4 id="org9464ca5"><span class="section-number-4">7.5.1.</span> Source the config</h4>
<div class="outline-text-4" id="text-7-5-1">
<p>
Now, and anytime you come back later to work on the same VM, source the config file:
</p>

<div class="run" id="orgca5f04b">
<p>
NAME=debian-dev
source ~/libvirt/${NAME}.env
</p>

</div>
</div>
</div>
<div id="outline-container-org6b83677" class="outline-4">
<h4 id="org6b83677"><span class="section-number-4">7.5.2.</span> Create directories to hold the VM disks and config files:</h4>
<div class="outline-text-4" id="text-7-5-2">
<div class="run" id="org4a18f7d">
<p>
mkdir -p ~/libvirt/{cloud-images,disks,cloud-init}
</p>

</div>
</div>
</div>
<div id="outline-container-org383873e" class="outline-4">
<h4 id="org383873e"><span class="section-number-4">7.5.3.</span> Create the cloud-init config file:</h4>
<div class="outline-text-4" id="text-7-5-3">
<div class="run" id="orgba07620">
<p>
cat &lt;&lt; EOF | sed 's/\xe2\x80\x8b//g' &gt; ${USER<sub>DATA</sub>}
#cloud-config
hostname: ${NAME}
users:
​  - name: root
    ssh<sub>authorized</sub><sub>keys</sub>:
​      - $(cat ~/libvirt/user-ssh.pub)
EOF
</p>

</div>
</div>
</div>
<div id="outline-container-org45dd340" class="outline-4">
<h4 id="org45dd340"><span class="section-number-4">7.5.4.</span> Download the cloud image:</h4>
<div class="outline-text-4" id="text-7-5-4">
<div class="notice" id="org06641f6">
<p>
You only need to download each CLOUD<sub>IMAGE</sub> once, they will be cached
in <code>~/libvirt/cloud-images</code>, so they can be be reused.
</p>

</div>

<div class="run" id="orgca8ad26">
<p>
(cd ~/libvirt/cloud-images; curl -LO \({CLOUD_IMAGE})
chmod a-w ~/libvirt/cloud-images/\)(echo \({CLOUD_IMAGE} | grep -Po ".*/\K.*\)")
</p>

</div>
</div>
</div>
<div id="outline-container-org1d19ae1" class="outline-4">
<h4 id="org1d19ae1"><span class="section-number-4">7.5.5.</span> Clean up old VMs with the same name:</h4>
<div class="outline-text-4" id="text-7-5-5">
<div class="notice" id="org33531f8">
<p>
If you already have a VM with the same name, and you want to start
again from scratch, you need to clean up from the previous install
first:
</p>
<div class="run" id="orgb17a2cf">
<p>
## To cleanup and REMOVE an old VM named debian-dev:
virsh destroy debian-dev
virsh managedsave-remove debian-dev
virsh undefine debian-dev
</p>

</div>

</div>
</div>
</div>
<div id="outline-container-org1ef988e" class="outline-4">
<h4 id="org1ef988e"><span class="section-number-4">7.5.6.</span> Create the disk image for the new VM:</h4>
<div class="outline-text-4" id="text-7-5-6">
<div class="notice" id="org6d1c828">
<p>
This is destructive of the existing disk file!
</p>

</div>


<div class="run" id="org2113a78">
<p>
(set -e
cp ~/libvirt/cloud-images/$(echo \({CLOUD_IMAGE} | grep -Po ".*/\K.*") \
   ~/libvirt/disks/\){NAME}.qcow2
chmod u+w ~/libvirt/disks/\({NAME}.qcow2
qemu-img resize ~/libvirt/disks/\){NAME}.qcow2 +\({DISK_SIZE}G
echo Created ~/libvirt/disks/\){NAME}.qcow2
)
</p>

</div>
</div>
</div>
<div id="outline-container-org41926c9" class="outline-4">
<h4 id="org41926c9"><span class="section-number-4">7.5.7.</span> Create the VM:</h4>
<div class="outline-text-4" id="text-7-5-7">
<div class="run" id="org814ac38">
<p>
virt-install \
  &#x2013;name ${NAME} \
  &#x2013;os-variant ${OS<sub>VARIANT</sub>} \
  &#x2013;virt-type kvm \
  &#x2013;graphics none \
  &#x2013;console pty,target<sub>type</sub>=serial \
  &#x2013;cpu host \
  &#x2013;vcpus ${CPUS} \
  &#x2013;memory \({MEMORY} \
  --network bridge=virbr0,model=virtio,mac=\){MAC<sub>ADDRESS</sub>} \
  &#x2013;cloud-init user-data=\({USER_DATA} \
  --import \
  --disk ~/libvirt/disks/\){NAME}.qcow2
</p>

</div>
</div>
</div>
<div id="outline-container-org88331af" class="outline-4">
<h4 id="org88331af"><span class="section-number-4">7.5.8.</span> Watch the console for any errors</h4>
<div class="outline-text-4" id="text-7-5-8">
<p>
As the VM starts up, your terminal will attach to the console output
of the VM. This is to monitor any errors that may occur during the
bootup, especially relating to cloud-init.
</p>

<p>
Wait until you see this Login message:
</p>

<div class="stdout" id="orge94d6cb">
<p>
debian-dev login: 
</p>

</div>
</div>
</div>
<div id="outline-container-org31a842f" class="outline-4">
<h4 id="org31a842f"><span class="section-number-4">7.5.9.</span> Disconnect from the VM console</h4>
<div class="outline-text-4" id="text-7-5-9">
<p>
To disconnect from the VM console, press the keyboard combination
<code>Ctrl+]</code> (meaning to hold the Control key and the right square bracket
key at the same time.)
</p>
</div>
</div>
<div id="outline-container-org9358864" class="outline-4">
<h4 id="org9358864"><span class="section-number-4">7.5.10.</span> Shutdown the VM</h4>
<div class="outline-text-4" id="text-7-5-10">
<div class="notice" id="org5806a5a">
<p>
It is important to shut down the VM the first time after install,
otherwise you will get an error about the unejected cloud-init ISO.
</p>

</div>

<div class="run" id="orgd44f3b4">
<p>
## Destroy just means to stop:
virsh destroy ${NAME}
</p>

</div>
</div>
</div>
<div id="outline-container-orgf140be6" class="outline-4">
<h4 id="orgf140be6"><span class="section-number-4">7.5.11.</span> Restart VM</h4>
<div class="outline-text-4" id="text-7-5-11">
<div class="run" id="orgda45cc8">
<p>
virsh start ${NAME}
</p>

</div>
</div>
</div>
<div id="outline-container-orgdc6c4bf" class="outline-4">
<h4 id="orgdc6c4bf"><span class="section-number-4">7.5.12.</span> Enable auto start on boot</h4>
<div class="outline-text-4" id="text-7-5-12">
<div class="run" id="orgcb986d3">
<p>
virsh autostart ${NAME}
</p>

</div>
</div>
</div>
</div>
<div id="outline-container-org51d9c60" class="outline-3">
<h3 id="org51d9c60"><span class="section-number-3">7.6.</span> Setup workstation SSH config</h3>
<div class="outline-text-3" id="text-7-6">
<div class="notice" id="orgd4f3957">
<p>
<b>For this section, you are back to using your normal workstation user.</b>
</p>

</div>

<p>
Append a new host config into your SSH config (<code>~/.ssh/config</code>):
</p>

<div class="edit" id="org65ea556">
<p>
Host debian-dev
    Hostname 192.168.122.2
    User root
    ControlMaster auto
    ControlPersist yes
    ControlPath /tmp/ssh-%u-%r@%h:%p
</p>

</div>

<div class="notice" id="orgb61a693">
<p>
<b>Make sure <code>Host</code> and <code>Hostname</code> are set correctly for your VM.</b>
</p>

</div>

<p>
With this config, you can now use SSH to control the VM:
</p>

<div class="run" id="org1c97a15">
<p>
ssh debian-dev whoami
</p>

</div>

<div class="stdout" id="orgb7169ef">
<p>
root
</p>

</div>
</div>
<div id="outline-container-orgbdfb322" class="outline-4">
<h4 id="orgbdfb322"><span class="section-number-4">7.6.1.</span> Install Docker or something else</h4>
<div class="outline-text-4" id="text-7-6-1">
<p>
It is recommended to install Docker on your Debian VM. Please read the
other book on <a href="file:///d.rymcg.tech/">Self-hosting Docker</a>, and the chapter on <a href="file:///d.rymcg.tech/workstation/install-docker-on-remote-host/">installing Docker</a>.
</p>
</div>
</div>
<div id="outline-container-orgafa92d3" class="outline-4">
<h4 id="orgafa92d3"><span class="section-number-4">7.6.2.</span> Reboot your workstation</h4>
<div class="outline-text-4" id="text-7-6-2">
<p>
Now would be a good time to reboot your workstation to test that the
VM is automatically restarted on boot, SSH works, and that the IP
address stays the same due to the static DHCP lease.
</p>
</div>
</div>
<div id="outline-container-org6565ad9" class="outline-4">
<h4 id="org6565ad9"><span class="section-number-4">7.6.3.</span> OK what if autostart didn't work?</h4>
<div class="outline-text-4" id="text-7-6-3">
<p>
You may encounter some issues with it not starting automatically on
boot, I haven't fully figured the problem out.
</p>
</div>
<ol class="org-ol">
<li><a id="org4245443"></a>Remove save state<br />
<div class="outline-text-5" id="text-7-6-3-1">
<div class="run" id="orge777cb6">
<p>
sudo su libvirt-admin -c "virsh managedsave-remove debian-dev"
</p>

</div>
</div>
</li>
<li><a id="orgca33a66"></a>Start the VM manually<br />
<div class="outline-text-5" id="text-7-6-3-2">
<div class="run" id="org3288d98">
<p>
sudo su libvirt-admin -c "virsh start debian-dev"
</p>

</div>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-orgede1914" class="outline-3">
<h3 id="orgede1914"><span class="section-number-3">7.7.</span> VM management commands</h3>
<div class="outline-text-3" id="text-7-7">
<div class="notice" id="org4b9e46d">
<p>
The rest of these commands (greyed out) are <b>examples</b> only, you don't need to run them now.
</p>

</div>
</div>
<div id="outline-container-org654babb" class="outline-4">
<h4 id="org654babb"><span class="section-number-4">7.7.1.</span> List all defined VMs</h4>
<div class="outline-text-4" id="text-7-7-1">
<div class="run" id="orgef1fc4f">
<p>
virsh list &#x2013;all
</p>

</div>

<div class="stdout" id="org171c4b4">
<p>
​ Id   Name         State
​----------------------&#x2013;&#x2014;
​ 5    debian-dev   running
</p>

</div>
</div>
</div>
<div id="outline-container-orgb47ea09" class="outline-4">
<h4 id="orgb47ea09"><span class="section-number-4">7.7.2.</span> Start VM (named debian-dev)</h4>
<div class="outline-text-4" id="text-7-7-2">
<div class="run" id="org380026f">
<p>
virsh start debian-dev
</p>

</div>
</div>
</div>
<div id="outline-container-orgefe651a" class="outline-4">
<h4 id="orgefe651a"><span class="section-number-4">7.7.3.</span> Stop VM (named debian-dev)</h4>
<div class="outline-text-4" id="text-7-7-3">
<div class="run" id="org49b4a3a">
<p>
​# destroy actually just means stop, not delete
virsh destroy debian-dev
</p>

</div>
</div>
</div>
<div id="outline-container-orgf3f1809" class="outline-4">
<h4 id="orgf3f1809"><span class="section-number-4">7.7.4.</span> Show network interface (MAC address)</h4>
<div class="outline-text-4" id="text-7-7-4">
<div class="run" id="org8a74d7a">
<p>
virsh domiflist debian-dev
</p>

</div>
</div>
</div>
<div id="outline-container-org880903b" class="outline-4">
<h4 id="org880903b"><span class="section-number-4">7.7.5.</span> Undefine VM (named debian-dev)</h4>
<div class="outline-text-4" id="text-7-7-5">
<div class="run" id="orge9f2acf">
<p>
​# undefine removes the VM configuration
virsh undefine debian-dev
</p>

</div>
</div>
</div>
<div id="outline-container-org824d12c" class="outline-4">
<h4 id="org824d12c"><span class="section-number-4">7.7.6.</span> Serial console of VM (named debian-dev)</h4>
<div class="outline-text-4" id="text-7-7-6">
<div class="run" id="orga070966">
<p>
virsh console debian-dev
</p>

</div>

<p>
To exit the console, press <code>Ctrl-]</code>. (Control + right square bracket).
</p>
</div>
</div>
</div>
<div id="outline-container-orgdfaa199" class="outline-3">
<h3 id="orgdfaa199"><span class="section-number-3">7.8.</span> Public routes to VMs</h3>
<div class="outline-text-3" id="text-7-8">
<p>
By default, all incoming traffic to the VMs must originate from your
workstation (or another VM on your workstation) - no traffic is routed
to your VMs from any other interface.
</p>

<p>
If you want to break this rule, and allow public routes into these VMs
(DNAT port forwarding), you will need to install the libvirt hook that
sets up the iptables forwarding rules:
</p>
</div>
<div id="outline-container-org6b3bb8a" class="outline-4">
<h4 id="org6b3bb8a"><span class="section-number-4">7.8.1.</span> Download the port-forwarding hook</h4>
<div class="outline-text-4" id="text-7-8-1">
<div class="run" id="orga3a6af9">
<p>
sudo mkdir -p <i>usr/local/src</i>
sudo su -c "cd /usr/local/src &amp;&amp; git clone <a href="https://github.com/EnigmaCurry/libvirt-hook-qemu.git">https://github.com/EnigmaCurry/libvirt-hook-qemu.git</a>"
</p>

</div>
</div>
</div>
<div id="outline-container-orgf3638bf" class="outline-4">
<h4 id="orgf3638bf"><span class="section-number-4">7.8.2.</span> Install the port-forwarding hook</h4>
<div class="outline-text-4" id="text-7-8-2">
<div class="run" id="orgf744245">
<p>
sudo make -C <i>usr/local/src/libvirt-hook-qemu</i> install
</p>

</div>
</div>
</div>
<div id="outline-container-org36a4901" class="outline-4">
<h4 id="org36a4901"><span class="section-number-4">7.8.3.</span> Customize the port-forwarding hook</h4>
<div class="outline-text-4" id="text-7-8-3">
<p>
Use the <a href="https://github.com/EnigmaCurry/libvirt-hook-qemu/blob/master/hooks.json">example</a> and <a href="https://github.com/EnigmaCurry/libvirt-hook-qemu/blob/master/hooks.schema.json">schema</a> as a reference, then edit
<code>/etc/libvirt/hooks/hooks.json</code> to setup the exact port mapping you
want.
</p>

<div class="run" id="org3ee603a">
<p>
cat &lt;&lt; EOF | jq &gt; /etc/libvirt/hooks/hooks.json
{
  "debian-dev": {
    "interface": "virbr0",
    "private<sub>ip</sub>": "192.168.122.2",
    "port<sub>map</sub>": {
        "tcp": [
            [2222, 22],
            [80, 80],
            [443, 443]
        ]
    }
  }
}
EOF
</p>

</div>
</div>
</div>
<div id="outline-container-orge370489" class="outline-4">
<h4 id="orge370489"><span class="section-number-4">7.8.4.</span> Shutdown your VM</h4>
<div class="outline-text-4" id="text-7-8-4">
<div class="run" id="org9eb6233">
<p>
NAME=debian-dev
sudo su libvirt-admin -c "virsh destroy ${NAME}"
</p>

</div>
</div>
</div>
<div id="outline-container-org6c4d99d" class="outline-4">
<h4 id="org6c4d99d"><span class="section-number-4">7.8.5.</span> Restart libvirtd</h4>
<div class="outline-text-4" id="text-7-8-5">
<div class="run" id="orgeaad853">
<p>
sudo systemctl restart libvirtd
</p>

</div>
</div>
</div>
<div id="outline-container-org1a8dc9c" class="outline-4">
<h4 id="org1a8dc9c"><span class="section-number-4">7.8.6.</span> Restart your VM</h4>
<div class="outline-text-4" id="text-7-8-6">
<div class="run" id="org1a93f78">
<p>
NAME=debian-dev
sudo su libvirt-admin -c "virsh start ${NAME}"
</p>

</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: ryan</p>
<p class="date">Created: 2024-06-02 Sun 19:57</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
